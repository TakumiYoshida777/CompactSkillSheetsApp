# データマイグレーション設計書 - エンジニアスキルシート管理システム

## 1. マイグレーション戦略概要

### 1.1 マイグレーション方針

```
マイグレーション戦略:
┌─ 既存システム ─┐    ┌─ 移行処理 ─┐    ┌─ 新システム ─┐
│  - Excel管理    │───▶│ データ抽出   │───▶│ SkillSheetDB │
│  - CSV管理      │    │ 変換・検証   │    │ 統合管理     │
│  - 個別DB      │    │ 重複排除     │    │ API連携      │
│  - 手作業管理   │    │ 品質確保     │    │ Web UI       │
└───────────────┘    └─────────────┘    └─────────────┘

移行原則:
1. ゼロダウンタイム移行
2. データ整合性保証
3. 段階的移行実施
4. 完全なロールバック対応
5. 移行状況の可視化
```

### 1.2 移行対象データ

| データ種別 | 移行元 | 移行先 | 優先度 | 備考 |
|------------|--------|--------|--------|------|
| 企業情報 | Excel/CSV | companies テーブル | High | マスターデータ |
| エンジニア基本情報 | Excel/CSV | engineers テーブル | High | 個人情報含む |
| スキルシート | Excel/Word | skill_sheets テーブル | High | 非構造化データ |
| プロジェクト履歴 | Excel/CSV | project_experiences テーブル | Medium | 任意項目あり |
| アプローチ履歴 | メール/Excel | approaches テーブル | Medium | 散在データ |
| ユーザーアカウント | CSV/手動 | users テーブル | High | 認証情報 |
| 添付ファイル | ローカル/共有 | MinIO Storage | Medium | ファイル移行 |

## 2. データ分析・設計

### 2.1 既存データ分析

#### 企業データ分析スクリプト
```python
#!/usr/bin/env python3
# scripts/analyze_existing_data.py

import pandas as pd
import numpy as np
import json
import re
from pathlib import Path
from typing import Dict, List, Any

class DataAnalyzer:
    def __init__(self, data_path: str):
        self.data_path = Path(data_path)
        self.analysis_result = {}
    
    def analyze_company_data(self, file_path: str) -> Dict[str, Any]:
        """企業データの分析"""
        print(f"📊 企業データ分析開始: {file_path}")
        
        # Excel/CSVファイル読み込み
        if file_path.endswith('.xlsx'):
            df = pd.read_excel(file_path)
        else:
            df = pd.read_csv(file_path, encoding='utf-8-sig')
        
        analysis = {
            'total_records': len(df),
            'columns': list(df.columns),
            'data_types': df.dtypes.to_dict(),
            'missing_values': df.isnull().sum().to_dict(),
            'duplicate_records': df.duplicated().sum(),
            'unique_companies': df['company_name'].nunique() if 'company_name' in df.columns else 0
        }
        
        # 企業名の正規化分析
        if 'company_name' in df.columns:
            company_names = df['company_name'].dropna().unique()
            analysis['company_variations'] = self._analyze_company_name_variations(company_names)
        
        # メールドメイン分析
        if 'email' in df.columns:
            domains = df['email'].dropna().str.extract(r'@(.+)')[0].value_counts()
            analysis['email_domains'] = domains.head(10).to_dict()
        
        print(f"✅ 企業データ分析完了 - 件数: {analysis['total_records']}")
        return analysis
    
    def analyze_engineer_data(self, file_path: str) -> Dict[str, Any]:
        """エンジニアデータの分析"""
        print(f"📊 エンジニアデータ分析開始: {file_path}")
        
        if file_path.endswith('.xlsx'):
            df = pd.read_excel(file_path)
        else:
            df = pd.read_csv(file_path, encoding='utf-8-sig')
        
        analysis = {
            'total_records': len(df),
            'columns': list(df.columns),
            'missing_values': df.isnull().sum().to_dict(),
            'duplicate_emails': df['email'].duplicated().sum() if 'email' in df.columns else 0,
            'skill_variations': self._analyze_skill_variations(df) if any('skill' in col.lower() for col in df.columns) else {}
        }
        
        # 年齢・経験年数分析
        for col in ['age', 'experience_years', '年齢', '経験年数']:
            if col in df.columns:
                analysis[f'{col}_stats'] = {
                    'mean': df[col].mean(),
                    'median': df[col].median(),
                    'min': df[col].min(),
                    'max': df[col].max(),
                    'std': df[col].std()
                }
        
        print(f"✅ エンジニアデータ分析完了 - 件数: {analysis['total_records']}")
        return analysis
    
    def analyze_skillsheet_data(self, directory_path: str) -> Dict[str, Any]:
        """スキルシートデータの分析"""
        print(f"📊 スキルシートデータ分析開始: {directory_path}")
        
        skillsheet_dir = Path(directory_path)
        files = list(skillsheet_dir.glob('**/*'))
        
        analysis = {
            'total_files': len(files),
            'file_types': {},
            'file_sizes': [],
            'skill_keywords': {}
        }
        
        # ファイル種別分析
        for file in files:
            if file.is_file():
                ext = file.suffix.lower()
                analysis['file_types'][ext] = analysis['file_types'].get(ext, 0) + 1
                analysis['file_sizes'].append(file.stat().st_size)
        
        # Excel/Wordファイルからスキル情報抽出
        skill_keywords = self._extract_skill_keywords(files)
        analysis['skill_keywords'] = skill_keywords
        
        print(f"✅ スキルシートデータ分析完了 - ファイル数: {analysis['total_files']}")
        return analysis
    
    