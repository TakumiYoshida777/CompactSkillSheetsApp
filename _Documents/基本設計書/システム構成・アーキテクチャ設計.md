# 基本設計書 - システム構成・アーキテクチャ

## 1. システム全体構成図

### 1.1 論理構成図
```
[インターネット]
      |
[ロードバランサー] ← CDN
      |
[リバースプロキシ (Nginx)]
      |
┌─────────────────┬─────────────────┐
│  顧客システム    │  管理者システム   │
├─────────────────┼─────────────────┤
│[Webサーバー]     │[Webサーバー]     │
│[アプリケーション  │[アプリケーション  │
│ サーバー]       │ サーバー]       │
│                │                │
│[Redis          │[Redis          │
│ (セッション)]   │ (セッション)]   │
└─────────────────┴─────────────────┘
      |                    |
      └─────[データベース]────┘
            (企業ID分離)
              |
      [バックアップストレージ]
```

### 1.2 物理構成図
```
[ユーザー] ← HTTPS → [CloudFlare/CDN]
                          |
                    [ロードバランサー]
                     (AWS ALB/ELB)
                          |
              ┌───────────┬───────────┐
              │ Web1      │ Web2      │
              │(顧客)     │(管理者)   │
              └───────────┴───────────┘
                          |
              ┌───────────┬───────────┐
              │ App1      │ App2      │
              │(顧客)     │(管理者)   │
              └───────────┴───────────┘
                          |
                  [Redis Cluster]
                          |
                  [RDS (PostgreSQL)]
                  - Primary/Standby
                          |
                  [S3/ストレージ]
                  - ファイル保存
                  - バックアップ
```

## 2. アーキテクチャ詳細

### 2.1 アプリケーションアーキテクチャ
```
[フロントエンド層]
├─ React.js / Vue.js (SPA)
├─ Responsive Design (PC/Tablet/Mobile)
├─ Progressive Web App (PWA)
└─ WebSocket (リアルタイム通知)

[API Gateway層]
├─ RESTful API
├─ GraphQL (将来対応)
├─ 認証・認可チェック
├─ レート制限
└─ ログ出力

[アプリケーション層]
├─ Node.js / Python / Java
├─ マイクロサービス構成
├─ ビジネスロジック処理
├─ データ変換・バリデーション
└─ 外部API連携

[データアクセス層]
├─ ORM (Prisma/TypeORM)
├─ コネクションプール
├─ トランザクション管理
└─ クエリ最適化

[データ層]
├─ PostgreSQL (メインDB)
├─ Redis (キャッシュ・セッション)
├─ Elasticsearch (検索エンジン)
└─ S3 (ファイルストレージ)
```

### 2.2 マイクロサービス構成
```
[顧客システム - マイクロサービス]
├─ 認証サービス (Authentication Service)
├─ ユーザー管理サービス (User Management Service)
├─ エンジニア管理サービス (Engineer Management Service)
├─ スキルシート管理サービス (Skill Sheet Service)
├─ プロジェクト管理サービス (Project Management Service)
├─ アプローチ管理サービス (Approach Management Service)
├─ 検索サービス (Search Service)
├─ 通知サービス (Notification Service)
└─ ファイル管理サービス (File Management Service)

[管理者システム - マイクロサービス]
├─ 管理者認証サービス (Admin Authentication Service)
├─ 企業管理サービス (Company Management Service)
├─ 契約管理サービス (Contract Management Service)
├─ 請求管理サービス (Billing Management Service)
├─ 売上管理サービス (Revenue Management Service)
├─ 監視サービス (Monitoring Service)
├─ レポート生成サービス (Report Generation Service)
└─ システム管理サービス (System Management Service)
```

## 3. 技術スタック

### 3.1 フロントエンド
| 項目 | 技術 | 理由 |
|------|------|------|
| フレームワーク | React.js + TypeScript | 大規模開発に適用、型安全性 |
| UI ライブラリ | Ant Design | 高品質なUI コンポーネント |
| 状態管理 | Zustand | 軽量でシンプル、TypeScript親和性 |
| ルーティング | React Router | SPA の標準ルーティング |
| HTTP クライアント | TanStack Query + Axios | 高度なキャッシュ・状態管理 |
| CSS | Tailwind CSS / Styled Components | レスポンシブデザイン対応 |
| ビルドツール | Vite / Webpack | 高速ビルド |
| テスト | Jest + React Testing Library | 単体・統合テスト |

### 3.2 バックエンド
| 項目 | 技術 | 理由 |
|------|------|------|
| プログラミング言語 | Node.js (TypeScript) | フロントエンドと言語統一 |
| フレームワーク | Express.js | 成熟したエコシステム、豊富な情報 |
| API | RESTful API + GraphQL | 柔軟なデータ取得 |
| ORM | Prisma / TypeORM | 型安全なDB操作 |
| 認証・認可 | JWT + Passport.js | セキュアな認証システム |
| バリデーション | Yup | フロント・バック統一、軽量 |
| ログ | Winston / Pino | 構造化ログ出力 |
| テスト | Jest + Supertest | API テスト |

### 3.3 データベース・ストレージ
| 項目 | 技術 | 理由 |
|------|------|------|
| メインDB | PostgreSQL 14+ | 高信頼性、JSON対応 |
| キャッシュ | Redis 6+ | 高速キャッシュ、セッション管理 |
| 検索エンジン | PostgreSQL全文検索 / Meilisearch | 軽量で高速、VPSリソースに優しい |
| ファイルストレージ | ローカルストレージ + さくらのオブジェクトストレージ | コスト効率的、国内CDN付き |
| CDN | CloudFlare（無料プラン） | 静的リソース配信 |

### 3.4 インフラ・運用
| 項目 | 技術 | 理由 |
|------|------|------|
| クラウド | さくらのVPS　| 高可用性、スケーラビリティ |
| コンテナ | Docker + Kubernetes | 運用性、スケーラビリティ |
| CI/CD | GitHub Actions / GitLab CI | 自動デプロイ |
| 監視 | Prometheus + Grafana | メトリクス監視 |
| ログ管理 | ELK Stack (Elasticsearch, Logstash, Kibana) | ログ解析 |
| APM | New Relic / DataDog | アプリケーション監視 |
| セキュリティ | Snyk / SonarQube | 脆弱性スキャン |

## 4. セキュリティアーキテクチャ

### 4.1 セキュリティ層構成
```
[外部攻撃対策]
├─ WAF (Web Application Firewall)
├─ DDoS Protection
├─ Bot Protection
└─ Rate Limiting

[ネットワークセキュリティ]
├─ VPC (Virtual Private Cloud)
├─ サブネット分離
├─ セキュリティグループ
└─ NACL (Network ACL)

[アプリケーションセキュリティ]
├─ HTTPS/TLS 1.3
├─ HSTS (HTTP Strict Transport Security)
├─ CSP (Content Security Policy)
├─ CSRF Protection
├─ XSS Protection
└─ SQL Injection Protection

[データセキュリティ]
├─ 保存時暗号化 (AES-256)
├─ 転送時暗号化 (TLS 1.3)
├─ データベース暗号化
├─ バックアップ暗号化
└─ 暗号化キー管理 (KMS)

[認証・認可]
├─ JWT (JSON Web Token)
├─ OAuth 2.0 / OpenID Connect
├─ Multi-Factor Authentication (MFA)
├─ Role-Based Access Control (RBAC)
└─ Zero Trust Architecture
```

### 4.2 テナント分離アーキテクチャ
```
[データベースレベル分離]
├─ Row Level Security (RLS)
├─ 企業ID (company_id) フィルタ
├─ 暗号化キーの企業別管理
└─ バックアップの企業別分離

[アプリケーションレベル分離]
├─ リクエスト時企業ID検証
├─ セッション企業ID管理
├─ API レスポンス企業ID フィルタ
└─ ファイルアクセス企業ID制御

[運用レベル分離]
├─ 監査ログの企業別分離
├─ メトリクスの企業別集計
├─ アラートの企業別通知
└─ バックアップの企業別復旧
```

## 5. 性能・スケーリング設計

### 5.1 性能最適化戦略
```
[フロントエンド最適化]
├─ Code Splitting
├─ Lazy Loading
├─ Image Optimization
├─ Bundle Size Optimization
├─ Browser Caching
└─ Service Worker (PWA)

[バックエンド最適化]
├─ Database Query Optimization
├─ N+1 Problem対策
├─ Connection Pooling
├─ Async Processing
├─ API Response Caching
└─ Compression (Gzip/Brotli)

[データベース最適化]
├─ Index Optimization
├─ Query Optimization
├─ Partitioning
├─ Read Replica
├─ Connection Pooling
└─ Query Result Caching
```

### 5.2 スケーリング戦略
```
[水平スケーリング]
├─ Load Balancer (ALB/ELB)
├─ Auto Scaling Group
├─ Container Orchestration (Kubernetes)
├─ Database Read Replica
├─ Microservices Architecture
└─ CDN (Content Delivery Network)

[垂直スケーリング]
├─ CPU/Memory Scaling
├─ Database Instance Upgrade
├─ Storage Performance Scaling
└─ Network Bandwidth Scaling

[キャッシュ戦略]
├─ Browser Cache
├─ CDN Cache
├─ Application Cache (Redis)
├─ Database Query Cache
└─ API Response Cache
```

## 6. 可用性・信頼性設計

### 6.1 高可用性アーキテクチャ
```
[Multi-AZ 構成]
├─ Load Balancer (Multi-AZ)
├─ Web Server (Multi-AZ)
├─ Application Server (Multi-AZ)
├─ Database (Primary/Standby)
└─ Cache (Redis Cluster)

[冗長化構成]
├─ Active-Active Load Balancer
├─ Database Master-Slave
├─ Storage Replication
└─ Network Redundancy

[フェイルオーバー]
├─ Automatic Failover (Database)
├─ Health Check & Auto Recovery
├─ Circuit Breaker Pattern
└─ Graceful Degradation
```

### 6.2 災害復旧 (DR) 設計
```
[バックアップ戦略]
├─ Full Backup (Daily)
├─ Incremental Backup (Hourly)
├─ Transaction Log Backup (15min)
├─ Cross-Region Backup
└─ Point-in-Time Recovery

[復旧目標]
├─ RTO (Recovery Time Objective): 4時間
├─ RPO (Recovery Point Objective): 1時間
├─ データ整合性チェック
└─ 復旧テスト (月次)

[災害復旧サイト]
├─ Hot Standby (Primary Region)
├─ Warm Standby (Secondary Region)
├─ Cold Backup (Archive Storage)
└─ Geographic Distribution
```

## 7. 監視・運用設計

### 7.1 監視アーキテクチャ
```
[インフラ監視]
├─ CPU/Memory/Disk Usage
├─ Network Traffic
├─ Database Performance
├─ Cache Hit Rate
└─ Storage Capacity

[アプリケーション監視]
├─ Response Time
├─ Error Rate
├─ Throughput (RPS)
├─ Database Query Performance
└─ API Endpoint Performance

[ビジネス監視]
├─ User Registration
├─ Login Success Rate
├─ Feature Usage
├─ Revenue Metrics
└─ Customer Satisfaction
```

### 7.2 ログ管理アーキテクチャ
```
[ログ収集]
├─ Application Logs
├─ Access Logs
├─ Error Logs
├─ Security Logs
└─ Audit Logs

[ログ処理]
├─ Log Aggregation (Logstash)
├─ Log Parsing & Filtering
├─ Log Enrichment
├─ Log Indexing (Elasticsearch)
└─ Log Visualization (Kibana)

[ログ保持]
├─ Hot Storage (7日)
├─ Warm Storage (30日)
├─ Cold Storage (1年)
├─ Archive Storage (3年)
└─ Legal Hold (無期限)
```

## 8. 開発・運用プロセス

### 8.1 CI/CD パイプライン（GitHub Actions対応版）
```
さくらのVPS + GitHub ActionsでのCI/CDパイプライン実装

[Development]
├─ Feature Branch
├─ Code Review (Pull Request)
├─ Unit Test (GitHub Actions)
├─ Integration Test (GitHub Actions)
└─ Security Scan (GitHub Actions)

[Staging - さくらVPS]
├─ Deploy to Staging VPS
├─ E2E Test (Playwright)
├─ Performance Test
├─ Security Test
└─ UAT (User Acceptance Test)

[Production - さくらVPS]
├─ Blue-Green Deployment
├─ Health Check
├─ Rollback Strategy
└─ Monitoring & Alerting
```

### 8.2 運用自動化
```
[自動化対象]
├─ Infrastructure Provisioning (Terraform)
├─ Application Deployment
├─ Database Migration
├─ Backup & Recovery
├─ Security Patch
├─ Performance Tuning
├─ Capacity Planning
└─ Incident Response
```

## 9. セキュリティ運用

### 9.1 セキュリティ監視
```
[リアルタイム監視]
├─ 不正アクセス検知
├─ 異常ログイン検知
├─ データ漏洩検知
├─ マルウェア検知
└─ DDoS攻撃検知

[定期監査]
├─ 脆弱性スキャン (週次)
├─ ペネトレーションテスト (四半期)
├─ セキュリティ監査 (年次)
├─ コンプライアンスチェック (半年)
└─ 従業員セキュリティ教育 (年次)
```

### 9.2 インシデント対応
```
[インシデント分類]
├─ レベル1: システム停止
├─ レベル2: 性能劣化
├─ レベル3: セキュリティ侵害
├─ レベル4: データ損失
└─ レベル5: 法的問題

[対応フロー]
├─ 検知・通知 (5分以内)
├─ 初動対応 (15分以内)
├─ 原因特定 (1時間以内)
├─ 復旧作業 (4時間以内)
└─ 事後報告・改善 (24時間以内)
```

## 10. コスト最適化

### 10.1 リソース最適化
```
[コンピューティング最適化]
├─ Auto Scaling
├─ Spot Instance活用
├─ Reserved Instance活用
├─ Right Sizing
└─ Container最適化

[ストレージ最適化]
├─ データライフサイクル管理
├─ 圧縮・重複除去
├─ 階層化ストレージ
├─ 不要データ削除
└─ バックアップ最適化

[ネットワーク最適化]
├─ CDN活用
├─ データ転送量削減
├─ 帯域幅最適化
└─ トラフィック分析
```

この基本設計書は、要件定義書で定義された機能要件と非機能要件を満たすための技術的な実装方針を示しています。特に企業間データ分離、セキュリティ、スケーラビリティに重点を置いた設計となっています。