# 権限管理システム開発者ガイド

## 1. 概要

### 1.1 本書の目的
本書は、CompactSkillSheetsAppにおける権限管理システムの設計・実装・運用に関する技術仕様を定義し、開発者が適切に権限制御を実装するための指針を提供することを目的とする。

### 1.2 適用範囲
本仕様は、以下のシステムコンポーネントに適用される：
- バックエンドAPI（Node.js/Express）
- フロントエンドアプリケーション（React）
- データベース（PostgreSQL）
- 認証・認可ミドルウェア

### 1.3 関連文書
- 認証・認可設計書（`_Documents/API設計書/認証・認可設計書.md`）
- API設計書（`_Documents/API設計書/API設計書.md`）
- システム要件定義書（`_Documents/要件定義書/要件定義書.md`）

---

## 2. システム要件

### 2.1 権限管理の必要性
本システムは、マルチテナント型SaaSアプリケーションとして、以下の要件を満たす必要がある：

1. **データの機密性保護**：各企業のデータは、適切な権限を持つユーザーのみがアクセス可能とする
2. **職責に応じたアクセス制御**：ユーザーの役割に応じて、必要最小限の権限を付与する
3. **監査可能性**：誰がいつどのデータにアクセスしたかを追跡可能とする

### 2.2 権限モデル
本システムは、Role-Based Access Control（RBAC）モデルを採用し、以下の構成要素で権限を管理する：

```
権限 = リソース + アクション + スコープ
```

- **リソース**：操作対象となるデータやエンティティ
- **アクション**：リソースに対する操作（閲覧、作成、更新、削除等）
- **スコープ**：アクセス可能な範囲（全体、自社、個人等）

---

## 3. ロール定義

### 3.1 ロール体系
本システムでは、11種類のロールを定義し、階層的な権限管理を実現する。

#### 3.1.1 サービス提供事業者ロール

| ロール識別子 | ロール名称 | 責務 | 権限レベル |
|-------------|-----------|------|-----------|
| `super_admin` | スーパー管理者 | システム全体の管理・保守 | 最高権限 |
| `general_admin` | 一般管理者 | 契約管理・顧客サポート | 管理権限 |
| `operator` | オペレーター | 問い合わせ対応・監視 | 閲覧権限 |

#### 3.1.2 SES企業ロール

| ロール識別子 | ロール名称 | 責務 | 権限レベル |
|-------------|-----------|------|-----------|
| `admin` | 管理者 | 自社の全体管理 | 自社内最高権限 |
| `manager` | マネージャー | プロジェクト・要員管理 | 管理権限 |
| `sales` | 営業 | 顧客対応・提案活動 | 業務権限 |
| `engineer` | エンジニア | 技術業務・スキル管理 | 個人権限 |

#### 3.1.3 取引先企業ロール

| ロール識別子 | ロール名称 | 責務 | 権限レベル |
|-------------|-----------|------|-----------|
| `client_admin` | 取引先管理者 | 契約管理・承認 | 取引先管理権限 |
| `client_sales` | 取引先営業 | 要員選定・交渉 | 取引先業務権限 |
| `client_pm` | 取引先PM | プロジェクト管理 | 取引先閲覧権限 |

#### 3.1.4 その他

| ロール識別子 | ロール名称 | 責務 | 権限レベル |
|-------------|-----------|------|-----------|
| `freelancer` | フリーランス | 個人事業主としての活動 | 個人権限 |

### 3.2 スコープ定義

| スコープ識別子 | 適用範囲 | 説明 |
|---------------|---------|------|
| `all` | システム全体 | すべてのデータに対するアクセス権限 |
| `company` | 企業単位 | 所属企業内のデータに対するアクセス権限 |
| `own` | 個人単位 | 自身に関連するデータに対するアクセス権限 |
| `allowed` | 許可ベース | 明示的に許可されたデータに対するアクセス権限 |
| `assigned` | 割当ベース | 割り当てられた業務に関連するデータへのアクセス権限 |

---

## 4. 権限定義

### 4.1 権限一覧
本システムでは、82種類の権限を定義する。以下、主要な権限を記載する。

#### 4.1.1 ユーザー管理権限（9権限）

| 権限識別子 | 権限名称 | 説明 |
|-----------|---------|------|
| `user:view:all` | 全ユーザー閲覧権限 | システム内の全ユーザー情報を閲覧する権限 |
| `user:view:company` | 自社ユーザー閲覧権限 | 所属企業のユーザー情報を閲覧する権限 |
| `user:view:own` | 個人情報閲覧権限 | 自身のユーザー情報を閲覧する権限 |
| `user:create` | ユーザー作成権限 | 新規ユーザーを作成する権限 |
| `user:update:all` | 全ユーザー更新権限 | システム内の全ユーザー情報を更新する権限 |
| `user:update:company` | 自社ユーザー更新権限 | 所属企業のユーザー情報を更新する権限 |
| `user:update:own` | 個人情報更新権限 | 自身のユーザー情報を更新する権限 |
| `user:delete` | ユーザー削除権限 | ユーザーを削除する権限 |
| `user:manage_role` | ロール管理権限 | ユーザーのロールを管理する権限 |

#### 4.1.2 エンジニア管理権限（8権限）

| 権限識別子 | 権限名称 | 説明 |
|-----------|---------|------|
| `engineer:view:all` | 全エンジニア閲覧権限 | システム内の全エンジニア情報を閲覧する権限 |
| `engineer:view:company` | 自社エンジニア閲覧権限 | 所属企業のエンジニア情報を閲覧する権限 |
| `engineer:view:allowed` | 許可エンジニア閲覧権限 | 許可されたエンジニア情報を閲覧する権限 |
| `engineer:create` | エンジニア登録権限 | エンジニアを新規登録する権限 |
| `engineer:update:all` | 全エンジニア更新権限 | システム内の全エンジニア情報を更新する権限 |
| `engineer:update:company` | 自社エンジニア更新権限 | 所属企業のエンジニア情報を更新する権限 |
| `engineer:delete` | エンジニア削除権限 | エンジニアを削除する権限 |
| `engineer:export` | エンジニア情報出力権限 | エンジニア情報を外部形式で出力する権限 |

※ 以下、スキルシート管理権限（10権限）、プロジェクト管理権限（8権限）、取引先管理権限（7権限）、企業管理権限（7権限）、契約管理権限（5権限）、請求管理権限（5権限）、アプローチ管理権限（6権限）、オファー管理権限（6権限）、レポート管理権限（4権限）、設定管理権限（3権限）、システム管理権限（4権限）を含む、合計82権限が定義されている。

---

## 5. 実装仕様

### 5.1 バックエンド実装

#### 5.1.1 権限チェックミドルウェア

権限チェックは、以下のミドルウェア関数を使用して実装する：

```typescript
// 基本的な権限チェック
requirePermission(resource: string, action: string, scope?: string)

// 複数権限のOR条件チェック
requireAnyPermission(conditions: PermissionCondition[])

// ロールベースチェック
requireRole(roles: string[])

// 所有者または権限チェック
requireOwnerOrPermission(resourceIdParam: string, resource: string, action: string)
```

#### 5.1.2 実装例

```typescript
// APIエンドポイントにおける権限チェックの実装
router.get('/api/v1/engineers',
  authMiddleware,
  requirePermission('engineer', 'view', 'company'),
  engineerController.getAll
);

router.post('/api/v1/engineers',
  authMiddleware,
  requirePermission('engineer', 'create'),
  engineerController.create
);
```

### 5.2 フロントエンド実装

#### 5.2.1 権限チェックフック

フロントエンドでは、以下のカスタムフックを使用して権限を確認する：

```typescript
interface UseAuthReturn {
  user: User | null;
  hasPermission: (permission: string) => boolean;
  hasRole: (role: string) => boolean;
  hasAnyRole: (roles: string[]) => boolean;
}

function useAuth(): UseAuthReturn
```

#### 5.2.2 コンポーネントでの実装

```tsx
const EngineerManagement: React.FC = () => {
  const { hasPermission } = useAuth();

  return (
    <div>
      {hasPermission('engineer:view:company') && (
        <EngineerList />
      )}
      {hasPermission('engineer:create') && (
        <CreateEngineerButton />
      )}
    </div>
  );
};
```

### 5.3 データベース設計

#### 5.3.1 テーブル構造

```sql
-- ロールテーブル
CREATE TABLE roles (
  id BIGSERIAL PRIMARY KEY,
  name VARCHAR(50) UNIQUE NOT NULL,
  display_name VARCHAR(100) NOT NULL,
  description TEXT,
  is_system BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 権限テーブル
CREATE TABLE permissions (
  id BIGSERIAL PRIMARY KEY,
  name VARCHAR(100) UNIQUE NOT NULL,
  display_name VARCHAR(100) NOT NULL,
  resource VARCHAR(50) NOT NULL,
  action VARCHAR(50) NOT NULL,
  scope VARCHAR(50),
  description TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ロール権限マッピングテーブル
CREATE TABLE role_permissions (
  id BIGSERIAL PRIMARY KEY,
  role_id BIGINT REFERENCES roles(id),
  permission_id BIGINT REFERENCES permissions(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(role_id, permission_id)
);
```

---

## 6. セキュリティ考慮事項

### 6.1 最小権限の原則
各ユーザーには、業務遂行に必要な最小限の権限のみを付与する。

### 6.2 権限昇格の防止
権限チェックは、サーバーサイドで必ず実施し、クライアントサイドの権限情報は表示制御のみに使用する。

### 6.3 監査ログ
権限に関する操作（付与、剥奪、変更）は、すべて監査ログに記録する。

---

## 7. 運用手順

### 7.1 初期データ投入

```bash
# 権限マスタデータの投入
node backend/scripts/seed-permissions.js

# デモ環境用管理者の作成
CREATE_DEMO_ADMIN=true node backend/scripts/seed-permissions.js
```

### 7.2 権限の追加・変更

新規権限を追加する場合は、以下の手順に従う：

1. `seed-permissions.js`に権限定義を追加
2. 適切なロールに権限を割り当て
3. マイグレーションスクリプトを実行
4. APIエンドポイントに権限チェックを実装
5. フロントエンドの表示制御を更新

### 7.3 トラブルシューティング

#### 7.3.1 権限確認クエリ

```sql
-- ユーザーの権限一覧を取得
SELECT 
  u.email,
  r.name AS role_name,
  p.name AS permission_name,
  p.resource,
  p.action,
  p.scope
FROM users u
INNER JOIN user_roles ur ON u.id = ur.user_id
INNER JOIN roles r ON ur.role_id = r.id
INNER JOIN role_permissions rp ON r.id = rp.role_id
INNER JOIN permissions p ON rp.permission_id = p.id
WHERE u.email = ?
ORDER BY r.name, p.name;
```

---

## 8. 付録

### 8.1 用語定義

| 用語 | 定義 |
|------|------|
| RBAC | Role-Based Access Control。役割ベースのアクセス制御 |
| リソース | アクセス制御の対象となるデータやエンティティ |
| アクション | リソースに対する操作（CRUD操作等） |
| スコープ | アクセス可能な範囲を定義する識別子 |
| プリンシパル | 認証されたユーザーまたはシステム |

### 8.2 変更履歴

| 版数 | 日付 | 変更内容 | 作成者 |
|------|------|---------|--------|
| 1.0 | 2024-08-24 | 初版作成 | システム開発部 |
| 1.1 | 2024-08-24 | 設計書形式に改訂 | システム開発部 |

### 8.3 参照資料

- OAuth 2.0 Authorization Framework (RFC 6749)
- Role-Based Access Control (NIST RBAC Model)
- OWASP Authorization Cheat Sheet

---

**文書管理番号**: CSKS-DEV-AUTH-001  
**機密区分**: 社内限定  
**配布先**: 開発部門、品質保証部門、運用部門