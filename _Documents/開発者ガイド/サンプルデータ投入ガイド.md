# サンプルデータ投入ガイド

## 概要
本ガイドでは、開発・テスト環境用のサンプルデータをデータベースに投入する手順を説明します。

## 前提条件
- Dockerコンテナが起動していること
- PostgreSQLデータベースが稼働していること
- 基本的なテーブル構造が作成済みであること

## サンプルデータの種類

### 1. マスタデータ
マスタデータは、システムの基礎となる選択肢データです。

#### 投入されるマスタデータ
- **ロールマスタ** (role_masters): 14種類
  - PM、PL、SE、PG、アーキテクト、コンサルタント等
- **業務タスクマスタ** (work_task_masters): 52種類
  - 要件定義、基本設計、詳細設計、開発、テスト、インフラ、管理等
- **スキルマスタ** (skill_masters): 44種類
  - プログラミング言語、フレームワーク、データベース、クラウドサービス等

### 2. サンプル業務データ
実際の業務で使用されるデータのサンプルです。

#### 投入されるサンプルデータ
- **企業データ**: 5社（SES企業）
- **エンジニアデータ**: 10名
- **ロール経験データ**: 23件
- **業務経験データ**: 48件
- **スキルデータ**: 45件

## 投入手順

### 1. エンジニア検索用テーブルの作成

```bash
# エンジニア検索用のテーブルを作成
docker exec -i skillsheet-postgres psql -U skillsheet -d skillsheet_dev < backend/prisma/migrations/20250118_add_engineer_search_tables/migration.sql
```

### 2. マスタデータの投入

```bash
# マスタデータを投入
docker exec -i skillsheet-postgres psql -U skillsheet -d skillsheet_dev < backend/prisma/seed_engineer_search_data.sql
```

### 3. サンプル業務データの投入

```bash
# サンプルエンジニアデータを投入
docker exec -i skillsheet-postgres psql -U skillsheet -d skillsheet_dev < backend/prisma/seed_sample_engineers_final.sql
```

## データ確認方法

### 投入されたデータ件数の確認

```bash
# 各テーブルのデータ件数を確認
docker exec skillsheet-postgres psql -U skillsheet -d skillsheet_dev -c "
SELECT 
    (SELECT COUNT(*) FROM companies) as company_count,
    (SELECT COUNT(*) FROM engineers) as engineer_count,
    (SELECT COUNT(*) FROM role_masters) as role_count,
    (SELECT COUNT(*) FROM work_task_masters) as task_count,
    (SELECT COUNT(*) FROM skill_masters) as skill_count;
"
```

### エンジニアデータの確認

```bash
# エンジニア一覧を確認
docker exec skillsheet-postgres psql -U skillsheet -d skillsheet_dev -c "
SELECT e.id, e.name, c.name as company_name, e.\"currentStatus\"
FROM engineers e
JOIN companies c ON e.\"companyId\" = c.id
ORDER BY e.id;
"
```

### ロール経験データの確認

```bash
# エンジニアのロール経験を確認
docker exec skillsheet-postgres psql -U skillsheet -d skillsheet_dev -c "
SELECT 
    e.name as engineer_name, 
    rm.role_name, 
    ere.years_of_experience,
    ere.proficiency_level
FROM engineer_role_experiences ere
JOIN engineers e ON ere.engineer_id = e.id
JOIN role_masters rm ON ere.role_master_id = rm.id
ORDER BY e.id, rm.display_order
LIMIT 10;
"
```

## データリセット方法

### 全データを削除してリセット

```bash
# エンジニア関連データを削除（外部キー制約の順序に注意）
docker exec skillsheet-postgres psql -U skillsheet -d skillsheet_dev -c "
TRUNCATE TABLE 
    engineer_skills,
    engineer_work_experiences,
    engineer_role_experiences,
    skill_sheets,
    engineers,
    companies
RESTART IDENTITY CASCADE;
"
```

### マスタデータのみリセット

```bash
# マスタデータを削除
docker exec skillsheet-postgres psql -U skillsheet -d skillsheet_dev -c "
TRUNCATE TABLE 
    skill_masters,
    work_task_masters,
    role_masters
RESTART IDENTITY CASCADE;
"
```

## トラブルシューティング

### エラー: "role does not exist"
PostgreSQLの接続ユーザーが正しくない場合に発生します。
```bash
# 正しいユーザー名を確認
docker exec skillsheet-postgres psql -U skillsheet -d skillsheet_dev -c "\du"
```

### エラー: "invalid input value for enum"
enumの値が大文字/小文字で異なる場合に発生します。
```bash
# enumの値を確認
docker exec skillsheet-postgres psql -U skillsheet -d skillsheet_dev -c "SELECT enum_range(NULL::company_type)"
docker exec skillsheet-postgres psql -U skillsheet -d skillsheet_dev -c "SELECT enum_range(NULL::gender)"
```

### エラー: "violates foreign key constraint"
参照先のデータが存在しない場合に発生します。投入順序を確認してください：
1. companies → engineers → skill_sheets
2. role_masters → engineer_role_experiences
3. work_task_masters → engineer_work_experiences
4. skill_masters → engineer_skills

## SQLファイルの場所

すべてのSQLファイルは以下のディレクトリに配置されています：

```
backend/prisma/
├── migrations/
│   └── 20250118_add_engineer_search_tables/
│       └── migration.sql              # テーブル作成SQL
├── seed_engineer_search_data.sql      # マスタデータ投入SQL
└── seed_sample_engineers_final.sql    # サンプルデータ投入SQL
```

## 検索機能のテスト

データ投入後、以下のクエリで検索機能をテストできます：

### PM経験3年以上のエンジニアを検索

```sql
SELECT DISTINCT e.name, e.email
FROM engineers e
INNER JOIN engineer_role_experiences ere ON e.id = ere.engineer_id
INNER JOIN role_masters rm ON ere.role_master_id = rm.id
WHERE rm.role_code = 'PM'
  AND ere.years_of_experience >= 3
  AND e."isPublic" = TRUE
  AND e."currentStatus" IN ('WAITING', 'WAITING_SOON');
```

### React経験ありでPL経験2年以上のエンジニアを検索

```sql
SELECT DISTINCT e.name
FROM engineers e
WHERE e."isPublic" = TRUE
  AND e."currentStatus" IN ('WAITING', 'WAITING_SOON')
  AND EXISTS (
    SELECT 1 FROM engineer_skills es
    INNER JOIN skill_masters sm ON es.skill_master_id = sm.id
    WHERE es.engineer_id = e.id
      AND sm.skill_name = 'React'
  )
  AND EXISTS (
    SELECT 1 FROM engineer_role_experiences ere
    INNER JOIN role_masters rm ON ere.role_master_id = rm.id
    WHERE ere.engineer_id = e.id
      AND rm.role_code = 'PL'
      AND ere.years_of_experience >= 2
  );
```

## 注意事項

1. **本番環境では使用しない**
   - これらのサンプルデータは開発・テスト用です
   - 本番環境では実際のデータを使用してください

2. **個人情報の取り扱い**
   - サンプルデータには架空の情報を使用しています
   - 実際の個人情報は含まれていません

3. **データの一貫性**
   - 外部キー制約があるため、投入順序を守ってください
   - データ削除時も依存関係に注意してください

4. **パフォーマンス**
   - 大量データのテストが必要な場合は、別途スクリプトを作成してください
   - 現在のサンプルは基本的な動作確認用です

## 更新履歴

- 2025-01-18: 初版作成
  - エンジニア検索用テーブルとサンプルデータを追加
  - ロール経験、業務経験、スキル情報の管理機能を実装