# 認証情報ガイド

## 概要
本システムの認証情報とログイン方法についてまとめたドキュメントです。

## 1. データベース登録済みアカウント

### 1.1 SES企業管理者アカウント

| 企業名 | メールアドレス | パスワード | ロール | 備考 |
|--------|---------------|------------|--------|------|
| 株式会社テストSES | admin@test-ses.com | Admin123! | 管理者 | メイン管理者 |
| 株式会社テストSES | admin2@test-ses.com | Admin123! | 管理者 | サブ管理者 |
| 株式会社デジタルイノベーション | admin@digital-innovation.com | Admin123! | 管理者 | 別企業管理者 |

### 1.2 SES企業営業アカウント

| 企業名 | メールアドレス | パスワード | ロール | 備考 |
|--------|---------------|------------|--------|------|
| 株式会社テストSES | sales@test-ses.com | Admin123! | 営業 | 営業担当者 |

### 1.3 取引先企業アカウント

| 企業名 | メールアドレス | パスワード | ロール | 備考 |
|--------|---------------|------------|--------|------|
| 株式会社クライアントA | admin@example-client-a.local | Admin123! | 取引先管理者 | 取引先企業の管理者 |
| 株式会社クライアントB | user@example-client-b.local | Admin123! | 取引先ユーザー | 取引先企業の一般ユーザー |

## 2. モックデータアカウント（開発環境）

バックエンドのauthService.tsで定義されているモックアカウント：

| メールアドレス | パスワード | ロール | 備考 |
|---------------|------------|--------|------|
| admin@demo-ses.co.jp | password123 | 管理者 | デモ管理者（モックデータ） |
| engineer@demo.com | password123 | エンジニア | エンジニア太郎（モックデータ） |
| sales@demo-ses.co.jp | password123 | 営業 | デモ営業（モックデータ） |

### 2.1 エンジニア認証詳細（Issue #8対応）

**エンジニアアカウント情報**:

| 項目 | 値 |
|------|-----|
| メールアドレス | engineer@demo.com |
| パスワード | password123 |
| 名前 | エンジニア太郎 |
| エンジニアID | engineer-1 |
| ロール | エンジニア |
| ログインURL | http://localhost:3000/engineer/login |
| 登録URL | http://localhost:3000/engineer/register |

**エンジニア用APIエンドポイント**:
```bash
# ログイン
curl -X POST http://localhost:8000/api/engineer/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"engineer@demo.com","password":"password123"}'

# 新規登録
curl -X POST http://localhost:8000/api/engineer/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "new-engineer@example.com",
    "password": "Password123!",
    "firstName": "太郎",
    "lastName": "エンジニア",
    "companyId": 1
  }'

# プロフィール取得（要認証）
curl -X GET http://localhost:8000/api/engineer/auth/profile \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"

# スキルシート取得（要認証）
curl -X GET http://localhost:8000/api/engineer/skill-sheets/me \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"

# スキルシート更新（要認証）
curl -X PUT http://localhost:8000/api/engineer/skill-sheets/me \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"technicalSkills": ["React", "TypeScript", "Node.js"]}'
```

## 3. ログイン方法

### 3.1 APIエンドポイント

#### SES企業・エンジニア向けログイン
```
POST /api/auth/login
```

**リクエストボディ:**
```json
{
  "email": "admin@test-ses.com",
  "password": "Admin123!",
  "rememberMe": false
}
```

**レスポンス:**
```json
{
  "success": true,
  "data": {
    "user": { ... },
    "accessToken": "JWT_TOKEN",
    "refreshToken": "REFRESH_TOKEN",
    "expiresIn": 28800
  },
  "message": "ログインに成功しました"
}
```

#### 取引先企業向けログイン
```
POST /api/client/auth/login
```

**リクエストボディ・レスポンス形式は同じ**

### 3.2 フロントエンドUI

1. **SES企業向け**: http://localhost:3000/login
2. **エンジニア向け**: http://localhost:3000/engineer/login
3. **取引先企業向け**: http://localhost:3000/client/login

### 3.3 デモアカウントボタン

ログインページには「管理者でログイン」ボタンがあり、クリックするとデモアカウントの認証情報が自動入力されます。

## 4. 権限とアクセス制御

### 4.1 ロール一覧

| ロール名 | システム内部名 | 説明 |
|----------|---------------|------|
| 管理者 | admin | システム全体の管理権限 |
| 営業 | sales | 営業活動・取引先管理権限 |
| エンジニア | engineer | 自身のスキルシート管理権限 |
| 取引先管理者 | client_admin | 取引先企業の管理権限 |
| 取引先ユーザー | client_user | 取引先企業の一般ユーザー権限 |
| フリーランス | freelancer | フリーランスエンジニア権限 |

### 4.2 主な権限

- **管理者**: 全機能へのアクセス権限
- **営業**: エンジニア情報閲覧、取引先管理、オファー作成
- **エンジニア**: 自身のスキルシート編集・閲覧
- **取引先管理者**: 自社アクセス権限の管理、エンジニア検索
- **取引先ユーザー**: 許可されたエンジニア情報の閲覧

## 5. トークン管理

### 5.1 JWTトークン
- **有効期限**: デフォルト8時間（rememberMe有効時は30日）
- **リフレッシュトークン**: 30日有効
- **保存場所**: localStorage（Zustandで管理）

### 5.2 トークンリフレッシュ
```
POST /api/auth/refresh
```

**リクエストボディ:**
```json
{
  "refreshToken": "REFRESH_TOKEN"
}
```

## 6. トラブルシューティング

### 6.1 ログインできない場合

1. **パスワードの確認**
   - 大文字小文字を正確に入力
   - 特殊文字（!）を含む

2. **メールアドレスの確認**
   - 正確なドメイン名
   - 全て小文字で入力

3. **データベース接続確認**
   ```bash
   docker exec skillsheet-postgres psql -U skillsheet -d skillsheet_dev \
     -c "SELECT email, name FROM users;"
   ```

### 6.2 パスワードリセット

現在のパスワードハッシュ生成方法：
```javascript
// backend/scripts/generate-hash.js
node scripts/generate-hash.js "新しいパスワード"
```

生成されたハッシュをデータベースに更新：
```sql
UPDATE users 
SET "passwordHash" = '生成されたハッシュ値' 
WHERE email = 'ユーザーのメールアドレス';
```

## 7. セキュリティ注意事項

1. **本番環境では必ず変更すること**
   - JWT_SECRET環境変数
   - 全てのデフォルトパスワード
   - bcryptのラウンド数（現在: 10）

2. **定期的なトークンローテーション**
   - リフレッシュトークンの定期更新
   - アクセストークンの短期有効期限

3. **アカウントロック機能**
   - 連続ログイン失敗時の自動ロック
   - 管理者による手動ロック解除

## 8. 開発用クイックスタート

```bash
# 1. Dockerコンテナ起動
docker-compose up -d

# 2. サンプルデータ投入（初回のみ）
cat backend/prisma/seed_auth_users.sql | \
  docker exec -i skillsheet-postgres psql -U skillsheet -d skillsheet_dev

# 3. ログインテスト（モックデータ）
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@demo-ses.co.jp","password":"password123"}'

# 4. フロントエンドアクセス
open http://localhost:3000/login
```

## 9. Issue #8対応内容

### 実装済み機能
1. **エンジニア用認証API**
   - `/api/engineer/auth/login` - ログイン
   - `/api/engineer/auth/register` - 新規登録
   - `/api/engineer/auth/profile` - プロフィール取得
   - `/api/engineer/auth/refresh` - トークン更新

2. **エンジニア用画面**
   - `/engineer/login` - ログイン画面
   - `/engineer/register` - 新規登録画面
   - `/engineer/dashboard` - ダッシュボード
   - `/engineer/skill-sheet` - スキルシート編集
   - `/engineer/skill-sheet/preview` - スキルシートプレビュー

3. **権限管理**
   - エンジニアロールによるアクセス制御
   - 自身のスキルシートのみ編集可能
   - プロフィール管理機能

---

最終更新日: 2025-01-18