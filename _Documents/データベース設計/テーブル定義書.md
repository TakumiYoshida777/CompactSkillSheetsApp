# データベース設計・ER図

## 1. エンティティ一覧

### 1.1 主要エンティティ

#### 顧客側エンティティ
| エンティティ名 | 論理名 | 説明 |
|---------------|--------|------|
| companies | 企業 | SES企業・取引先企業 |
| users | ユーザー | システム利用者 |
| roles | ロール | 権限ロール定義 |
| user_roles | ユーザーロール | ユーザーとロールの関連 |
| permissions | 権限 | 機能別権限定義 |
| role_permissions | ロール権限 | ロールと権限の関連 |
| engineers | エンジニア | エンジニア情報 |
| skill_sheets | スキルシート | エンジニアのスキル情報 |
| projects | プロジェクト | 参画プロジェクト |
| engineer_projects | エンジニアプロジェクト | エンジニアとプロジェクトの関連 |
| freelancers | フリーランス | フリーランス情報 |
| business_partners | 取引先企業 | 取引先企業情報 |
| approaches | アプローチ履歴 | アプローチ・交渉履歴 |
| exclusions | 除外設定 | NG・除外設定 |
| email_templates | メールテンプレート | 定期配信等のテンプレート |
| email_logs | メール送信ログ | メール送信履歴 |
| system_logs | システムログ | 操作・認証ログ |

#### サービス提供側エンティティ
| エンティティ名 | 論理名 | 説明 |
|---------------|--------|------|
| admin_users | 管理者ユーザー | サービス提供側管理者 |
| admin_roles | 管理者ロール | 管理者権限ロール |
| admin_user_roles | 管理者ユーザーロール | 管理者とロールの関連 |
| contracts | 契約情報 | 企業との契約管理 |
| contract_plans | 契約プラン | 料金プラン定義 |
| invoices | 請求書 | 請求情報管理 |
| payments | 入金情報 | 入金実績管理 |
| usage_logs | 利用ログ | 企業の利用状況ログ |
| account_locks | アカウントロック | アカウントロック管理 |
| admin_logs | 管理者ログ | 管理者操作ログ |
| maintenance_schedules | メンテナンス予定 | メンテナンス管理 |
| announcements | お知らせ | システムお知らせ管理 |

## 2. エンティティ詳細設計

### 2.1 companies（企業）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | 企業ID |
| company_type | ENUM('ses', 'client') | NOT NULL | - | 企業種別 |
| name | VARCHAR(255) | NOT NULL | - | 企業名 |
| email_domain | VARCHAR(255) | NULL | - | メールドメイン |
| address | TEXT | NULL | - | 住所 |
| phone | VARCHAR(20) | NULL | - | 電話番号 |
| website_url | VARCHAR(500) | NULL | - | 会社HP URL |
| contact_email | VARCHAR(255) | NULL | - | 連絡先メール |
| max_engineers | INT | DEFAULT 6000 | - | エンジニア上限数 |
| is_active | BOOLEAN | DEFAULT TRUE | - | 有効フラグ |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.2 users（ユーザー）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | ユーザーID |
| company_id | BIGINT | NULL | FK | 企業ID |
| email | VARCHAR(255) | NOT NULL | UK | メールアドレス |
| personal_email | VARCHAR(255) | NULL | - | 個人メールアドレス |
| password_hash | VARCHAR(255) | NOT NULL | - | パスワードハッシュ |
| name | VARCHAR(100) | NOT NULL | - | 氏名 |
| phone | VARCHAR(20) | NULL | - | 電話番号 |
| last_login_at | TIMESTAMP | NULL | - | 最終ログイン日時 |
| failed_login_count | INT | DEFAULT 0 | - | ログイン失敗回数 |
| account_locked_until | TIMESTAMP | NULL | - | アカウントロック解除日時 |
| password_changed_at | TIMESTAMP | NOT NULL | - | パスワード変更日時 |
| is_active | BOOLEAN | DEFAULT TRUE | - | 有効フラグ |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.3 roles（ロール）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | ロールID |
| name | VARCHAR(50) | NOT NULL | UK | ロール名 |
| display_name | VARCHAR(100) | NOT NULL | - | 表示名 |
| description | TEXT | NULL | - | 説明 |
| is_system | BOOLEAN | DEFAULT FALSE | - | システムロールフラグ |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.4 user_roles（ユーザーロール）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | ID |
| user_id | BIGINT | NOT NULL | FK | ユーザーID |
| role_id | BIGINT | NOT NULL | FK | ロールID |
| granted_by | BIGINT | NOT NULL | FK | 権限付与者ID |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |

### 2.5 permissions（権限）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | 権限ID |
| name | VARCHAR(100) | NOT NULL | UK | 権限名 |
| display_name | VARCHAR(100) | NOT NULL | - | 表示名 |
| resource | VARCHAR(50) | NOT NULL | - | リソース名 |
| action | VARCHAR(50) | NOT NULL | - | アクション名 |
| description | TEXT | NULL | - | 説明 |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.6 role_permissions（ロール権限）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | ID |
| role_id | BIGINT | NOT NULL | FK | ロールID |
| permission_id | BIGINT | NOT NULL | FK | 権限ID |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |

### 2.7 engineers（エンジニア）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | エンジニアID |
| user_id | BIGINT | NULL | FK | ユーザーID |
| company_id | BIGINT | NULL | FK | 企業ID |
| employee_number | VARCHAR(50) | NULL | - | 社員番号 |
| name | VARCHAR(100) | NOT NULL | - | 氏名 |
| name_kana | VARCHAR(100) | NULL | - | 氏名（カナ） |
| email | VARCHAR(255) | NOT NULL | - | メールアドレス |
| phone | VARCHAR(20) | NULL | - | 電話番号 |
| birth_date | DATE | NULL | - | 生年月日 |
| gender | ENUM('male', 'female', 'other') | NULL | - | 性別 |
| nearest_station | VARCHAR(100) | NULL | - | 最寄り駅 |
| github_url | VARCHAR(500) | NULL | - | GitHub URL |
| engineer_type | ENUM('employee', 'freelance') | NOT NULL | - | エンジニア種別 |
| current_status | ENUM('working', 'waiting', 'waiting_soon') | DEFAULT 'working' | - | 現在のステータス |
| available_date | DATE | NULL | - | 稼働可能日 |
| is_public | BOOLEAN | DEFAULT TRUE | - | 公開フラグ |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.8 skill_sheets（スキルシート）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | スキルシートID |
| engineer_id | BIGINT | NOT NULL | FK | エンジニアID |
| summary | TEXT | NULL | - | 概要・自己PR |
| total_experience_years | INT | NULL | - | 総経験年数 |
| programming_languages | JSON | NULL | - | プログラミング言語 |
| frameworks | JSON | NULL | - | フレームワーク |
| databases | JSON | NULL | - | データベース |
| cloud_services | JSON | NULL | - | クラウドサービス |
| tools | JSON | NULL | - | 開発ツール |
| certifications | JSON | NULL | - | 資格・認定 |
| possible_roles | JSON | NULL | - | 対応可能ロール |
| possible_phases | JSON | NULL | - | 対応可能フェーズ |
| education_background | JSON | NULL | - | 学歴 |
| career_summary | TEXT | NULL | - | 経歴要約 |
| special_skills | TEXT | NULL | - | 特記事項 |
| is_completed | BOOLEAN | DEFAULT FALSE | - | 入力完了フラグ |
| last_updated_by | BIGINT | NULL | FK | 最終更新者ID |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.9 projects（プロジェクト）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | プロジェクトID |
| name | VARCHAR(255) | NOT NULL | - | プロジェクト名 |
| client_company | VARCHAR(255) | NULL | - | 顧客企業名 |
| start_date | DATE | NOT NULL | - | 開始日 |
| end_date | DATE | NULL | - | 終了日 |
| planned_end_date | DATE | NULL | - | 終了予定日 |
| project_scale | ENUM('small', 'medium', 'large') | NULL | - | プロジェクト規模 |
| industry | VARCHAR(100) | NULL | - | 業界 |
| business_type | VARCHAR(100) | NULL | - | 業務種別 |
| development_methodology | VARCHAR(100) | NULL | - | 開発手法 |
| team_size | INT | NULL | - | チームサイズ |
| description | TEXT | NULL | - | プロジェクト詳細 |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.10 engineer_projects（エンジニアプロジェクト）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | ID |
| engineer_id | BIGINT | NOT NULL | FK | エンジニアID |
| project_id | BIGINT | NOT NULL | FK | プロジェクトID |
| role | VARCHAR(100) | NULL | - | 担当ロール |
| responsibilities | TEXT | NULL | - | 担当業務 |
| phases | JSON | NULL | - | 担当フェーズ |
| technologies | JSON | NULL | - | 使用技術 |
| start_date | DATE | NOT NULL | - | 参画開始日 |
| end_date | DATE | NULL | - | 参画終了日 |
| is_current | BOOLEAN | DEFAULT FALSE | - | 現在参画中フラグ |
| achievements | TEXT | NULL | - | 成果・実績 |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.11 freelancers（フリーランス）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | フリーランスID |
| engineer_id | BIGINT | NOT NULL | FK | エンジニアID |
| business_name | VARCHAR(255) | NULL | - | 屋号 |
| tax_number | VARCHAR(50) | NULL | - | 事業者番号 |
| hourly_rate_min | INT | NULL | - | 最低時給 |
| hourly_rate_max | INT | NULL | - | 最高時給 |
| monthly_rate_min | INT | NULL | - | 最低月額 |
| monthly_rate_max | INT | NULL | - | 最高月額 |
| work_style | ENUM('remote', 'onsite', 'hybrid') | DEFAULT 'hybrid' | - | 働き方 |
| contract_type | ENUM('contract', 'dispatch') | DEFAULT 'contract' | - | 契約形態 |
| is_public | BOOLEAN | DEFAULT FALSE | - | 公開フラグ |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.12 business_partners（取引先企業）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | 取引先ID |
| ses_company_id | BIGINT | NOT NULL | FK | SES企業ID |
| client_company_id | BIGINT | NOT NULL | FK | 取引先企業ID |
| access_url | VARCHAR(500) | NOT NULL | UK | 専用アクセスURL |
| url_token | VARCHAR(255) | NOT NULL | UK | URLトークン |
| is_active | BOOLEAN | DEFAULT TRUE | - | 有効フラグ |
| created_by | BIGINT | NOT NULL | FK | 作成者ID |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.13 offers（オファー管理）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | オファーID |
| offer_number | VARCHAR(100) | NOT NULL | UK | オファー番号 |
| client_company_id | BIGINT | NOT NULL | FK | 取引先企業ID |
| status | ENUM('sent', 'opened', 'pending', 'accepted', 'declined', 'withdrawn') | DEFAULT 'sent' | - | オファーステータス |
| project_name | VARCHAR(255) | NOT NULL | - | 案件名 |
| project_period_start | DATE | NOT NULL | - | 案件期間開始 |
| project_period_end | DATE | NOT NULL | - | 案件期間終了 |
| required_skills | JSON | NULL | - | 必要スキル |
| project_description | TEXT | NOT NULL | - | 案件詳細 |
| location | VARCHAR(255) | NULL | - | 勤務地 |
| rate_min | INT | NULL | - | 最低単価 |
| rate_max | INT | NULL | - | 最高単価 |
| remarks | TEXT | NULL | - | 備考 |
| sent_at | TIMESTAMP | NOT NULL | - | 送信日時 |
| opened_at | TIMESTAMP | NULL | - | 開封日時 |
| responded_at | TIMESTAMP | NULL | - | 返信日時 |
| reminder_sent_at | TIMESTAMP | NULL | - | リマインド送信日時 |
| reminder_count | INT | DEFAULT 0 | - | リマインド回数 |
| created_by | BIGINT | NOT NULL | FK | 作成者ID |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.14 offer_engineers（オファー対象エンジニア）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | ID |
| offer_id | BIGINT | NOT NULL | FK | オファーID |
| engineer_id | BIGINT | NOT NULL | FK | エンジニアID |
| individual_status | ENUM('sent', 'opened', 'pending', 'accepted', 'declined') | DEFAULT 'sent' | - | 個別ステータス |
| responded_at | TIMESTAMP | NULL | - | 個別返信日時 |
| response_note | TEXT | NULL | - | 返信内容 |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.15 approaches（アプローチ履歴）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | アプローチID |
| from_company_id | BIGINT | NOT NULL | FK | 送信元企業ID |
| to_company_id | BIGINT | NULL | FK | 送信先企業ID |
| to_freelancer_id | BIGINT | NULL | FK | 送信先フリーランスID |
| approach_type | ENUM('manual', 'periodic', 'assign_request') | NOT NULL | - | アプローチ種別 |
| contact_methods | JSON | NULL | - | 連絡方法 |
| target_engineers | JSON | NULL | - | 対象エンジニアリスト |
| project_details | TEXT | NULL | - | プロジェクト詳細 |
| message_content | TEXT | NULL | - | メッセージ内容 |
| email_template_id | BIGINT | NULL | FK | メールテンプレートID |
| status | ENUM('sent', 'opened', 'replied', 'rejected') | DEFAULT 'sent' | - | ステータス |
| sent_by | BIGINT | NOT NULL | FK | 送信者ID |
| sent_at | TIMESTAMP | NOT NULL | - | 送信日時 |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.16 exclusions（除外設定）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | 除外ID |
| company_id | BIGINT | NOT NULL | FK | 企業ID |
| target_company_id | BIGINT | NULL | FK | 対象企業ID |
| target_engineer_id | BIGINT | NULL | FK | 対象エンジニアID |
| exclusion_type | ENUM('ng_engineer', 'periodic_exclusion', 'manual_exclusion') | NOT NULL | - | 除外種別 |
| reason | TEXT | NULL | - | 除外理由 |
| excluded_by | BIGINT | NOT NULL | FK | 除外設定者ID |
| is_active | BOOLEAN | DEFAULT TRUE | - | 有効フラグ |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.17 email_templates（メールテンプレート）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | テンプレートID |
| company_id | BIGINT | NOT NULL | FK | 企業ID |
| template_type | ENUM('approach', 'periodic', 'freelance_approach') | NOT NULL | - | テンプレート種別 |
| name | VARCHAR(255) | NOT NULL | - | テンプレート名 |
| subject | VARCHAR(255) | NOT NULL | - | 件名 |
| body | TEXT | NOT NULL | - | 本文 |
| sender_name | VARCHAR(100) | NULL | - | 送信者名 |
| sender_email | VARCHAR(255) | NULL | - | 送信者メール |
| is_default | BOOLEAN | DEFAULT FALSE | - | デフォルトフラグ |
| is_active | BOOLEAN | DEFAULT TRUE | - | 有効フラグ |
| created_by | BIGINT | NOT NULL | FK | 作成者ID |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.18 email_logs（メール送信ログ）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | ログID |
| approach_id | BIGINT | NULL | FK | アプローチID |
| template_id | BIGINT | NULL | FK | テンプレートID |
| from_email | VARCHAR(255) | NOT NULL | - | 送信者メール |
| to_email | VARCHAR(255) | NOT NULL | - | 受信者メール |
| subject | VARCHAR(255) | NOT NULL | - | 件名 |
| body | TEXT | NOT NULL | - | 本文 |
| status | ENUM('queued', 'sent', 'delivered', 'failed', 'bounced') | DEFAULT 'queued' | - | 送信ステータス |
| error_message | TEXT | NULL | - | エラーメッセージ |
| sent_at | TIMESTAMP | NULL | - | 送信日時 |
| delivered_at | TIMESTAMP | NULL | - | 配信日時 |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.19 admin_users（管理者ユーザー）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | 管理者ID |
| username | VARCHAR(100) | NOT NULL | UK | ユーザー名 |
| email | VARCHAR(255) | NOT NULL | UK | メールアドレス |
| password_hash | VARCHAR(255) | NOT NULL | - | パスワードハッシュ |
| name | VARCHAR(100) | NOT NULL | - | 氏名 |
| department | VARCHAR(100) | NULL | - | 部署 |
| phone | VARCHAR(20) | NULL | - | 電話番号 |
| last_login_at | TIMESTAMP | NULL | - | 最終ログイン日時 |
| failed_login_count | INT | DEFAULT 0 | - | ログイン失敗回数 |
| account_locked_until | TIMESTAMP | NULL | - | アカウントロック解除日時 |
| password_changed_at | TIMESTAMP | NOT NULL | - | パスワード変更日時 |
| is_active | BOOLEAN | DEFAULT TRUE | - | 有効フラグ |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.20 admin_roles（管理者ロール）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | ロールID |
| name | VARCHAR(50) | NOT NULL | UK | ロール名 |
| display_name | VARCHAR(100) | NOT NULL | - | 表示名 |
| description | TEXT | NULL | - | 説明 |
| permissions | JSON | NOT NULL | - | 権限リスト |
| is_system | BOOLEAN | DEFAULT FALSE | - | システムロールフラグ |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.21 admin_user_roles（管理者ユーザーロール）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | ID |
| admin_user_id | BIGINT | NOT NULL | FK | 管理者ユーザーID |
| admin_role_id | BIGINT | NOT NULL | FK | 管理者ロールID |
| granted_by | BIGINT | NOT NULL | FK | 権限付与者ID |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |

### 2.22 contracts（契約情報）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | 契約ID |
| company_id | BIGINT | NOT NULL | FK | 企業ID |
| contract_plan_id | BIGINT | NOT NULL | FK | 契約プランID |
| contract_number | VARCHAR(100) | NOT NULL | UK | 契約番号 |
| contract_status | ENUM('active', 'suspended', 'terminated', 'pending') | DEFAULT 'pending' | - | 契約ステータス |
| start_date | DATE | NOT NULL | - | 契約開始日 |
| end_date | DATE | NULL | - | 契約終了日 |
| billing_cycle | ENUM('monthly', 'quarterly', 'yearly') | DEFAULT 'monthly' | - | 請求サイクル |
| billing_amount | INT | NOT NULL | - | 請求金額 |
| max_users | INT | NOT NULL | - | 最大ユーザー数 |
| max_engineers | INT | NOT NULL | - | 最大エンジニア数 |
| contract_options | JSON | NULL | - | 契約オプション |
| sales_representative | VARCHAR(100) | NULL | - | 営業担当者 |
| contract_notes | TEXT | NULL | - | 契約備考 |
| created_by | BIGINT | NOT NULL | FK | 作成者ID |
| updated_by | BIGINT | NULL | FK | 更新者ID |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.23 contract_plans（契約プラン）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | プランID |
| plan_name | VARCHAR(100) | NOT NULL | - | プラン名 |
| plan_code | VARCHAR(50) | NOT NULL | UK | プランコード |
| description | TEXT | NULL | - | プラン説明 |
| base_price | INT | NOT NULL | - | 基本料金 |
| price_per_user | INT | DEFAULT 0 | - | ユーザー単価 |
| price_per_engineer | INT | DEFAULT 0 | - | エンジニア単価 |
| max_users | INT | NULL | - | 最大ユーザー数 |
| max_engineers | INT | NULL | - | 最大エンジニア数 |
| features | JSON | NOT NULL | - | 機能リスト |
| billing_cycles | JSON | NOT NULL | - | 利用可能請求サイクル |
| is_active | BOOLEAN | DEFAULT TRUE | - | 有効フラグ |
| display_order | INT | DEFAULT 0 | - | 表示順 |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.23 invoices（請求書）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | 請求書ID |
| contract_id | BIGINT | NOT NULL | FK | 契約ID |
| invoice_number | VARCHAR(100) | NOT NULL | UK | 請求書番号 |
| billing_period_start | DATE | NOT NULL | - | 請求期間開始日 |
| billing_period_end | DATE | NOT NULL | - | 請求期間終了日 |
| issue_date | DATE | NOT NULL | - | 発行日 |
| due_date | DATE | NOT NULL | - | 支払期限 |
| subtotal | INT | NOT NULL | - | 小計 |
| tax_amount | INT | NOT NULL | - | 税額 |
| total_amount | INT | NOT NULL | - | 合計金額 |
| invoice_status | ENUM('draft', 'issued', 'paid', 'overdue', 'cancelled') | DEFAULT 'draft' | - | 請求ステータス |
| usage_details | JSON | NULL | - | 利用明細 |
| notes | TEXT | NULL | - | 備考 |
| created_by | BIGINT | NOT NULL | FK | 作成者ID |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.24 payments（入金情報）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | 入金ID |
| invoice_id | BIGINT | NOT NULL | FK | 請求書ID |
| payment_date | DATE | NOT NULL | - | 入金日 |
| payment_amount | INT | NOT NULL | - | 入金金額 |
| payment_method | ENUM('bank_transfer', 'credit_card', 'other') | NOT NULL | - | 入金方法 |
| payment_reference | VARCHAR(255) | NULL | - | 入金参照番号 |
| bank_name | VARCHAR(100) | NULL | - | 振込銀行名 |
| notes | TEXT | NULL | - | 備考 |
| created_by | BIGINT | NOT NULL | FK | 登録者ID |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.25 usage_logs（利用ログ）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | ログID |
| company_id | BIGINT | NOT NULL | FK | 企業ID |
| contract_id | BIGINT | NOT NULL | FK | 契約ID |
| date | DATE | NOT NULL | - | 集計日 |
| active_users | INT | DEFAULT 0 | - | アクティブユーザー数 |
| total_engineers | INT | DEFAULT 0 | - | 総エンジニア数 |
| active_engineers | INT | DEFAULT 0 | - | アクティブエンジニア数 |
| approach_count | INT | DEFAULT 0 | - | アプローチ数 |
| email_sent_count | INT | DEFAULT 0 | - | メール送信数 |
| login_count | INT | DEFAULT 0 | - | ログイン数 |
| storage_usage_mb | INT | DEFAULT 0 | - | ストレージ使用量（MB） |
| api_call_count | INT | DEFAULT 0 | - | API呼び出し数 |
| feature_usage | JSON | NULL | - | 機能別利用状況 |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |

### 2.26 account_locks（アカウントロック）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | ロックID |
| user_id | BIGINT | NULL | FK | ユーザーID |
| company_id | BIGINT | NULL | FK | 企業ID |
| lock_type | ENUM('user_lock', 'company_lock', 'security_lock') | NOT NULL | - | ロック種別 |
| lock_reason | ENUM('payment_overdue', 'contract_violation', 'security_incident', 'manual_lock') | NOT NULL | - | ロック理由 |
| lock_status | ENUM('active', 'released', 'expired') | DEFAULT 'active' | - | ロック状態 |
| locked_at | TIMESTAMP | NOT NULL | - | ロック日時 |
| unlock_scheduled_at | TIMESTAMP | NULL | - | 自動解除予定日時 |
| unlocked_at | TIMESTAMP | NULL | - | 解除日時 |
| lock_details | TEXT | NULL | - | ロック詳細 |
| locked_by | BIGINT | NOT NULL | FK | ロック実行者ID |
| unlocked_by | BIGINT | NULL | FK | 解除実行者ID |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.27 admin_logs（管理者ログ）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | ログID |
| admin_user_id | BIGINT | NOT NULL | FK | 管理者ID |
| target_company_id | BIGINT | NULL | FK | 対象企業ID |
| target_user_id | BIGINT | NULL | FK | 対象ユーザーID |
| action_type | ENUM('create', 'read', 'update', 'delete', 'lock', 'unlock') | NOT NULL | - | アクション種別 |
| resource_type | VARCHAR(100) | NOT NULL | - | リソース種別 |
| resource_id | BIGINT | NULL | - | リソースID |
| action_description | TEXT | NOT NULL | - | アクション説明 |
| before_data | JSON | NULL | - | 変更前データ |
| after_data | JSON | NULL | - | 変更後データ |
| ip_address | VARCHAR(45) | NULL | - | IPアドレス |
| user_agent | TEXT | NULL | - | ユーザーエージェント |
| severity | ENUM('info', 'warning', 'error', 'critical') | DEFAULT 'info' | - | 重要度 |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |

### 2.28 maintenance_schedules（メンテナンス予定）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | メンテナンスID |
| title | VARCHAR(255) | NOT NULL | - | メンテナンス名 |
| description | TEXT | NULL | - | 説明 |
| maintenance_type | ENUM('regular', 'emergency', 'feature_update', 'security_patch') | NOT NULL | - | メンテナンス種別 |
| scheduled_start | TIMESTAMP | NOT NULL | - | 開始予定日時 |
| scheduled_end | TIMESTAMP | NOT NULL | - | 終了予定日時 |
| actual_start | TIMESTAMP | NULL | - | 実際の開始日時 |
| actual_end | TIMESTAMP | NULL | - | 実際の終了日時 |
| status | ENUM('scheduled', 'in_progress', 'completed', 'cancelled') | DEFAULT 'scheduled' | - | ステータス |
| affected_services | JSON | NULL | - | 影響対象サービス |
| notification_sent | BOOLEAN | DEFAULT FALSE | - | 通知送信済みフラグ |
| created_by | BIGINT | NOT NULL | FK | 作成者ID |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.29 announcements（お知らせ）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | お知らせID |
| title | VARCHAR(255) | NOT NULL | - | タイトル |
| content | TEXT | NOT NULL | - | 内容 |
| announcement_type | ENUM('info', 'warning', 'maintenance', 'feature', 'important') | DEFAULT 'info' | - | お知らせ種別 |
| target_audience | ENUM('all', 'specific_companies', 'admin_only') | DEFAULT 'all' | - | 対象者 |
| target_companies | JSON | NULL | - | 対象企業リスト |
| priority | ENUM('low', 'normal', 'high', 'urgent') | DEFAULT 'normal' | - | 優先度 |
| publish_start | TIMESTAMP | NOT NULL | - | 公開開始日時 |
| publish_end | TIMESTAMP | NULL | - | 公開終了日時 |
| is_popup | BOOLEAN | DEFAULT FALSE | - | ポップアップ表示フラグ |
| is_email | BOOLEAN | DEFAULT FALSE | - | メール送信フラグ |
| status | ENUM('draft', 'published', 'archived') | DEFAULT 'draft' | - | ステータス |
| created_by | BIGINT | NOT NULL | FK | 作成者ID |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

## 3. リレーション設計

### 3.1 主要リレーション

#### 顧客側リレーション
```
companies 1:N users
companies 1:N engineers
companies 1:N business_partners
companies 1:N email_templates

users N:M roles (through user_roles)
roles N:M permissions (through role_permissions)
users 1:1 engineers (optional)

engineers 1:1 skill_sheets
engineers 1:N engineer_projects
engineers 1:1 freelancers (optional)

projects 1:N engineer_projects

offers N:1 companies (client)
offers 1:N offer_engineers
offer_engineers N:1 engineers

approaches N:1 companies (from)
approaches N:1 companies (to, optional)
approaches N:1 freelancers (to, optional)
approaches N:1 email_templates (optional)

exclusions N:1 companies
exclusions N:1 companies (target, optional)
exclusions N:1 engineers (target, optional)

email_logs N:1 approaches (optional)
email_logs N:1 email_templates (optional)

system_logs N:1 users (optional)
system_logs N:1 companies (optional)
```

#### サービス提供側リレーション
```
admin_users N:M admin_roles (through admin_user_roles)

companies 1:N contracts
contract_plans 1:N contracts

contracts 1:N invoices
invoices 1:N payments

companies 1:N usage_logs
contracts 1:N usage_logs

companies 1:N account_locks (optional)
users 1:N account_locks (optional)

admin_users 1:N admin_logs
companies 1:N admin_logs (target, optional)
users 1:N admin_logs (target, optional)

admin_users 1:N maintenance_schedules
admin_users 1:N announcements
```

## 4. インデックス設計

### 4.1 主要インデックス

#### 顧客側インデックス
```sql
-- 企業テーブル
CREATE INDEX idx_companies_type ON companies(company_type);
CREATE INDEX idx_companies_active ON companies(is_active);

-- ユーザーテーブル
CREATE UNIQUE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_company ON users(company_id);
CREATE INDEX idx_users_active ON users(is_active);

-- エンジニアテーブル
CREATE INDEX idx_engineers_company ON engineers(company_id);
CREATE INDEX idx_engineers_status ON engineers(current_status);
CREATE INDEX idx_engineers_type ON engineers(engineer_type);
CREATE INDEX idx_engineers_public ON engineers(is_public);
CREATE INDEX idx_engineers_available_date ON engineers(available_date);

-- プロジェクトテーブル
CREATE INDEX idx_projects_dates ON projects(start_date, end_date);
CREATE INDEX idx_projects_planned_end ON projects(planned_end_date);

-- エンジニアプロジェクトテーブル
CREATE INDEX idx_engineer_projects_engineer ON engineer_projects(engineer_id);
CREATE INDEX idx_engineer_projects_current ON engineer_projects(is_current);
CREATE INDEX idx_engineer_projects_dates ON engineer_projects(start_date, end_date);

-- オファーテーブル
CREATE INDEX idx_offers_client_company ON offers(client_company_id);
CREATE INDEX idx_offers_status ON offers(status);
CREATE INDEX idx_offers_sent_at ON offers(sent_at);
CREATE UNIQUE INDEX idx_offers_number ON offers(offer_number);

-- オファー対象エンジニアテーブル
CREATE INDEX idx_offer_engineers_offer ON offer_engineers(offer_id);
CREATE INDEX idx_offer_engineers_engineer ON offer_engineers(engineer_id);
CREATE INDEX idx_offer_engineers_status ON offer_engineers(individual_status);

-- アプローチテーブル
CREATE INDEX idx_approaches_from_company ON approaches(from_company_id);
CREATE INDEX idx_approaches_to_company ON approaches(to_company_id);
CREATE INDEX idx_approaches_to_freelancer ON approaches(to_freelancer_id);
CREATE INDEX idx_approaches_sent_at ON approaches(sent_at);
CREATE INDEX idx_approaches_type ON approaches(approach_type);

-- システムログテーブル
CREATE INDEX idx_system_logs_user ON system_logs(user_id);
CREATE INDEX idx_system_logs_company ON system_logs(company_id);
CREATE INDEX idx_system_logs_type ON system_logs(log_type);
CREATE INDEX idx_system_logs_created_at ON system_logs(created_at);
```

#### サービス提供側インデックス
```sql
-- 管理者ユーザーテーブル
CREATE UNIQUE INDEX idx_admin_users_username ON admin_users(username);
CREATE UNIQUE INDEX idx_admin_users_email ON admin_users(email);
CREATE INDEX idx_admin_users_active ON admin_users(is_active);

-- 契約テーブル
CREATE INDEX idx_contracts_company ON contracts(company_id);
CREATE INDEX idx_contracts_plan ON contracts(contract_plan_id);
CREATE INDEX idx_contracts_status ON contracts(contract_status);
CREATE INDEX idx_contracts_dates ON contracts(start_date, end_date);
CREATE UNIQUE INDEX idx_contracts_number ON contracts(contract_number);

-- 請求書テーブル
CREATE INDEX idx_invoices_contract ON invoices(contract_id);
CREATE INDEX idx_invoices_status ON invoices(invoice_status);
CREATE INDEX idx_invoices_dates ON invoices(issue_date, due_date);
CREATE UNIQUE INDEX idx_invoices_number ON invoices(invoice_number);

-- 入金テーブル
CREATE INDEX idx_payments_invoice ON payments(invoice_id);
CREATE INDEX idx_payments_date ON payments(payment_date);
CREATE INDEX idx_payments_method ON payments(payment_method);

-- 利用ログテーブル
CREATE INDEX idx_usage_logs_company_date ON usage_logs(company_id, date);
CREATE INDEX idx_usage_logs_contract ON usage_logs(contract_id);

-- アカウントロックテーブル
CREATE INDEX idx_account_locks_user ON account_locks(user_id);
CREATE INDEX idx_account_locks_company ON account_locks(company_id);
CREATE INDEX idx_account_locks_status ON account_locks(lock_status);
CREATE INDEX idx_account_locks_type ON account_locks(lock_type);

-- 管理者ログテーブル
CREATE INDEX idx_admin_logs_admin_user ON admin_logs(admin_user_id);
CREATE INDEX idx_admin_logs_target_company ON admin_logs(target_company_id);
CREATE INDEX idx_admin_logs_resource ON admin_logs(resource_type, resource_id);
CREATE INDEX idx_admin_logs_created_at ON admin_logs(created_at);

-- メンテナンステーブル
CREATE INDEX idx_maintenance_schedules_dates ON maintenance_schedules(scheduled_start, scheduled_end);
CREATE INDEX idx_maintenance_schedules_status ON maintenance_schedules(status);

-- お知らせテーブル
CREATE INDEX idx_announcements_publish ON announcements(publish_start, publish_end);
CREATE INDEX idx_announcements_status ON announcements(status);
CREATE INDEX idx_announcements_type ON announcements(announcement_type);
```

## 5. データ整合性制約

### 5.1 外部キー制約

#### 顧客側外部キー制約
```sql
-- ユーザー関連
ALTER TABLE users ADD CONSTRAINT fk_users_company FOREIGN KEY (company_id) REFERENCES companies(id);
ALTER TABLE user_roles ADD CONSTRAINT fk_user_roles_user FOREIGN KEY (user_id) REFERENCES users(id);
ALTER TABLE user_roles ADD CONSTRAINT fk_user_roles_role FOREIGN KEY (role_id) REFERENCES roles(id);

-- エンジニア関連
ALTER TABLE engineers ADD CONSTRAINT fk_engineers_user FOREIGN KEY (user_id) REFERENCES users(id);
ALTER TABLE engineers ADD CONSTRAINT fk_engineers_company FOREIGN KEY (company_id) REFERENCES companies(id);
ALTER TABLE skill_sheets ADD CONSTRAINT fk_skill_sheets_engineer FOREIGN KEY (engineer_id) REFERENCES engineers(id);
ALTER TABLE freelancers ADD CONSTRAINT fk_freelancers_engineer FOREIGN KEY (engineer_id) REFERENCES engineers(id);

-- プロジェクト関連
ALTER TABLE engineer_projects ADD CONSTRAINT fk_engineer_projects_engineer FOREIGN KEY (engineer_id) REFERENCES engineers(id);
ALTER TABLE engineer_projects ADD CONSTRAINT fk_engineer_projects_project FOREIGN KEY (project_id) REFERENCES projects(id);

-- 取引先関連
ALTER TABLE business_partners ADD CONSTRAINT fk_business_partners_ses FOREIGN KEY (ses_company_id) REFERENCES companies(id);
ALTER TABLE business_partners ADD CONSTRAINT fk_business_partners_client FOREIGN KEY (client_company_id) REFERENCES companies(id);

-- オファー関連
ALTER TABLE offers ADD CONSTRAINT fk_offers_client_company FOREIGN KEY (client_company_id) REFERENCES companies(id);
ALTER TABLE offers ADD CONSTRAINT fk_offers_created_by FOREIGN KEY (created_by) REFERENCES users(id);
ALTER TABLE offer_engineers ADD CONSTRAINT fk_offer_engineers_offer FOREIGN KEY (offer_id) REFERENCES offers(id);
ALTER TABLE offer_engineers ADD CONSTRAINT fk_offer_engineers_engineer FOREIGN KEY (engineer_id) REFERENCES engineers(id);

-- アプローチ関連
ALTER TABLE approaches ADD CONSTRAINT fk_approaches_from FOREIGN KEY (from_company_id) REFERENCES companies(id);
ALTER TABLE approaches ADD CONSTRAINT fk_approaches_to_company FOREIGN KEY (to_company_id) REFERENCES companies(id);
ALTER TABLE approaches ADD CONSTRAINT fk_approaches_to_freelancer FOREIGN KEY (to_freelancer_id) REFERENCES freelancers(id);
```

#### サービス提供側外部キー制約
```sql
-- 管理者関連
ALTER TABLE admin_user_roles ADD CONSTRAINT fk_admin_user_roles_user FOREIGN KEY (admin_user_id) REFERENCES admin_users(id);
ALTER TABLE admin_user_roles ADD CONSTRAINT fk_admin_user_roles_role FOREIGN KEY (admin_role_id) REFERENCES admin_roles(id);

-- 契約関連
ALTER TABLE contracts ADD CONSTRAINT fk_contracts_company FOREIGN KEY (company_id) REFERENCES companies(id);
ALTER TABLE contracts ADD CONSTRAINT fk_contracts_plan FOREIGN KEY (contract_plan_id) REFERENCES contract_plans(id);
ALTER TABLE contracts ADD CONSTRAINT fk_contracts_created_by FOREIGN KEY (created_by) REFERENCES admin_users(id);

-- 請求・入金関連
ALTER TABLE invoices ADD CONSTRAINT fk_invoices_contract FOREIGN KEY (contract_id) REFERENCES contracts(id);
ALTER TABLE invoices ADD CONSTRAINT fk_invoices_created_by FOREIGN KEY (created_by) REFERENCES admin_users(id);
ALTER TABLE payments ADD CONSTRAINT fk_payments_invoice FOREIGN KEY (invoice_id) REFERENCES invoices(id);
ALTER TABLE payments ADD CONSTRAINT fk_payments_created_by FOREIGN KEY (created_by) REFERENCES admin_users(id);

-- 利用ログ関連
ALTER TABLE usage_logs ADD CONSTRAINT fk_usage_logs_company FOREIGN KEY (company_id) REFERENCES companies(id);
ALTER TABLE usage_logs ADD CONSTRAINT fk_usage_logs_contract FOREIGN KEY (contract_id) REFERENCES contracts(id);

-- アカウントロック関連
ALTER TABLE account_locks ADD CONSTRAINT fk_account_locks_user FOREIGN KEY (user_id) REFERENCES users(id);
ALTER TABLE account_locks ADD CONSTRAINT fk_account_locks_company FOREIGN KEY (company_id) REFERENCES companies(id);
ALTER TABLE account_locks ADD CONSTRAINT fk_account_locks_locked_by FOREIGN KEY (locked_by) REFERENCES admin_users(id);
ALTER TABLE account_locks ADD CONSTRAINT fk_account_locks_unlocked_by FOREIGN KEY (unlocked_by) REFERENCES admin_users(id);

-- 管理者ログ関連
ALTER TABLE admin_logs ADD CONSTRAINT fk_admin_logs_admin_user FOREIGN KEY (admin_user_id) REFERENCES admin_users(id);
ALTER TABLE admin_logs ADD CONSTRAINT fk_admin_logs_target_company FOREIGN KEY (target_company_id) REFERENCES companies(id);
ALTER TABLE admin_logs ADD CONSTRAINT fk_admin_logs_target_user FOREIGN KEY (target_user_id) REFERENCES users(id);

-- メンテナンス・お知らせ関連
ALTER TABLE maintenance_schedules ADD CONSTRAINT fk_maintenance_schedules_created_by FOREIGN KEY (created_by) REFERENCES admin_users(id);
ALTER TABLE announcements ADD CONSTRAINT fk_announcements_created_by FOREIGN KEY (created_by) REFERENCES admin_users(id);
```

## 6. テナント分離設計

### 6.1 マルチテナント対応
- **企業ID（company_id）による分離**：全てのデータは企業IDで分離
- **Row Level Security（RLS）実装**：データベースレベルでの分離保証
- **アプリケーションレベル制御**：全クエリで企業IDフィルタ必須

### 6.2 セキュリティ考慮事項
- **暗号化対象**：パスワード、個人情報、機密データ
- **監査ログ**：全CRUD操作の完全ログ取得
- **アクセス制御**：ロールベースの細かい権限制御

## 8. 運営管理機能設計

### 8.1 契約管理機能
- **契約ライフサイクル管理**：契約作成→有効化→更新→終了の完全管理
- **プラン管理**：柔軟な料金プラン設定と変更対応
- **利用状況監視**：リアルタイムでの利用状況把握と制限管理

### 8.2 売上管理機能
- **自動請求書生成**：契約情報に基づく自動請求書作成
- **入金管理**：入金照合と未収金管理
- **売上分析**：月次・年次売上レポートと成長トレンド分析

### 8.3 顧客サポート機能
- **アカウント管理**：顧客企業のアカウント状態管理
- **利用状況分析**：顧客の利用パターン分析とサポート最適化
- **問題対応履歴**：サポート履歴の完全記録

### 8.4 システム運営機能
- **メンテナンス管理**：計画的メンテナンスの管理と通知
- **お知らせ管理**：システム全体への通知機能
- **監査ログ**：運営側操作の完全ログ取得

## 9. セキュリティ・分離設計

### 9.1 管理者システム分離
- **物理的分離**：顧客システムと管理者システムの完全分離
- **認証システム**：独立した管理者認証システム
- **ネットワーク分離**：VPN等によるセキュアアクセス

### 9.2 データアクセス制御
- **管理者権限階層**：スーパー管理者、一般管理者、オペレーターの階層化
- **監査ログ**：全ての管理者操作の完全ログ取得
- **承認フロー**：重要操作には複数人承認機能