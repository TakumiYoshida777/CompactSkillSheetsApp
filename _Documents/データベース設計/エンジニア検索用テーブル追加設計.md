# エンジニア検索用テーブル追加設計

## 1. 追加テーブル一覧

### 1.1 ロール・業務経験関連テーブル

| テーブル名 | 論理名 | 説明 |
|-----------|--------|------|
| engineer_role_experiences | エンジニアロール経験 | エンジニアのロール経験情報 |
| engineer_work_experiences | エンジニア業務経験 | エンジニアの業務経験情報 |
| role_masters | ロールマスタ | ロール定義マスタ |
| work_task_masters | 業務タスクマスタ | 業務タスク定義マスタ |
| engineer_skills | エンジニアスキル | エンジニアの技術スキル情報 |
| skill_masters | スキルマスタ | スキル定義マスタ |

## 2. テーブル詳細設計

### 2.1 role_masters（ロールマスタ）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | ロールマスタID |
| role_code | VARCHAR(50) | NOT NULL | UK | ロールコード |
| role_name | VARCHAR(100) | NOT NULL | - | ロール名 |
| role_name_en | VARCHAR(100) | NULL | - | ロール名（英語） |
| category | VARCHAR(50) | NULL | - | カテゴリ（管理系、技術系など） |
| description | TEXT | NULL | - | 説明 |
| display_order | INT | DEFAULT 0 | - | 表示順 |
| is_active | BOOLEAN | DEFAULT TRUE | - | 有効フラグ |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

#### 初期データ例
- PM: プロジェクトマネージャー
- PL: プロジェクトリーダー
- SE: システムエンジニア
- PG: プログラマー
- アーキテクト: ITアーキテクト
- コンサルタント: ITコンサルタント
- テストエンジニア: テストエンジニア
- インフラエンジニア: インフラエンジニア
- データベースエンジニア: データベースエンジニア
- セキュリティエンジニア: セキュリティエンジニア
- データサイエンティスト: データサイエンティスト
- AIエンジニア: AIエンジニア
- SRE: サイトリライアビリティエンジニア
- DevOpsエンジニア: DevOpsエンジニア

### 2.2 engineer_role_experiences（エンジニアロール経験）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | ID |
| engineer_id | BIGINT | NOT NULL | FK | エンジニアID |
| role_master_id | BIGINT | NOT NULL | FK | ロールマスタID |
| years_of_experience | DECIMAL(3,1) | NOT NULL | - | 経験年数 |
| last_used_date | DATE | NULL | - | 最後に従事した日付 |
| proficiency_level | ENUM('beginner', 'intermediate', 'advanced', 'expert') | DEFAULT 'intermediate' | - | 習熟度 |
| is_primary | BOOLEAN | DEFAULT FALSE | - | 主要ロールフラグ |
| notes | TEXT | NULL | - | 備考 |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.3 work_task_masters（業務タスクマスタ）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | タスクマスタID |
| task_code | VARCHAR(50) | NOT NULL | UK | タスクコード |
| task_name | VARCHAR(100) | NOT NULL | - | タスク名 |
| task_name_en | VARCHAR(100) | NULL | - | タスク名（英語） |
| category | VARCHAR(50) | NOT NULL | - | カテゴリ |
| phase | VARCHAR(50) | NULL | - | 開発フェーズ |
| description | TEXT | NULL | - | 説明 |
| display_order | INT | DEFAULT 0 | - | 表示順 |
| is_active | BOOLEAN | DEFAULT TRUE | - | 有効フラグ |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

#### カテゴリ別初期データ

**要件・設計系**
- 要件定義
- 基本設計
- 詳細設計
- アーキテクチャ設計
- API設計
- UI/UX設計
- データベース設計
- ネットワーク設計
- セキュリティ設計

**開発系**
- フロントエンド開発
- バックエンド開発
- モバイルアプリ開発
- 実装・コーディング
- AI/機械学習開発
- データ分析
- BI開発
- RPA開発
- IoT開発
- ブロックチェーン開発

**テスト系**
- テスト設計
- テスト実施
- 結合テスト
- 総合テスト
- 受入テスト
- 性能テスト
- セキュリティテスト
- 自動テスト作成

**インフラ・運用系**
- インフラ構築
- クラウド構築
- データベース構築
- ネットワーク構築
- DevOps
- CI/CD構築
- コンテナ化
- マイクロサービス設計
- 運用保守
- 障害対応
- 性能チューニング
- セキュリティ監査

**管理系**
- プロジェクト管理
- チームマネジメント
- 顧客折衝
- 予算管理
- 品質管理
- リスク管理
- スケジュール管理
- 要員管理
- ベンダー管理

**その他**
- ドキュメント作成
- 教育・研修
- 技術調査
- 技術選定

### 2.4 engineer_work_experiences（エンジニア業務経験）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | ID |
| engineer_id | BIGINT | NOT NULL | FK | エンジニアID |
| work_task_master_id | BIGINT | NOT NULL | FK | 業務タスクマスタID |
| proficiency_level | ENUM('basic', 'intermediate', 'advanced', 'expert') | DEFAULT 'intermediate' | - | 習熟度 |
| years_of_experience | DECIMAL(3,1) | NULL | - | 経験年数 |
| last_used_date | DATE | NULL | - | 最後に従事した日付 |
| project_count | INT | DEFAULT 0 | - | 経験プロジェクト数 |
| notes | TEXT | NULL | - | 備考 |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.5 skill_masters（スキルマスタ）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | スキルマスタID |
| skill_code | VARCHAR(50) | NOT NULL | UK | スキルコード |
| skill_name | VARCHAR(100) | NOT NULL | - | スキル名 |
| skill_type | ENUM('language', 'framework', 'database', 'cloud', 'tool', 'os', 'middleware', 'other') | NOT NULL | - | スキル種別 |
| category | VARCHAR(50) | NULL | - | カテゴリ |
| version | VARCHAR(50) | NULL | - | バージョン |
| description | TEXT | NULL | - | 説明 |
| display_order | INT | DEFAULT 0 | - | 表示順 |
| is_active | BOOLEAN | DEFAULT TRUE | - | 有効フラグ |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

### 2.6 engineer_skills（エンジニアスキル）
| カラム名 | データ型 | NULL | 主キー | 説明 |
|----------|----------|------|--------|------|
| id | BIGINT | NOT NULL | PK | ID |
| engineer_id | BIGINT | NOT NULL | FK | エンジニアID |
| skill_master_id | BIGINT | NOT NULL | FK | スキルマスタID |
| proficiency_level | ENUM('beginner', 'intermediate', 'advanced', 'expert') | DEFAULT 'intermediate' | - | 習熟度 |
| years_of_experience | DECIMAL(3,1) | NULL | - | 経験年数 |
| last_used_date | DATE | NULL | - | 最後に使用した日付 |
| is_primary | BOOLEAN | DEFAULT FALSE | - | 主要スキルフラグ |
| certification | VARCHAR(255) | NULL | - | 関連資格 |
| notes | TEXT | NULL | - | 備考 |
| created_at | TIMESTAMP | NOT NULL | - | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | - | 更新日時 |

## 3. インデックス設計

```sql
-- ロール経験インデックス
CREATE INDEX idx_engineer_role_experiences_engineer ON engineer_role_experiences(engineer_id);
CREATE INDEX idx_engineer_role_experiences_role ON engineer_role_experiences(role_master_id);
CREATE INDEX idx_engineer_role_experiences_years ON engineer_role_experiences(years_of_experience);
CREATE INDEX idx_engineer_role_experiences_primary ON engineer_role_experiences(is_primary);

-- 業務経験インデックス
CREATE INDEX idx_engineer_work_experiences_engineer ON engineer_work_experiences(engineer_id);
CREATE INDEX idx_engineer_work_experiences_task ON engineer_work_experiences(work_task_master_id);
CREATE INDEX idx_engineer_work_experiences_level ON engineer_work_experiences(proficiency_level);

-- スキルインデックス
CREATE INDEX idx_engineer_skills_engineer ON engineer_skills(engineer_id);
CREATE INDEX idx_engineer_skills_skill ON engineer_skills(skill_master_id);
CREATE INDEX idx_engineer_skills_level ON engineer_skills(proficiency_level);
CREATE INDEX idx_engineer_skills_primary ON engineer_skills(is_primary);

-- マスタテーブルインデックス
CREATE UNIQUE INDEX idx_role_masters_code ON role_masters(role_code);
CREATE UNIQUE INDEX idx_work_task_masters_code ON work_task_masters(task_code);
CREATE UNIQUE INDEX idx_skill_masters_code ON skill_masters(skill_code);
CREATE INDEX idx_skill_masters_type ON skill_masters(skill_type);
```

## 4. 外部キー制約

```sql
-- ロール経験
ALTER TABLE engineer_role_experiences 
  ADD CONSTRAINT fk_engineer_role_experiences_engineer 
  FOREIGN KEY (engineer_id) REFERENCES engineers(id) ON DELETE CASCADE;

ALTER TABLE engineer_role_experiences 
  ADD CONSTRAINT fk_engineer_role_experiences_role 
  FOREIGN KEY (role_master_id) REFERENCES role_masters(id);

-- 業務経験
ALTER TABLE engineer_work_experiences 
  ADD CONSTRAINT fk_engineer_work_experiences_engineer 
  FOREIGN KEY (engineer_id) REFERENCES engineers(id) ON DELETE CASCADE;

ALTER TABLE engineer_work_experiences 
  ADD CONSTRAINT fk_engineer_work_experiences_task 
  FOREIGN KEY (work_task_master_id) REFERENCES work_task_masters(id);

-- スキル
ALTER TABLE engineer_skills 
  ADD CONSTRAINT fk_engineer_skills_engineer 
  FOREIGN KEY (engineer_id) REFERENCES engineers(id) ON DELETE CASCADE;

ALTER TABLE engineer_skills 
  ADD CONSTRAINT fk_engineer_skills_skill 
  FOREIGN KEY (skill_master_id) REFERENCES skill_masters(id);
```

## 5. 検索クエリ例

### 5.1 ロール経験による検索
```sql
-- PM経験3年以上のエンジニアを検索
SELECT DISTINCT e.*
FROM engineers e
INNER JOIN engineer_role_experiences ere ON e.id = ere.engineer_id
INNER JOIN role_masters rm ON ere.role_master_id = rm.id
WHERE rm.role_code = 'PM'
  AND ere.years_of_experience >= 3
  AND e.is_public = TRUE
  AND e.current_status IN ('waiting', 'waiting_soon');
```

### 5.2 複数ロール経験による検索
```sql
-- PM経験3年以上かつPL経験2年以上のエンジニアを検索
SELECT e.*
FROM engineers e
WHERE e.is_public = TRUE
  AND e.current_status IN ('waiting', 'waiting_soon')
  AND EXISTS (
    SELECT 1 FROM engineer_role_experiences ere
    INNER JOIN role_masters rm ON ere.role_master_id = rm.id
    WHERE ere.engineer_id = e.id
      AND rm.role_code = 'PM'
      AND ere.years_of_experience >= 3
  )
  AND EXISTS (
    SELECT 1 FROM engineer_role_experiences ere
    INNER JOIN role_masters rm ON ere.role_master_id = rm.id
    WHERE ere.engineer_id = e.id
      AND rm.role_code = 'PL'
      AND ere.years_of_experience >= 2
  );
```

### 5.3 業務経験による検索
```sql
-- 要件定義と基本設計の経験があるエンジニアを検索
SELECT DISTINCT e.*
FROM engineers e
WHERE e.is_public = TRUE
  AND e.current_status IN ('waiting', 'waiting_soon')
  AND EXISTS (
    SELECT 1 FROM engineer_work_experiences ewe
    INNER JOIN work_task_masters wtm ON ewe.work_task_master_id = wtm.id
    WHERE ewe.engineer_id = e.id
      AND wtm.task_code = 'requirement_definition'
      AND ewe.proficiency_level IN ('advanced', 'expert')
  )
  AND EXISTS (
    SELECT 1 FROM engineer_work_experiences ewe
    INNER JOIN work_task_masters wtm ON ewe.work_task_master_id = wtm.id
    WHERE ewe.engineer_id = e.id
      AND wtm.task_code = 'basic_design'
      AND ewe.proficiency_level IN ('advanced', 'expert')
  );
```

### 5.4 スキルとロールの複合検索
```sql
-- React経験ありでPL経験2年以上のエンジニアを検索
SELECT DISTINCT e.*
FROM engineers e
WHERE e.is_public = TRUE
  AND e.current_status IN ('waiting', 'waiting_soon')
  AND EXISTS (
    SELECT 1 FROM engineer_skills es
    INNER JOIN skill_masters sm ON es.skill_master_id = sm.id
    WHERE es.engineer_id = e.id
      AND sm.skill_name = 'React'
      AND es.proficiency_level IN ('intermediate', 'advanced', 'expert')
  )
  AND EXISTS (
    SELECT 1 FROM engineer_role_experiences ere
    INNER JOIN role_masters rm ON ere.role_master_id = rm.id
    WHERE ere.engineer_id = e.id
      AND rm.role_code = 'PL'
      AND ere.years_of_experience >= 2
  );
```

## 6. データ移行計画

### 6.1 既存skill_sheetsテーブルからの移行

現在のskill_sheetsテーブルのJSON形式データから、新しい正規化されたテーブルへのデータ移行：

1. **programming_languages** → skill_masters + engineer_skills
2. **frameworks** → skill_masters + engineer_skills
3. **databases** → skill_masters + engineer_skills
4. **cloud_services** → skill_masters + engineer_skills
5. **tools** → skill_masters + engineer_skills
6. **possible_roles** → role_masters + engineer_role_experiences
7. **possible_phases** → work_task_masters + engineer_work_experiences

### 6.2 移行スクリプト例

```python
# JSON データから正規化テーブルへの移行例
def migrate_skills(engineer_id, skill_sheet):
    # プログラミング言語の移行
    if skill_sheet.programming_languages:
        languages = json.loads(skill_sheet.programming_languages)
        for lang in languages:
            # skill_mastersに存在確認・追加
            skill_master = get_or_create_skill_master(
                skill_name=lang['name'],
                skill_type='language'
            )
            
            # engineer_skillsに追加
            create_engineer_skill(
                engineer_id=engineer_id,
                skill_master_id=skill_master.id,
                years_of_experience=lang.get('years', 0),
                proficiency_level=lang.get('level', 'intermediate')
            )
```

## 7. API設計への影響

### 7.1 エンジニア検索API

```typescript
// 検索リクエストパラメータ
interface EngineerSearchRequest {
  // ロール条件
  roleFilters?: {
    roleCode: string;
    minYears: number;
  }[];
  
  // 業務経験条件
  workExperienceFilters?: {
    taskCode: string;
    minLevel?: 'basic' | 'intermediate' | 'advanced' | 'expert';
  }[];
  
  // スキル条件
  skillFilters?: {
    skillName: string;
    minLevel?: 'beginner' | 'intermediate' | 'advanced' | 'expert';
  }[];
  
  // その他の条件
  status?: string[];
  availableDateFrom?: string;
  availableDateTo?: string;
  minAge?: number;
  maxAge?: number;
  minRate?: number;
  maxRate?: number;
}
```

### 7.2 レスポンス形式

```typescript
interface EngineerSearchResponse {
  engineers: {
    id: number;
    name: string;
    age: number;
    currentStatus: string;
    availableDate: string;
    
    // ロール経験
    roleExperiences: {
      roleCode: string;
      roleName: string;
      years: number;
      proficiencyLevel: string;
    }[];
    
    // 業務経験
    workExperiences: {
      taskCode: string;
      taskName: string;
      proficiencyLevel: string;
      yearsOfExperience?: number;
    }[];
    
    // スキル
    skills: {
      skillName: string;
      skillType: string;
      proficiencyLevel: string;
      yearsOfExperience?: number;
    }[];
    
    rate?: {
      min: number;
      max: number;
    };
  }[];
  
  totalCount: number;
  page: number;
  pageSize: number;
}
```

## 8. パフォーマンス考慮事項

### 8.1 検索最適化

1. **マテリアライズドビュー**の検討
   - 頻繁に使用される検索条件の組み合わせをビュー化
   - エンジニアの最新ステータスを含む集約ビュー

2. **全文検索インデックス**
   - スキル名、タスク名での部分一致検索対応

3. **キャッシュ戦略**
   - マスタデータのメモリキャッシュ
   - 検索結果の短期キャッシュ（Redis等）

### 8.2 スケーラビリティ

1. **パーティショニング**
   - engineer_role_experiences、engineer_work_experiencesを企業IDでパーティション化

2. **読み取り専用レプリカ**
   - 検索処理を読み取り専用DBで実行

## 9. セキュリティ考慮事項

1. **データアクセス制御**
   - 企業間でのエンジニア情報の適切な分離
   - 公開/非公開フラグの厳密な制御

2. **個人情報保護**
   - エンジニアのプライバシー設定に応じた情報開示制御
   - クライアント企業への限定的な情報提供

3. **監査ログ**
   - 検索履歴の記録
   - エンジニア情報へのアクセスログ