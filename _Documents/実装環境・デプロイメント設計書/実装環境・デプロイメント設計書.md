# 実装環境・デプロイメント設計書 - さくらVPS対応版

## 1. 環境構成概要

### 1.1 環境分類
| 環境 | 目的 | URL例 | 利用者 | インフラ構成 |
|------|------|-------|--------|------------|
| 開発環境 (Development) | 開発・単体テスト | http://localhost:3000 | 開発者 | ローカルDocker |
| ステージング環境 (Staging) | 結合テスト・検証 | https://staging.skillsheet.example.com | 開発者・QA・顧客 | さくらVPS（2GB） |
| 本番環境 (Production) | 実際のサービス提供 | https://skillsheet.example.com | エンドユーザー | さくらVPS（4GB×2） |
| バックアップ環境 (Backup) | 災害復旧用 | - | システム | さくらVPS（2GB） |

### 1.2 さくらVPSアーキテクチャ構成
```
本番環境アーキテクチャ（さくらVPS）:

[インターネット]
      │
[さくらのDNS/CDN]
      │
┌─────────────────────────────────────┐
│     ロードバランサー (Nginx)        │
│  - SSL終端 (Let's Encrypt)         │
│  - リバースプロキシ                 │
│  - 負荷分散                        │
└─────────────────────────────────────┘
      │                    │
┌──────────────┐    ┌──────────────┐
│  VPSサーバー1 │    │  VPSサーバー2 │
│  (4GB RAM)   │    │  (4GB RAM)   │
├──────────────┤    ├──────────────┤
│ Docker構成:   │    │ Docker構成:   │
│ - Frontend   │    │ - Frontend   │
│ - Backend    │    │ - Backend    │
│ - Worker     │    │ - Worker     │
└──────────────┘    └──────────────┘
           │              │
    ┌──────────────────────┐
    │   共有データベース     │
    │  - PostgreSQL 15     │
    │  - Redis 7          │
    │  - Elasticsearch 8   │
    └──────────────────────┘
           │
    ┌──────────────────────┐
    │  オブジェクトストレージ │
    │  (さくらのクラウド)   │
    └──────────────────────┘
```

## 2. 開発環境設計（ローカルDocker）

### 2.1 開発用Docker Compose設定

#### docker-compose.yml
```yaml
version: '3.8'

services:
  # フロントエンド（React）
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - REACT_APP_API_URL=http://localhost:8000/api/v1
      - REACT_APP_WS_URL=ws://localhost:8000
      - CHOKIDAR_USEPOLLING=true
    depends_on:
      - backend
    networks:
      - skillsheet-dev

  # バックエンド（Node.js）
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    ports:
      - "8000:8000"
      - "9229:9229"  # デバッガー
    volumes:
      - ./backend:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://skillsheet:password@postgres:5432/skillsheet_dev
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=dev-jwt-secret
      - CORS_ORIGIN=http://localhost:3000
    depends_on:
      - postgres
      - redis
    networks:
      - skillsheet-dev

  # PostgreSQL
  postgres:
    image: postgres:15-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=skillsheet
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=skillsheet_dev
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - skillsheet-dev

  # Redis
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - skillsheet-dev

  # Elasticsearch
  elasticsearch:
    image: elasticsearch:8.11.0
    ports:
      - "9200:9200"
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    volumes:
      - es_data:/usr/share/elasticsearch/data
    networks:
      - skillsheet-dev

volumes:
  postgres_data:
  redis_data:
  es_data:

networks:
  skillsheet-dev:
    driver: bridge
```

### 2.2 開発環境セットアップスクリプト

#### scripts/setup-dev.sh
```bash
#!/bin/bash

echo "🚀 開発環境セットアップ開始"

# 環境変数ファイルの作成
create_env_files() {
    echo "📝 環境変数ファイルを作成中..."
    
    cat > .env.development << EOF
# アプリケーション設定
NODE_ENV=development
PORT=8000

# データベース設定
DATABASE_URL=postgresql://skillsheet:password@postgres:5432/skillsheet_dev

# Redis設定
REDIS_URL=redis://redis:6379

# JWT設定
JWT_SECRET=dev-jwt-secret-change-in-production

# 暗号化キー
ENCRYPTION_KEY=dev-encryption-key-32-characters

# CORS設定
CORS_ORIGIN=http://localhost:3000

# Elasticsearch
ELASTICSEARCH_URL=http://elasticsearch:9200
EOF

    echo "✅ 環境変数ファイルを作成しました"
}

# Dockerコンテナの起動
start_docker() {
    echo "🐳 Dockerコンテナを起動中..."
    
    # 既存のコンテナを停止
    docker-compose down
    
    # イメージをビルド
    docker-compose build
    
    # コンテナを起動
    docker-compose up -d
    
    echo "⏳ サービスの起動を待機中..."
    sleep 15
    
    echo "✅ Dockerコンテナが起動しました"
}

# データベースの初期化
init_database() {
    echo "🗄️ データベースを初期化中..."
    
    # マイグレーション実行
    docker-compose exec backend npm run migrate:dev
    
    # シードデータ投入
    docker-compose exec backend npm run seed:dev
    
    echo "✅ データベースの初期化が完了しました"
}

# メイン処理
main() {
    create_env_files
    start_docker
    init_database
    
    echo "🎉 開発環境のセットアップが完了しました！"
    echo ""
    echo "📋 アクセス情報:"
    echo "  フロントエンド: http://localhost:3000"
    echo "  バックエンドAPI: http://localhost:8000"
    echo "  PostgreSQL: localhost:5432"
    echo "  Redis: localhost:6379"
    echo "  Elasticsearch: http://localhost:9200"
}

main
```

## 3. さくらVPS環境構築

### 3.1 VPSサーバー初期設定

#### scripts/init-vps.sh
```bash
#!/bin/bash

echo "🚀 さくらVPS初期設定開始"

# システムの更新
update_system() {
    echo "📦 システムを更新中..."
    apt update && apt upgrade -y
    apt install -y \
        curl \
        git \
        vim \
        htop \
        ufw \
        fail2ban \
        certbot \
        python3-certbot-nginx
}

# Dockerのインストール
install_docker() {
    echo "🐳 Dockerをインストール中..."
    
    # Dockerの公式リポジトリを追加
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
    add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
    
    # Dockerをインストール
    apt update
    apt install -y docker-ce docker-ce-cli containerd.io docker-compose
    
    # Dockerサービスを有効化
    systemctl enable docker
    systemctl start docker
}

# ファイアウォールの設定
setup_firewall() {
    echo "🔥 ファイアウォールを設定中..."
    
    # 基本的なルール
    ufw default deny incoming
    ufw default allow outgoing
    
    # 必要なポートを開放
    ufw allow 22/tcp    # SSH
    ufw allow 80/tcp    # HTTP
    ufw allow 443/tcp   # HTTPS
    
    # ファイアウォールを有効化
    ufw --force enable
}

# ユーザーの作成
create_user() {
    echo "👤 アプリケーションユーザーを作成中..."
    
    # skillsheetユーザーを作成
    useradd -m -s /bin/bash skillsheet
    usermod -aG docker skillsheet
    
    # ディレクトリ構造を作成
    mkdir -p /home/skillsheet/{app,logs,backups,scripts}
    chown -R skillsheet:skillsheet /home/skillsheet
}

# Nginxのインストールと設定
setup_nginx() {
    echo "🌐 Nginxをセットアップ中..."
    
    apt install -y nginx
    
    # Nginx設定ファイルを作成
    cat > /etc/nginx/sites-available/skillsheet << 'EOF'
upstream backend {
    server 127.0.0.1:8000;
    server 127.0.0.1:8001 backup;
}

server {
    listen 80;
    server_name skillsheet.example.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name skillsheet.example.com;

    ssl_certificate /etc/letsencrypt/live/skillsheet.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/skillsheet.example.com/privkey.pem;

    # セキュリティヘッダー
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # APIプロキシ
    location /api {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 静的ファイル
    location / {
        root /home/skillsheet/app/frontend/dist;
        try_files $uri $uri/ /index.html;
    }
}
EOF

    # 設定を有効化
    ln -s /etc/nginx/sites-available/skillsheet /etc/nginx/sites-enabled/
    nginx -t && systemctl restart nginx
}

# メイン処理
main() {
    update_system
    install_docker
    setup_firewall
    create_user
    setup_nginx
    
    echo "✅ さくらVPSの初期設定が完了しました"
}

main
```

### 3.2 アプリケーションデプロイスクリプト

#### scripts/deploy.sh
```bash
#!/bin/bash

set -e

DEPLOY_USER="skillsheet"
DEPLOY_DIR="/home/skillsheet/app"
BACKUP_DIR="/home/skillsheet/backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "🚀 デプロイ開始: $TIMESTAMP"

# バックアップの作成
backup_current() {
    echo "💾 現在のアプリケーションをバックアップ中..."
    
    if [ -d "$DEPLOY_DIR" ]; then
        tar -czf "$BACKUP_DIR/backup_$TIMESTAMP.tar.gz" -C "$DEPLOY_DIR" .
        echo "✅ バックアップ完了: backup_$TIMESTAMP.tar.gz"
    fi
}

# 新しいコードのデプロイ
deploy_code() {
    echo "📦 新しいコードをデプロイ中..."
    
    # GitHubから最新のコードを取得
    cd $DEPLOY_DIR
    git pull origin main
    
    # 依存関係のインストール
    cd $DEPLOY_DIR/backend && npm ci --production
    cd $DEPLOY_DIR/frontend && npm ci && npm run build
}

# Dockerコンテナの更新
update_containers() {
    echo "🐳 Dockerコンテナを更新中..."
    
    cd $DEPLOY_DIR
    
    # 新しいイメージをビルド
    docker-compose -f docker-compose.prod.yml build
    
    # Blue-Greenデプロイメント
    docker-compose -f docker-compose.prod.yml up -d --no-deps --scale backend=2 backend-new
    
    # ヘルスチェック
    echo "🏥 ヘルスチェック実行中..."
    sleep 10
    
    if curl -f http://localhost:8001/health; then
        echo "✅ 新しいバージョンが正常に起動しました"
        
        # 古いコンテナを停止
        docker-compose -f docker-compose.prod.yml stop backend
        docker-compose -f docker-compose.prod.yml rm -f backend
        
        # 新しいコンテナをbackendにリネーム
        docker-compose -f docker-compose.prod.yml up -d --no-deps backend
    else
        echo "❌ ヘルスチェック失敗。ロールバック中..."
        docker-compose -f docker-compose.prod.yml stop backend-new
        docker-compose -f docker-compose.prod.yml rm -f backend-new
        exit 1
    fi
}

# データベースマイグレーション
run_migrations() {
    echo "🗄️ データベースマイグレーション実行中..."
    
    docker-compose -f docker-compose.prod.yml exec backend npm run migrate:prod
}

# キャッシュクリア
clear_cache() {
    echo "🧹 キャッシュをクリア中..."
    
    docker-compose -f docker-compose.prod.yml exec redis redis-cli FLUSHDB
}

# メイン処理
main() {
    backup_current
    deploy_code
    update_containers
    run_migrations
    clear_cache
    
    echo "✅ デプロイが完了しました！"
}

# ユーザーをskillsheetに切り替えて実行
if [ "$USER" != "$DEPLOY_USER" ]; then
    sudo -u $DEPLOY_USER $0 "$@"
else
    main
fi
```

### 3.3 本番環境用Docker Compose設定

#### docker-compose.prod.yml
```yaml
version: '3.8'

services:
  # Nginx（リバースプロキシ）
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./frontend/dist:/usr/share/nginx/html:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - backend
    restart: always

  # バックエンド
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://skillsheet:${DB_PASSWORD}@postgres:5432/skillsheet_prod
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      - JWT_SECRET=${JWT_SECRET}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
    depends_on:
      - postgres
      - redis
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ワーカー
  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    command: npm run worker
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://skillsheet:${DB_PASSWORD}@postgres:5432/skillsheet_prod
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
    depends_on:
      - postgres
      - redis
    restart: always

  # PostgreSQL
  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=skillsheet
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=skillsheet_prod
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups/postgres:/backups
    restart: always

  # Redis
  redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    restart: always

  # Elasticsearch
  elasticsearch:
    image: elasticsearch:8.11.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=true
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
    volumes:
      - es_data:/usr/share/elasticsearch/data
    restart: always

volumes:
  postgres_data:
  redis_data:
  es_data:
```

## 4. CI/CDパイプライン（GitHub Actions）

### 4.1 CI/CDワークフロー

#### .github/workflows/deploy.yml
```yaml
name: Deploy to Sakura VPS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '18'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        cd backend && npm ci
        cd ../frontend && npm ci
    
    - name: Run tests
      run: |
        cd backend && npm test
        cd ../frontend && npm test
    
    - name: Build
      run: |
        cd backend && npm run build
        cd ../frontend && npm run build

  deploy-staging:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to Staging
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        script: |
          cd /home/skillsheet/app
          git pull origin develop
          ./scripts/deploy.sh

  deploy-production:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to Production
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          cd /home/skillsheet/app
          git pull origin main
          ./scripts/deploy.sh
    
    - name: Notify Slack
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: 'Production deployment ${{ job.status }}'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
```

## 5. 監視・ログ管理

### 5.1 監視設定

#### monitoring/docker-compose.monitoring.yml
```yaml
version: '3.8'

services:
  # Prometheus
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    restart: always

  # Grafana
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3030:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
    depends_on:
      - prometheus
    restart: always

  # Node Exporter
  node-exporter:
    image: prom/node-exporter:latest
    ports:
      - "9100:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    restart: always

  # Loki（ログ収集）
  loki:
    image: grafana/loki:latest
    ports:
      - "3100:3100"
    volumes:
      - loki_data:/loki
    restart: always

  # Promtail（ログ転送）
  promtail:
    image: grafana/promtail:latest
    volumes:
      - /var/log:/var/log:ro
      - ./promtail.yml:/etc/promtail/promtail.yml:ro
    command: -config.file=/etc/promtail/promtail.yml
    restart: always

volumes:
  prometheus_data:
  grafana_data:
  loki_data:
```

### 5.2 バックアップスクリプト

#### scripts/backup.sh
```bash
#!/bin/bash

BACKUP_DIR="/home/skillsheet/backups"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

echo "🔄 バックアップ開始: $DATE"

# PostgreSQLバックアップ
backup_postgres() {
    echo "📊 PostgreSQLをバックアップ中..."
    
    docker-compose -f docker-compose.prod.yml exec -T postgres \
        pg_dump -U skillsheet skillsheet_prod | \
        gzip > "$BACKUP_DIR/postgres/db_backup_$DATE.sql.gz"
}

# Redisバックアップ
backup_redis() {
    echo "💾 Redisをバックアップ中..."
    
    docker-compose -f docker-compose.prod.yml exec -T redis \
        redis-cli --rdb "$BACKUP_DIR/redis/dump_$DATE.rdb" BGSAVE
}

# アップロードファイルのバックアップ
backup_uploads() {
    echo "📁 アップロードファイルをバックアップ中..."
    
    tar -czf "$BACKUP_DIR/uploads/uploads_$DATE.tar.gz" \
        -C /home/skillsheet/app/uploads .
}

# 古いバックアップの削除
cleanup_old_backups() {
    echo "🧹 古いバックアップを削除中..."
    
    find $BACKUP_DIR -name "*.gz" -mtime +$RETENTION_DAYS -delete
    find $BACKUP_DIR -name "*.rdb" -mtime +$RETENTION_DAYS -delete
}

# さくらのオブジェクトストレージへアップロード
upload_to_storage() {
    echo "☁️ オブジェクトストレージにアップロード中..."
    
    # s3cmdを使用してアップロード
    s3cmd put "$BACKUP_DIR/postgres/db_backup_$DATE.sql.gz" \
        s3://skillsheet-backups/postgres/
    
    s3cmd put "$BACKUP_DIR/uploads/uploads_$DATE.tar.gz" \
        s3://skillsheet-backups/uploads/
}

# メイン処理
main() {
    backup_postgres
    backup_redis
    backup_uploads
    upload_to_storage
    cleanup_old_backups
    
    echo "✅ バックアップ完了: $DATE"
}

main
```

## 6. セキュリティ設定

### 6.1 セキュリティ強化スクリプト

#### scripts/security-hardening.sh
```bash
#!/bin/bash

echo "🔒 セキュリティ強化設定を適用中..."

# SSH設定の強化
harden_ssh() {
    echo "🔐 SSH設定を強化中..."
    
    # SSHDの設定を更新
    cat >> /etc/ssh/sshd_config << EOF
# セキュリティ強化設定
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
MaxAuthTries 3
ClientAliveInterval 300
ClientAliveCountMax 2
AllowUsers skillsheet
EOF

    systemctl restart sshd
}

# Fail2banの設定
setup_fail2ban() {
    echo "🛡️ Fail2banを設定中..."
    
    cat > /etc/fail2ban/jail.local << EOF
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 5

[sshd]
enabled = true

[nginx-http-auth]
enabled = true

[nginx-limit-req]
enabled = true
EOF

    systemctl enable fail2ban
    systemctl restart fail2ban
}

# システムの監査設定
setup_auditd() {
    echo "📝 監査ログを設定中..."
    
    apt install -y auditd
    
    # 監査ルールを追加
    cat >> /etc/audit/rules.d/audit.rules << EOF
# ファイル整合性監視
-w /etc/passwd -p wa -k passwd_changes
-w /etc/shadow -p wa -k shadow_changes
-w /etc/sudoers -p wa -k sudoers_changes

# システムコール監視
-a always,exit -F arch=b64 -S execve -k exec_commands
EOF

    systemctl enable auditd
    systemctl restart auditd
}

# アプリケーションファイアウォール
setup_modsecurity() {
    echo "🔥 ModSecurityを設定中..."
    
    apt install -y libapache2-mod-security2
    
    # OWASP CRSを有効化
    git clone https://github.com/coreruleset/coreruleset.git /etc/modsecurity/
    cp /etc/modsecurity/coreruleset/crs-setup.conf.example /etc/modsecurity/coreruleset/crs-setup.conf
}

# メイン処理
main() {
    harden_ssh
    setup_fail2ban
    setup_auditd
    setup_modsecurity
    
    echo "✅ セキュリティ強化設定が完了しました"
}

main
```

## 7. 障害対応・復旧手順

### 7.1 緊急時対応スクリプト

#### scripts/emergency-response.sh
```bash
#!/bin/bash

echo "🚨 緊急対応モード"

# サービス状態確認
check_services() {
    echo "🔍 サービス状態を確認中..."
    
    docker-compose -f docker-compose.prod.yml ps
    
    # ヘルスチェック
    curl -f http://localhost:8000/health || echo "❌ Backend is down"
    curl -f http://localhost:3000 || echo "❌ Frontend is down"
}

# 緊急ロールバック
emergency_rollback() {
    echo "⏪ 緊急ロールバックを実行中..."
    
    LAST_BACKUP=$(ls -t /home/skillsheet/backups/backup_*.tar.gz | head -1)
    
    if [ -f "$LAST_BACKUP" ]; then
        cd /home/skillsheet/app
        tar -xzf "$LAST_BACKUP"
        docker-compose -f docker-compose.prod.yml up -d --force-recreate
        echo "✅ ロールバック完了"
    else
        echo "❌ バックアップが見つかりません"
    fi
}

# ログ収集
collect_logs() {
    echo "📋 ログを収集中..."
    
    INCIDENT_DIR="/tmp/incident_$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$INCIDENT_DIR"
    
    # Dockerログ
    docker-compose -f docker-compose.prod.yml logs > "$INCIDENT_DIR/docker.log"
    
    # システムログ
    journalctl -u docker --since "1 hour ago" > "$INCIDENT_DIR/system.log"
    
    # Nginxログ
    tail -n 1000 /var/log/nginx/error.log > "$INCIDENT_DIR/nginx.log"
    
    tar -czf "$INCIDENT_DIR.tar.gz" "$INCIDENT_DIR"
    echo "✅ ログ収集完了: $INCIDENT_DIR.tar.gz"
}

# メンテナンスモード切り替え
toggle_maintenance() {
    echo "🔧 メンテナンスモードに切り替え中..."
    
    cat > /etc/nginx/sites-available/maintenance << EOF
server {
    listen 80 default_server;
    listen 443 ssl default_server;
    
    ssl_certificate /etc/letsencrypt/live/skillsheet.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/skillsheet.example.com/privkey.pem;
    
    location / {
        return 503;
        error_page 503 @maintenance;
    }
    
    location @maintenance {
        root /usr/share/nginx/html;
        rewrite ^.*$ /maintenance.html break;
    }
}
EOF

    ln -sf /etc/nginx/sites-available/maintenance /etc/nginx/sites-enabled/default
    nginx -s reload
}

# メニュー表示
show_menu() {
    echo ""
    echo "緊急対応オプション:"
    echo "1) サービス状態確認"
    echo "2) 緊急ロールバック"
    echo "3) ログ収集"
    echo "4) メンテナンスモード切り替え"
    echo "5) 終了"
    echo ""
    read -p "選択してください: " choice
    
    case $choice in
        1) check_services ;;
        2) emergency_rollback ;;
        3) collect_logs ;;
        4) toggle_maintenance ;;
        5) exit 0 ;;
        *) echo "無効な選択です" ;;
    esac
}

# メイン処理
while true; do
    show_menu
done
```

## 8. 運用ドキュメント

### 8.1 日次運用チェックリスト

```markdown
# 日次運用チェックリスト

## 朝の確認事項（9:00）
- [ ] 各種サービスの死活監視確認
- [ ] エラーログの確認
- [ ] ディスク使用率の確認（80%以下）
- [ ] メモリ使用率の確認
- [ ] 前日のバックアップ成功確認

## 日中の監視事項
- [ ] レスポンスタイムの監視
- [ ] APIエラー率の監視
- [ ] アクティブユーザー数の確認

## 夕方の確認事項（18:00）
- [ ] 当日のインシデント対応状況
- [ ] 明日のメンテナンス予定確認
- [ ] セキュリティアラートの確認
```

### 8.2 トラブルシューティングガイド

```markdown
# トラブルシューティングガイド

## サービスが起動しない場合

1. Dockerコンテナの状態確認
```bash
docker-compose -f docker-compose.prod.yml ps
```

2. ログの確認
```bash
docker-compose -f docker-compose.prod.yml logs backend
```

3. リソース使用状況の確認
```bash
htop
df -h
```

## データベース接続エラー

1. PostgreSQLコンテナの確認
```bash
docker-compose -f docker-compose.prod.yml exec postgres pg_isready
```

2. 接続設定の確認
```bash
cat .env | grep DATABASE_URL
```

## 高負荷時の対応

1. 負荷の原因特定
```bash
top
iotop
netstat -tulpn
```

2. 一時的なスケールアップ
```bash
docker-compose -f docker-compose.prod.yml up -d --scale backend=3
```
```

この設計書により、さくらVPSを使用した本格的なエンジニアスキルシート管理システムの構築・運用が可能になります。