# 権限管理実装調査レポート

## 調査日時
2025年8月22日

## 調査概要
CompactSkillSheetsAppシステムにおける権限管理機能の現状を調査し、Rolesテーブルを使った権限管理が実装されていない問題点を詳細に分析しました。

## 1. 現状のデータベース構造

### 1.1 権限関連テーブル
以下のテーブルが定義されていますが、**実際には使用されていません**：

- **rolesテーブル**
  - id, name, displayName, description, isSystem
  - 役割（管理者、営業、エンジニア等）を定義するためのテーブル

- **permissionsテーブル**
  - id, name, displayName, resource, action, description
  - リソースごとのアクション権限を定義するためのテーブル

- **user_rolesテーブル**
  - userId, roleId, grantedBy
  - ユーザーと役割の紐付けテーブル

- **role_permissionsテーブル**
  - roleId, permissionId
  - 役割と権限の紐付けテーブル

### 1.2 データベースの問題点
- **初期データが投入されていない**
  - rolesテーブルに役割データが存在しない
  - permissionsテーブルに権限データが存在しない
  - user_rolesでユーザーに役割が割り当てられていない（一部のSQLファイルで参照はあるが、実際のロールデータが存在しない）

## 2. バックエンド実装の現状

### 2.1 ハードコーディングされた権限管理
`backend/src/services/authService.ts`において、権限管理が以下のようにハードコーディングされています：

```typescript
const ROLE_PERMISSIONS: Record<string, string[]> = {
  admin: Object.values(PERMISSIONS),
  manager: [
    PERMISSIONS.USER_VIEW,
    PERMISSIONS.USER_CREATE,
    // ...
  ],
  sales: [
    PERMISSIONS.ENGINEER_VIEW,
    PERMISSIONS.SKILLSHEET_VIEW,
    // ...
  ],
  engineer: [
    PERMISSIONS.SKILLSHEET_VIEW,
    PERMISSIONS.SKILLSHEET_UPDATE
  ]
};
```

### 2.2 認証・認可の実装
- **authenticateToken** (`backend/src/middleware/auth.middleware.ts`)
  - JWTトークンの検証のみ実施
  - ユーザー情報をreq.userに設定

- **requireRole** (`backend/src/middleware/roleMiddleware.ts`)
  - ロールベースの簡易チェックのみ
  - データベースの権限情報を参照していない

- **hasPermission** (`backend/src/services/authService.ts`)
  - ハードコーディングされたROLE_PERMISSIONSを参照
  - データベースの権限情報を使用していない

### 2.3 APIエンドポイントの権限チェック
- 一部のエンドポイントでrequireRoleミドルウェアを使用
- 例：`requireRole(['admin', 'sales'])`のような形式で使用
- 細かい権限（リソース＋アクション）レベルの制御は未実装

## 3. フロントエンド実装の現状

### 3.1 権限チェック機能
`frontend/src/stores/authStore.ts`のhasPermission関数：

```typescript
hasPermission: (resource: string, action: string) => {
  const { user } = get();
  if (!user) return false;
  
  // 管理者は全権限を持つ
  if (user.roles.includes('admin')) return true;
  
  // 特定の権限をチェック
  const permission = `${resource}:${action}`;
  return user.permissions.includes(permission) || user.permissions.includes('*');
}
```

### 3.2 問題点
- ユーザーオブジェクトの権限配列を直接参照
- サーバーサイドのデータベース権限との連携なし
- 権限情報がJWTトークンに含まれるハードコーディングされた内容に依存

## 4. 主要な問題点のまとめ

### 4.1 データベースレベルの問題
1. **Rolesテーブルが未使用**
   - テーブル構造は存在するが、データが投入されていない
   - アプリケーションから参照されていない

2. **Permissionsテーブルが未使用**
   - 権限データが存在しない
   - role_permissionsテーブルとの連携が機能していない

3. **User_rolesテーブルが部分的にしか使用されていない**
   - 一部のSQLファイルで参照はあるが、実際の運用では使われていない

### 4.2 アプリケーションレベルの問題
1. **権限管理のハードコーディング**
   - authService.ts内でROLE_PERMISSIONSがハードコーディング
   - 権限の追加・変更にコード修正が必要

2. **データベースとの非連携**
   - hasPermission関数がデータベースを参照しない
   - ユーザーログイン時にデータベースから権限を取得していない

3. **動的な権限管理の不可**
   - 運用中に権限を変更できない
   - 新しい役割や権限の追加が困難

### 4.3 セキュリティ上の懸念
1. **権限情報の改ざんリスク**
   - クライアント側で権限チェックに依存
   - サーバーサイドでの適切な権限検証が不完全

2. **監査ログの不足**
   - 権限変更の履歴が記録されない
   - 誰がいつ権限を付与したかの追跡が困難

## 5. 改善提案

### 5.1 短期的改善
1. **Rolesテーブルへの初期データ投入**
   - admin, manager, sales, engineerなどの基本ロールを定義
   - マイグレーションスクリプトの作成

2. **Permissionsテーブルへのデータ投入**
   - 各リソースとアクションの組み合わせを定義
   - role_permissionsで役割と権限を紐付け

3. **認証サービスの改修**
   - ログイン時にデータベースから権限情報を取得
   - hasPermission関数をデータベース参照型に変更

### 5.2 中長期的改善
1. **権限管理画面の実装**
   - 管理者が権限を動的に管理できるUI
   - 役割の追加・編集・削除機能

2. **監査ログ機能の実装**
   - 権限変更の履歴記録
   - アクセスログの詳細化

3. **権限キャッシュの実装**
   - パフォーマンス向上のためのRedisキャッシュ
   - 権限変更時のキャッシュ無効化処理

## 6. 実装優先度

### 優先度：高
1. Rolesテーブルへの初期データ投入SQLスクリプト作成
2. authServiceのデータベース連携実装
3. ログイン処理での権限情報取得実装

### 優先度：中
1. 権限チェックミドルウェアの改修
2. フロントエンドの権限チェック機能改修
3. APIエンドポイントごとの細かい権限制御

### 優先度：低
1. 権限管理画面の実装
2. 監査ログ機能
3. パフォーマンス最適化

## 7. リスクと対策

### リスク
1. **既存機能への影響**
   - 現在動作している認証機能が停止する可能性
   - 対策：段階的な移行とテストの充実

2. **パフォーマンス低下**
   - データベースアクセスが増えることによる遅延
   - 対策：適切なキャッシュ戦略の実装

3. **移行期間の混乱**
   - 新旧の権限管理が混在する期間の管理
   - 対策：フィーチャーフラグによる段階的切り替え

## 8. 結論

現在のシステムでは、Rolesテーブルを含む権限管理のデータベース構造は存在するものの、実際にはハードコーディングされた権限管理が行われており、データベースベースの動的な権限管理は実装されていません。

早急に以下の対応が必要です：
1. データベースへの初期データ投入
2. authServiceのデータベース連携実装
3. 段階的な移行計画の策定と実行

これらの改善により、より柔軟で安全な権限管理システムの構築が可能となります。