# ログイン機能エラー調査レポート
発生日: 2025-08-24
作成者: Claude

## 1. 問題の概要

### 現象
- フロントエンド（http://localhost:3000/login）からログインできない
- "Network Error" が発生している
- バックエンドAPIは正常に動作している（curlでは成功）

### エラー詳細
```
[Axios Response Error]: AxiosError {message: 'Network Error', name: 'AxiosError', code: 'ERR_NETWORK'}
POST http://localhost:8000/api/auth/login net::ERR_EMPTY_RESPONSE
```

## 2. 調査結果

### 2.1 バックエンド側の状態

#### ✅ 正常に動作している部分
- **ポート8080でバックエンドサーバーは正常起動**
- **curlコマンドでのログインAPI呼び出しは成功**
  ```bash
  curl -X POST http://localhost:8080/api/auth/login \
    -H "Content-Type: application/json" \
    -d '{"email":"admin@demo-ses.example.com","password":"password123"}'
  # → 正常にJWTトークンとユーザー情報を返す
  ```
- **データベース認証は正常**
- **JWT生成・検証ロジックは正常**

#### ❌ 問題のある部分
- **ポート8000はOrbStackに占有されている**
- **レート制限ミドルウェアを無効化している**（暫定対応）

### 2.2 フロントエンド側の状態

#### 修正済みの内容
1. **axios baseURL変更**
   - 変更前: `http://localhost:8000/api`
   - 変更後: `http://localhost:8080/api`

2. **エンドポイントURLの修正**
   - 変更前: `auth/login` (スラッシュなし)
   - 変更後: `/auth/login` (スラッシュあり)

#### ⚠️ 現在の問題
- **フロントエンドがまだポート8000にアクセスしようとしている**
- ブラウザのキャッシュまたはビルドの問題の可能性

## 3. 根本原因

### 主要な原因
1. **ポート競合**: OrbStackがポート8000を使用
2. **フロントエンドの設定反映不足**: 変更が反映されていない
3. **環境変数の不整合**: CORS設定やポート設定の不一致

## 4. 修正内容と現在の状態

### 完了した修正
- [x] JWT_SECRET/JWT_REFRESH_SECRETのハードコーディング除去
- [x] SecurityConfigクラスの実装
- [x] AuthServiceのインポート修正（authService → AuthService）
- [x] バックエンドをポート8080で起動
- [x] フロントエンドのaxios設定を8080に変更
- [x] URLパスの修正（スラッシュ追加）

### 未解決の問題
- [ ] フロントエンドが新しい設定を反映していない
- [ ] CORS設定の確認が必要
- [ ] レート制限ミドルウェアの再有効化が必要

## 5. 推奨される解決策

### 即座に実行すべきアクション

1. **フロントエンドの再起動**
   ```bash
   # フロントエンドを停止して再起動
   cd frontend
   npm run dev
   ```

2. **ブラウザキャッシュのクリア**
   - ブラウザの開発者ツールで「キャッシュの無効化」を有効にする
   - またはハードリフレッシュ（Cmd+Shift+R / Ctrl+Shift+R）

3. **環境変数の確認**
   ```bash
   # frontend/.env
   VITE_API_URL=http://localhost:8080/api
   ```

4. **CORS設定の更新**
   ```typescript
   // backend/src/index.ts
   const corsOrigins = process.env.CORS_ORIGIN 
     ? process.env.CORS_ORIGIN.split(',') 
     : ['http://localhost:3000', 'http://localhost:3001'];
   ```

### 長期的な解決策

1. **Docker環境での統一**
   - ポート設定を環境変数で管理
   - docker-compose.ymlで一元管理

2. **レート制限の修正と再有効化**
   ```typescript
   // 現在コメントアウトされている部分を修正後に有効化
   app.use('/api/auth/login', loginRateLimiter);
   ```

3. **ポート8000の解放**
   - OrbStackの設定変更またはバックエンドのデフォルトポート変更

## 6. テスト手順

### バックエンドのテスト
```bash
# ポート8080でのテスト
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@demo-ses.example.com","password":"password123"}'
```

### フロントエンドのテスト
1. ブラウザの開発者ツールでNetworkタブを開く
2. ログイン試行時のリクエストURLを確認
3. 正しいポート（8080）にアクセスしているか確認

## 7. 現在のシステム状態

### 動作確認済み
- ✅ バックエンドAPI（ポート8080）
- ✅ データベース接続
- ✅ JWT認証ロジック
- ✅ Redis接続

### 要確認
- ⚠️ フロントエンドのポート設定反映
- ⚠️ CORS設定
- ⚠️ レート制限機能

## 8. 次のステップ

1. **フロントエンド再起動とキャッシュクリア**
2. **環境変数VITE_API_URLの設定確認**
3. **動作確認後、レート制限の再有効化**
4. **本番環境用の設定ファイル整備**

## 9. 関連ファイル

- `/backend/src/index.ts` - メインサーバーファイル
- `/backend/src/services/authService.ts` - 認証サービス
- `/backend/src/config/security.ts` - セキュリティ設定
- `/frontend/src/lib/axios.ts` - Axios設定
- `/frontend/src/stores/authStore.ts` - 認証ストア

## 10. 結論

バックエンドは正常に動作しているが、フロントエンドが新しいポート設定を反映していないことが主な問題。フロントエンドの再起動と環境変数の確認により解決可能。