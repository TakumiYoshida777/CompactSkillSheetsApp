# フェーズ2: 完全な移行（1週間）

## 目的
ハードコーディングされた権限管理を完全に除去し、データベースベースの動的な権限管理システムに移行する。

## タスク一覧

### 1. フロントエンドのハードコーディング除去（Day 1-2）

#### 1.1 権限定数ファイルの改修
- [ ] `frontend/src/constants/roles.ts`の分析
- [ ] ハードコーディングされた権限配列の特定
  - ENGINEER_REGISTER_ROLES
  - ENGINEER_EDIT_ROLES
  - ENGINEER_VIEW_ROLES
  - PROJECT_MANAGE_ROLES
  - APPROACH_SEND_ROLES
- [ ] 権限情報取得APIの設計
- [ ] 動的権限取得への移行計画作成

#### 1.2 権限情報取得サービスの実装
- [ ] 権限情報取得APIクライアントの作成
- [ ] TanStack Queryを使用したキャッシュ実装
- [ ] 権限情報の型定義（TypeScript）
- [ ] エラーハンドリングの実装
- [ ] リトライロジックの実装

#### 1.3 authStoreの改修
- [ ] hasPermission関数の改修
  - ハードコーディングされた'admin'判定の除去
  - データベースベースの権限チェック実装
- [ ] 権限情報の状態管理改善
- [ ] 権限情報の更新メカニズム実装
- [ ] パフォーマンス最適化

#### 1.4 コンポーネントの権限チェック改修
- [ ] 権限チェックを行うコンポーネントの洗い出し
- [ ] AuthGuardコンポーネントの改修
- [ ] PrivateRouteコンポーネントの改修
- [ ] 権限ベースの表示制御の実装
- [ ] 権限不足時のUIフィードバック改善

### 2. バックエンドAPIの完全対応（Day 3-4）

#### 2.1 権限情報提供APIの実装
- [ ] GET /api/auth/permissions エンドポイント実装
- [ ] GET /api/auth/roles エンドポイント実装
- [ ] GET /api/auth/user-permissions エンドポイント実装
- [ ] 権限マトリクス取得API実装
- [ ] APIレスポンスの最適化

#### 2.2 既存APIルートの改修
- [ ] すべてのルートファイルの権限チェック部分を特定
  - clientUserRoutes.ts
  - businessPartnerRoutes.ts
  - engineerRoutes.ts
  - その他のルートファイル
- [ ] requireRole呼び出しのハードコーディング配列を除去
- [ ] データベースベースの権限チェックに置き換え
- [ ] 動的な権限チェックロジックの実装

#### 2.3 権限継承とスコープの実装
- [ ] 権限の階層構造実装
  - 全体権限（all）
  - 自社権限（company）
  - 個人権限（own）
- [ ] スコープベースの権限チェック実装
- [ ] 権限の継承ルール実装
- [ ] コンテキスト依存の権限チェック

#### 2.4 権限キャッシュシステムの実装
- [ ] Redisを使用した権限キャッシュ実装
- [ ] キャッシュキーの設計
- [ ] キャッシュ有効期限の設定
- [ ] キャッシュ無効化戦略の実装
- [ ] キャッシュウォーミングの実装

### 3. データ移行とマッピング（Day 5）

#### 3.1 既存データの分析
- [ ] 現在のユーザーロール設定の調査
- [ ] 既存の権限パターンの分析
- [ ] 移行対象データの特定
- [ ] データ不整合の確認と修正

#### 3.2 移行スクリプトの作成
- [ ] ユーザーロールマッピングスクリプト作成
- [ ] 権限設定移行スクリプト作成
- [ ] データ検証スクリプト作成
- [ ] ロールバックスクリプト作成

#### 3.3 段階的移行の実施
- [ ] 開発環境での移行実施
- [ ] ステージング環境での移行実施
- [ ] 移行結果の検証
- [ ] 問題点の修正

### 4. テストとデバッグ（Day 6-7）

#### 4.1 単体テストの作成・更新
- [ ] フロントエンド権限チェックのテスト
  - authStoreのテスト
  - 権限取得サービスのテスト
  - コンポーネントのテスト
- [ ] バックエンド権限チェックのテスト
  - APIエンドポイントのテスト
  - ミドルウェアのテスト
  - キャッシュシステムのテスト

#### 4.2 統合テストの実施
- [ ] エンドツーエンドの権限フローテスト
- [ ] 各ユーザーロールでの操作テスト
  - 管理者フロー
  - 営業フロー
  - エンジニアフロー
  - 取引先フロー
- [ ] 権限エスカレーションテスト
- [ ] 権限デエスカレーションテスト

#### 4.3 パフォーマンステスト
- [ ] 権限チェックの応答時間測定
- [ ] キャッシュヒット率の測定
- [ ] データベース負荷テスト
- [ ] 同時アクセステスト
- [ ] ボトルネックの特定と改善

#### 4.4 回帰テスト
- [ ] 既存機能の動作確認
- [ ] 権限変更による影響範囲の確認
- [ ] エッジケースのテスト
- [ ] バグ修正と再テスト

## リスクと対策

### リスク1: フロントエンドの破壊的変更
- **影響**: UIの機能停止
- **対策**: フィーチャーフラグによる段階的切り替え
- **監視**: エラートラッキングツールの設定

### リスク2: API互換性の問題
- **影響**: クライアント-サーバー間の通信エラー
- **対策**: APIバージョニングの実装
- **テスト**: 後方互換性テストの実施

### リスク3: パフォーマンス劣化
- **影響**: レスポンス時間の増加
- **対策**: 積極的なキャッシング戦略
- **最適化**: データベースインデックスの追加

### リスク4: セキュリティホール
- **影響**: 不正なアクセスの可能性
- **対策**: セキュリティ監査の実施
- **テスト**: ペネトレーションテスト

## 成功基準
- [ ] すべてのハードコーディングされた権限が除去されている
- [ ] 権限管理が100%データベースベースになっている
- [ ] パフォーマンスが既存システムの90%以上を維持
- [ ] テストカバレッジが85%以上
- [ ] セキュリティ監査に合格

## 必要なリソース
- 開発者: 3名（フロントエンド1名、バックエンド2名）
- テスター: 2名
- セキュリティエンジニア: 1名（監査用）
- 開発環境
- ステージング環境
- 負荷テストツール
- APMツール

## 完了条件
- [ ] コードレビューが完了している
- [ ] すべてのテストが合格している
- [ ] パフォーマンス基準を満たしている
- [ ] セキュリティ監査が完了している
- [ ] ドキュメントが更新されている
- [ ] ロールバック計画が準備されている