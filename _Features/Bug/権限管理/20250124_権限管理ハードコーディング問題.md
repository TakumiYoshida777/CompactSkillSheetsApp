# 権限管理ハードコーディング問題調査レポート

## 調査日時
2025年1月24日

## 問題の概要
権限管理システムがデータベースベースではなくハードコーディングされており、本番リリースに適さない状態になっている。

## 調査結果

### 1. 重大な問題点

#### 1.1 フロントエンドのハードコーディング
**ファイル**: `frontend/src/constants/roles.ts`

```typescript
// 権限がハードコーディングされている例
export const ENGINEER_REGISTER_ROLES: readonly string[] = [
  SES_ROLES.ADMIN,
  SES_ROLES.SALES,
  SES_ROLES.管理者,
  SES_ROLES.営業,
];

export const ENGINEER_EDIT_ROLES: readonly string[] = [
  SES_ROLES.ADMIN,
  SES_ROLES.SALES,
  SES_ROLES.管理者,
  SES_ROLES.営業,
  SES_ROLES.ENGINEER,
  SES_ROLES.エンジニア,
];
```

**問題**: 
- 権限の追加・変更にはコード修正とデプロイが必要
- 運用中の動的な権限変更が不可能

#### 1.2 フロントエンドの権限チェック
**ファイル**: `frontend/src/stores/authStore.ts`

```typescript
hasPermission: (resource: string, action: string) => {
  const { user } = get();
  if (!user) return false;
  
  // 管理者は全権限を持つ（ハードコーディング）
  if (user.roles && user.roles.includes('admin')) return true;
  
  // 以下略
}
```

**問題**:
- 管理者判定が`'admin'`文字列でハードコーディング
- データベースの権限設定を参照していない

#### 1.3 APIエンドポイントの権限制御
**確認したファイル**:
- `backend/src/routes/clientUserRoutes.ts`
- `backend/src/routes/businessPartnerRoutes.ts`
- その他多数のルートファイル

```typescript
// ロール名がハードコーディングされている例
router.post('/create',
  requireRole(['admin', 'sales']),  // ← ハードコーディング
  businessPartnerController.create
);
```

**問題**:
- すべてのルートでロール名が配列で直接記述
- データベースのロール定義と同期していない

### 2. データベース構造は存在するが未使用

#### 2.1 権限関連テーブル（定義済みだが未使用）
- `roles`テーブル
- `permissions`テーブル
- `user_roles`テーブル
- `role_permissions`テーブル

#### 2.2 初期データ投入スクリプト
**ファイル**: `backend/prisma/seeds/001_roles_permissions.sql`
- 完全な初期データ投入スクリプトが存在
- しかし実際のアプリケーションから参照されていない

### 3. バックエンドの実装状況

#### 3.1 部分的なデータベース連携
**ファイル**: `backend/src/services/authService.ts`

```typescript
static async getUserPermissions(userId: string): Promise<string[]> {
  // データベースから権限を取得する実装はある
  const userWithRoles = await prisma.users.findUnique({
    where: { id: BigInt(userId) },
    include: {
      user_roles: {
        include: {
          roles: {
            include: {
              role_permissions: {
                include: {
                  permissions: true
                }
              }
            }
          }
        }
      }
    }
  });
  // 以下略
}
```

**状況**:
- データベースから権限を取得する実装は存在
- しかし初期データが投入されていない可能性が高い

## 本番リリース判定

### ❌ リリース不可

### 理由
1. **権限管理が完全にハードコーディング**されており、運用中の変更が不可能
2. **セキュリティリスク**: 権限変更に都度デプロイが必要
3. **保守性の問題**: コード変更が必要なため、権限管理の柔軟性がない
4. **データ整合性**: データベース構造とコードが乖離している

## 必要な対応

### 優先度: 最高
1. **データベースへの初期データ投入**
   - `001_roles_permissions.sql`の実行
   - ユーザーへのロール割り当て

2. **ハードコーディングの除去**
   - `frontend/src/constants/roles.ts`の定数配列を削除
   - APIから権限情報を取得する仕組みに変更

### 優先度: 高
3. **フロントエンドの権限チェック改修**
   - `authStore.ts`のhasPermission関数をAPI連携型に変更
   - 権限情報のキャッシュ実装

4. **APIルートの権限制御改修**
   - requireRoleのハードコーディング配列を除去
   - データベースベースの権限チェックに移行

### 優先度: 中
5. **権限管理画面の実装**
   - 管理者が権限を動的に管理できるUI
   - 役割の追加・編集・削除機能

6. **監査ログの実装**
   - 権限変更の履歴記録
   - 誰がいつ権限を変更したかの追跡

## 推定作業時間
- 最小限の修正（データ投入+基本的な連携）: 2-3日
- 完全な移行（ハードコーディング除去）: 1週間
- 権限管理画面含む完全実装: 2週間

## リスク
1. **既存機能への影響**: 現在動作している認証機能が停止する可能性
2. **パフォーマンス**: データベースアクセス増加による遅延
3. **移行期間の混乱**: 新旧権限管理の混在期間の管理

## 結論
現在の権限管理システムは本番環境での運用に耐えられない状態です。最低限、データベースへの初期データ投入とハードコーディングの除去を行わない限り、本番リリースは推奨できません。