# 全権限管理 実装計画書

## 作成日
2025年1月24日

## エグゼクティブサマリー

### 現状の最重要課題
1. **user_rolesテーブルが完全に空** - ユーザーに一切のロールが割り当てられていない
2. **フロントエンド/バックエンドの権限がハードコーディング** - 運用中の権限変更が不可能
3. **データベース構造は完璧だが未使用** - roles、permissions、role_permissionsは全てデータ投入済み

### 本番リリースまでの必要期間
- **最短**: 3日（緊急対応のみ）
- **推奨**: 2週間（完全な移行）
- **理想**: 1ヶ月（権限管理画面含む）

---

## 第1部: 緊急対応フェーズ（3日間）

### Day 0: 即座に実施（30分）

#### 🔴 最優先: user_rolesテーブルへのデータ投入

**実行スクリプト**: `緊急_user_roles投入スクリプト.sql`

```bash
# 実行コマンド
docker exec -i skillsheet-postgres psql -U skillsheet -d skillsheet_dev < 緊急_user_roles投入スクリプト.sql
```

**投入内容**:
- ユーザーID:1 (admin@example-ses.local) → adminロール
- ユーザーID:2 (user@example-ses.local) → salesロール
- ユーザーID:3 (admin@example-client.local) → client_adminロール

**確認項目**:
```sql
-- 投入結果確認
SELECT u.name, r.name as role FROM user_roles ur
JOIN users u ON ur."userId" = u.id
JOIN roles r ON ur."roleId" = r.id;
```

### Day 1: バックエンド動作確認

#### 1.1 AuthServiceの動作確認（既に正しく実装済み）

```typescript
// テスト実行
npm run test:auth

// 確認ポイント
- getUserRoles() が正しくロールを返すか
- getUserPermissions() が権限配列を返すか
- hasPermission() が適切に判定するか
```

#### 1.2 ログインAPIの確認

```bash
# ログインテスト
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@example-ses.local","password":"password"}'

# レスポンスに roles と permissions が含まれることを確認
```

#### 1.3 権限チェックミドルウェアの動作確認

```typescript
// backend/src/middleware/permissionMiddleware.ts
// requirePermission() の動作確認
// データベースから権限を取得していることを確認
```

### Day 2: フロントエンド暫定対応

#### 2.1 権限情報取得フックの作成

```typescript
// frontend/src/hooks/usePermissions.ts
import { useQuery } from '@tanstack/react-query';
import { authApi } from '@/services/api';

export const usePermissions = () => {
  return useQuery({
    queryKey: ['permissions'],
    queryFn: async () => {
      const response = await authApi.get('/auth/permissions');
      return response.data;
    },
    staleTime: 5 * 60 * 1000, // 5分間キャッシュ
  });
};
```

#### 2.2 authStoreの暫定修正

```typescript
// frontend/src/stores/authStore.ts
// hasPermission関数の修正
hasPermission: (resource: string, action: string) => {
  const { user } = get();
  if (!user) return false;
  
  // データベースから取得した権限で判定
  const permission = `${resource}:${action}`;
  return user.permissions?.some(p => 
    p.name === permission || p === permission
  ) || false;
}
```

### Day 3: 動作テストと本番準備

#### 3.1 統合テスト実施

- [ ] 管理者ログイン → 全機能アクセス確認
- [ ] 営業ログイン → 営業機能のみアクセス確認
- [ ] エンジニアログイン → 自分のデータのみ編集確認
- [ ] 権限なしユーザー → アクセス拒否確認

#### 3.2 本番環境用スクリプト準備

```sql
-- production_user_roles.sql
-- 本番ユーザーへのロール割り当てスクリプト
-- 実際のユーザーIDとメールアドレスに基づいて作成
```

---

## 第2部: 完全移行フェーズ（2週間）

### Week 1: ハードコーディング完全除去

#### フロントエンド改修（3日間）

##### Day 1-2: 権限サービス層の実装

```typescript
// frontend/src/services/permissionService.ts
class PermissionService {
  private cache: Map<string, Permission[]> = new Map();
  
  async getRoles(): Promise<Role[]> {
    // APIから動的に取得
  }
  
  async getPermissions(): Promise<Permission[]> {
    // APIから動的に取得
  }
  
  async getUserPermissions(userId: string): Promise<Permission[]> {
    // キャッシュまたはAPIから取得
  }
  
  hasPermission(user: User, resource: string, action: string, scope?: string): boolean {
    // スコープ対応の権限チェック
  }
}
```

##### Day 3: コンポーネント改修

**対象ファイル**:
- `frontend/src/constants/roles.ts` → 完全削除
- `frontend/src/components/guards/AuthGuard.tsx` → 動的権限チェック
- `frontend/src/pages/**/*.tsx` → ハードコーディング除去

**改修例**:
```typescript
// Before (ハードコーディング)
if (user.role === 'admin' || user.role === 'sales') {
  // ...
}

// After (動的チェック)
if (await permissionService.hasPermission(user, 'engineer', 'create')) {
  // ...
}
```

#### バックエンド改修（3日間）

##### Day 4-5: APIルート改修

**対象ファイル（全て改修）**:
- `backend/src/routes/clientUserRoutes.ts`
- `backend/src/routes/businessPartnerRoutes.ts`
- `backend/src/routes/engineerRoutes.ts`
- `backend/src/routes/authRoutes.ts`
- その他全ルートファイル

**改修内容**:
```typescript
// Before
router.post('/create',
  requireRole(['admin', 'sales']), // ハードコーディング
  controller.create
);

// After
router.post('/create',
  requirePermission('engineer', 'create'), // 動的権限チェック
  controller.create
);
```

##### Day 6: 権限API実装

```typescript
// backend/src/routes/permissionRoutes.ts
router.get('/api/permissions/matrix', async (req, res) => {
  // ロール×権限のマトリクス取得
});

router.get('/api/permissions/user/:userId', async (req, res) => {
  // ユーザーの権限一覧取得
});

router.post('/api/permissions/check', async (req, res) => {
  // 権限チェックAPI
});
```

### Week 2: 最適化とテスト

#### Day 7-8: パフォーマンス最適化

##### Redisキャッシュ実装

```typescript
// backend/src/services/cacheService.ts
class PermissionCacheService {
  private redis: Redis;
  
  async getUserPermissions(userId: string): Promise<Permission[]> {
    const cacheKey = `permissions:user:${userId}`;
    const cached = await this.redis.get(cacheKey);
    
    if (cached) {
      return JSON.parse(cached);
    }
    
    const permissions = await AuthService.getUserPermissions(userId);
    await this.redis.setex(cacheKey, 300, JSON.stringify(permissions)); // 5分キャッシュ
    
    return permissions;
  }
  
  async invalidateUserCache(userId: string): Promise<void> {
    await this.redis.del(`permissions:user:${userId}`);
  }
}
```

##### データベースインデックス最適化

```sql
-- パフォーマンス向上のためのインデックス
CREATE INDEX IF NOT EXISTS idx_user_roles_user_role ON user_roles(userId, roleId);
CREATE INDEX IF NOT EXISTS idx_role_permissions_role ON role_permissions(roleId);
CREATE INDEX IF NOT EXISTS idx_permissions_name ON permissions(name);
```

#### Day 9-11: 包括的テスト

##### テストシナリオ

1. **単体テスト** (カバレッジ80%以上)
   - AuthServiceテスト
   - PermissionMiddlewareテスト
   - フロントエンド権限フックテスト

2. **統合テスト**
   ```typescript
   // tests/integration/permissions.test.ts
   describe('Permission System', () => {
     it('管理者は全リソースにアクセス可能', async () => {
       // ...
     });
     
     it('営業は自社エンジニアのみ閲覧可能', async () => {
       // ...
     });
     
     it('エンジニアは自分のデータのみ編集可能', async () => {
       // ...
     });
   });
   ```

3. **負荷テスト**
   ```bash
   # Apache Benchでの負荷テスト
   ab -n 1000 -c 100 -H "Authorization: Bearer ${TOKEN}" \
      http://localhost:8000/api/engineers
   ```

#### Day 12-14: 本番移行準備

##### チェックリスト

- [ ] 全てのハードコーディングが除去されている
- [ ] テストカバレッジ80%以上
- [ ] パフォーマンステスト合格
- [ ] セキュリティ監査完了
- [ ] ロールバック計画準備
- [ ] 本番データ移行スクリプト準備
- [ ] 監視・アラート設定

---

## 第3部: 権限管理画面実装（2週間）※オプション

### 実装内容
1. **ロール管理画面**
   - ロールのCRUD操作
   - 権限の割り当て/解除
   - ロール複製機能

2. **ユーザー管理画面**
   - ユーザーへのロール割り当て
   - 複数ロール対応
   - 権限の一時付与/取り消し

3. **権限マトリクス画面**
   - ロール×権限の可視化
   - 一括編集機能
   - エクスポート機能（Excel/CSV）

4. **監査ログ画面**
   - 権限変更履歴
   - アクセスログ
   - 異常検知アラート

---

## リスク管理

### 主要リスクと対策

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| user_rolesデータ投入ミス | 高 | 低 | バックアップ取得、ロールバックスクリプト準備 |
| ハードコーディング除去漏れ | 中 | 中 | 静的解析ツール使用、コードレビュー徹底 |
| パフォーマンス劣化 | 中 | 低 | Redisキャッシュ、インデックス最適化 |
| 権限設定ミス | 高 | 低 | 権限マトリクステスト、ステージング環境での検証 |

### ロールバック計画

```bash
# Phase 1 ロールバック（データのみ）
docker exec skillsheet-postgres psql -U skillsheet -d skillsheet_dev \
  -c "DELETE FROM user_roles WHERE \"createdAt\" >= '2025-01-24';"

# Phase 2 ロールバック（コード）
git revert --no-commit HEAD~5..HEAD
git commit -m "Revert: 権限管理システム変更をロールバック"

# 緊急時の権限無効化
UPDATE users SET isActive = false WHERE id IN (SELECT userId FROM user_roles);
```

---

## 成功指標（KPI）

### 技術的指標
- [ ] user_rolesテーブルに全ユーザーのロールが設定されている
- [ ] ハードコーディングが0件
- [ ] テストカバレッジ80%以上
- [ ] API応答時間が既存の110%以内
- [ ] エラー率が0.1%未満

### ビジネス指標
- [ ] 権限変更にかかる時間: 5分以内（コード修正不要）
- [ ] 権限関連のインシデント: 0件
- [ ] 管理者の権限管理作業時間: 50%削減

---

## 実装スケジュール

### タイムライン

```
Week 1: 緊急対応
├─ Day 0: user_rolesデータ投入 [30分]
├─ Day 1: バックエンド動作確認
├─ Day 2: フロントエンド暫定対応
└─ Day 3: テストと本番準備

Week 2-3: 完全移行
├─ Day 4-6: フロントエンドハードコーディング除去
├─ Day 7-9: バックエンドハードコーディング除去
├─ Day 10-11: パフォーマンス最適化
└─ Day 12-14: 包括的テストと本番準備

Week 4-5: 権限管理画面（オプション）
├─ Day 15-17: UI/UX設計
├─ Day 18-22: フロントエンド実装
├─ Day 23-25: バックエンドAPI実装
└─ Day 26-28: 統合テストとリリース
```

---

## 必要リソース

### 人員
- **必須**
  - バックエンド開発者: 1名
  - フロントエンド開発者: 1名
  - テスター: 1名

- **推奨**
  - プロジェクトマネージャー: 1名
  - セキュリティエンジニア: 1名（監査用）

### インフラ
- 開発環境（既存）
- ステージング環境（既存）
- Redis（キャッシュ用）
- 監視ツール（Datadog/NewRelic等）

### 予算
- 開発工数: 約120人時（3名×2週間×8時間×5日）
- インフラ追加費用: 月額$50（Redis）
- 監視ツール: 月額$100

---

## 最終チェックリスト

### 本番リリース前確認

#### データベース
- [ ] user_rolesテーブルにデータが投入されている
- [ ] 全ユーザーに適切なロールが割り当てられている
- [ ] 権限マッピングが正しく設定されている
- [ ] バックアップが取得されている

#### コード
- [ ] ハードコーディングが完全に除去されている
- [ ] テストが全て合格している
- [ ] コードレビューが完了している
- [ ] セキュリティ監査が完了している

#### 運用
- [ ] ロールバック手順が準備されている
- [ ] 監視アラートが設定されている
- [ ] ドキュメントが更新されている
- [ ] 運用チームへの引き継ぎが完了している

---

## 結論

本計画書に従って実装を進めることで、以下が実現されます：

1. **即座の問題解決**: user_rolesテーブルへのデータ投入により、30分で基本的な権限管理が動作開始
2. **完全な移行**: 2週間でハードコーディングを完全除去し、動的な権限管理システムへ移行
3. **将来の拡張性**: 権限管理画面により、コード変更なしで権限設定が可能に

**最も重要な次のアクション**: 
`緊急_user_roles投入スクリプト.sql`を今すぐ実行してください。これだけで権限管理システムが動作を開始します。