# フェーズ1: 最小限の修正（2-3日）

## 目的
本番リリースに最低限必要な権限管理の修正を行い、ハードコーディングされた権限をデータベースベースに移行する。

## タスク一覧

### 1. データベース初期データ投入（Day 1）

#### 1.1 初期データ投入スクリプトの実行準備
- [ ] `backend/prisma/seeds/001_roles_permissions.sql`の内容確認
- [ ] 既存データのバックアップ取得
- [ ] 開発環境でのテスト実行計画作成

#### 1.2 ロールデータの投入
- [ ] rolesテーブルへの基本ロール投入
  - admin（管理者）
  - manager（マネージャー）
  - sales（営業）
  - engineer（エンジニア）
  - client_admin（取引先管理者）
  - client_sales（取引先営業）
  - client_pm（取引先PM）
- [ ] データ投入後の確認クエリ実行

#### 1.3 権限データの投入
- [ ] permissionsテーブルへの権限データ投入
  - ユーザー管理権限（5種類）
  - エンジニア管理権限（5種類）
  - スキルシート管理権限（5種類）
  - プロジェクト管理権限（5種類）
  - 取引先管理権限（5種類）
  - アプローチ管理権限（5種類）
  - オファー管理権限（5種類）
  - レポート管理権限（3種類）
  - 設定管理権限（3種類）
- [ ] データ投入後の確認クエリ実行

#### 1.4 ロール権限紐付けデータの投入
- [ ] role_permissionsテーブルへのマッピングデータ投入
- [ ] 各ロールの権限設定確認
  - admin: 全権限
  - manager: ユーザー管理・プロジェクト管理権限
  - sales: 取引先管理・エンジニア閲覧権限
  - engineer: 自身のスキルシート管理権限
  - その他ロールの権限設定
- [ ] 権限マッピングの整合性確認

#### 1.5 既存ユーザーへのロール割り当て
- [ ] 既存ユーザーの確認
- [ ] user_rolesテーブルへのデータ投入
- [ ] 管理者ユーザーへのadminロール付与
- [ ] 営業ユーザーへのsalesロール付与
- [ ] エンジニアユーザーへのengineerロール付与
- [ ] ロール割り当て後の動作確認

### 2. バックエンド基本連携実装（Day 2）

#### 2.1 AuthServiceの改修
- [ ] getUserPermissionsメソッドの動作確認
- [ ] hasPermissionメソッドの動作確認
- [ ] getUserRolesメソッドの実装確認
- [ ] キャッシュ機構の検討（Redis利用）

#### 2.2 ログイン処理の改修
- [ ] ログイン時の権限情報取得処理追加
- [ ] JWTトークンへの権限情報埋め込み
- [ ] トークンサイズの確認と最適化
- [ ] ログイン後の権限情報確認API実装

#### 2.3 権限チェックミドルウェアの修正
- [ ] requirePermissionミドルウェアのDB連携確認
- [ ] requireRoleミドルウェアのDB連携実装
- [ ] エラーハンドリングの改善
- [ ] ログ出力の追加

#### 2.4 セッション管理の改修
- [ ] 権限情報のセッションキャッシュ実装
- [ ] 権限変更時のセッション無効化処理
- [ ] リフレッシュトークン使用時の権限再取得

### 3. 動作確認とテスト（Day 3）

#### 3.1 単体テスト
- [ ] AuthServiceのテスト作成
  - getUserPermissionsのテスト
  - hasPermissionのテスト
  - getUserRolesのテスト
- [ ] ミドルウェアのテスト作成
  - requirePermissionのテスト
  - requireRoleのテスト
- [ ] テストカバレッジの確認（目標80%以上）

#### 3.2 統合テスト
- [ ] ログイン→権限取得フローのテスト
- [ ] 各APIエンドポイントの権限制御テスト
  - ユーザー管理API
  - エンジニア管理API
  - スキルシート管理API
  - 取引先管理API
- [ ] 権限不足時のエラーレスポンス確認

#### 3.3 パフォーマンステスト
- [ ] 権限チェックによる応答時間の計測
- [ ] データベースクエリの最適化
- [ ] N+1問題の確認と解消
- [ ] キャッシュ効果の測定

#### 3.4 セキュリティテスト
- [ ] 権限昇格攻撃のテスト
- [ ] トークン改ざんのテスト
- [ ] SQLインジェクションのテスト
- [ ] 権限バイパスのテスト

## 成功基準
- [ ] すべての既存ユーザーに適切なロールが割り当てられている
- [ ] APIエンドポイントがデータベースベースの権限チェックを行っている
- [ ] テストカバレッジが80%以上
- [ ] パフォーマンスが既存システムと同等以上
- [ ] セキュリティテストに合格

## リスクと対策

### リスク1: 既存機能の停止
- **対策**: フィーチャーフラグによる段階的切り替え
- **ロールバック計画**: 旧権限システムへの即座の切り戻し手順

### リスク2: パフォーマンス低下
- **対策**: Redisキャッシュの実装
- **監視**: APMツールによる応答時間モニタリング

### リスク3: 権限設定ミス
- **対策**: 本番投入前の権限マトリクステスト
- **確認**: 各ロールの権限一覧表作成と承認

## 必要なリソース
- 開発者: 2名
- テスター: 1名
- 開発環境
- ステージング環境
- Redisサーバー（キャッシュ用）

## 完了条件
- [ ] データベースに権限データが正しく投入されている
- [ ] バックエンドがデータベースから権限を取得している
- [ ] すべてのテストが合格
- [ ] ドキュメントが更新されている