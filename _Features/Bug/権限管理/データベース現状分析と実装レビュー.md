# 権限管理システム データベース現状分析と実装レビュー

## 調査日時
2025年1月24日

## データベースの現状

### 1. テーブル状態の確認結果

#### ✅ データが存在するテーブル
| テーブル名 | レコード数 | 状態 |
|------------|------------|------|
| roles | 10件 | super_admin、admin、sales、engineer等のロール定義済み |
| permissions | 82件 | リソース・アクション・スコープ別の詳細な権限定義済み |
| role_permissions | 224件 | ロールと権限のマッピング定義済み |

#### ❌ データが存在しないテーブル
| テーブル名 | レコード数 | 問題点 |
|------------|------------|--------|
| user_roles | 0件 | **ユーザーにロールが一切割り当てられていない** |
| admin_roles | 不明 | 管理者ロール未使用 |
| admin_user_roles | 不明 | 管理者ロール割り当て未使用 |

### 2. 具体的なデータ内容

#### rolesテーブルの内容
```
- super_admin   : スーパー管理者
- general_admin : 一般管理者
- operator      : オペレーター
- admin         : 管理者（SES企業）
- manager       : マネージャー
- sales         : 営業
- engineer      : エンジニア
- client_admin  : 取引先管理者
- client_sales  : 取引先営業
- client_pm     : 取引先PM
```

#### permissionsテーブルの内容（スコープ対応済み）
```
例：user:view:all     - 全てのユーザー閲覧権限
    user:view:company - 自社のユーザー閲覧権限
    user:view:own     - 自分のユーザー閲覧権限
```

#### role_permissionsの内容（adminロールの例）
```
admin ロールの権限:
- user:view:company      (自社ユーザー閲覧)
- user:create            (ユーザー作成)
- user:update:company    (自社ユーザー更新)
- engineer:view:company  (自社エンジニア閲覧)
- engineer:create        (エンジニア作成)
等、company スコープの権限が適切に設定されている
```

## 重大な問題点

### 🔴 最重要: user_rolesテーブルが空
**影響**: 
- どのユーザーもロールを持っていない
- 権限チェックが機能しない
- `AuthService.getUserRoles()`が常に空配列を返す

**現在の実装での挙動**:
```typescript
// AuthService.getUserById() の問題箇所
const roles = await this.getUserRoles(userId); // 常に空配列
return {
  // ...
  role: roles[0] || 'engineer', // 常に'engineer'になる
  roles, // 常に空配列
  // ...
};
```

### 🟡 中程度: usersテーブルにtypeカラムがない
**影響**:
- ユーザーの種別（admin/sales/engineer）が判別できない
- 初期ロール割り当ての自動化が困難

## 実装の問題点

### 1. AuthServiceの実装は正しいが、データがない
```typescript
// この実装自体は正しい
static async getUserPermissions(userId: string): Promise<string[]> {
  const userWithRoles = await prisma.users.findUnique({
    where: { id: BigInt(userId) },
    include: {
      user_roles: { // ← ここが0件なので権限が取得できない
        include: {
          roles: {
            include: {
              role_permissions: {
                include: {
                  permissions: true
                }
              }
            }
          }
        }
      }
    }
  });
  // ...
}
```

### 2. フロントエンドのハードコーディング問題は別途存在
- `frontend/src/constants/roles.ts`のハードコーディング
- APIルートでの`requireRole(['admin', 'sales'])`のハードコーディング

## 緊急対応が必要な作業

### 1. 即座に実施すべきこと（30分で完了可能）

#### user_rolesテーブルへのデータ投入
```sql
-- 管理者ユーザーにadminロールを付与
INSERT INTO user_roles ("userId", "roleId", "grantedBy", "createdAt")
SELECT 1, r.id, 1, NOW()
FROM roles r
WHERE r.name = 'admin';

-- 既存ユーザーへの適切なロール割り当て
-- ID:1 (admin@example-ses.local) → admin ロール
-- ID:2 (user@example-ses.local) → sales または engineer ロール
-- ID:3 (admin@example-client.local) → client_admin ロール
```

### 2. データ投入後の確認項目
- [ ] user_rolesテーブルにデータが入ったか確認
- [ ] AuthService.getUserRoles()が正しくロールを返すか確認
- [ ] AuthService.getUserPermissions()が権限を返すか確認
- [ ] ログイン時にロール・権限情報が取得できるか確認

## 正しい実装のための修正順序

### フェーズ1: データベースの正常化（即座に実施）
1. **user_rolesテーブルへのデータ投入スクリプト作成**
   ```sql
   -- 管理者ユーザー設定
   INSERT INTO user_roles ("userId", "roleId", "grantedBy", "createdAt")
   VALUES (1, (SELECT id FROM roles WHERE name = 'admin'), 1, NOW());
   
   -- 一般ユーザー設定
   INSERT INTO user_roles ("userId", "roleId", "grantedBy", "createdAt")
   VALUES (2, (SELECT id FROM roles WHERE name = 'sales'), 1, NOW());
   
   -- クライアントユーザー設定
   INSERT INTO user_roles ("userId", "roleId", "grantedBy", "createdAt")
   VALUES (3, (SELECT id FROM roles WHERE name = 'client_admin'), 1, NOW());
   ```

2. **データ投入の実行と確認**

### フェーズ2: バックエンドの動作確認（データ投入後即座に可能）
1. **既存のAuthServiceは正しく実装されている**
   - getUserPermissions()メソッドは正しい
   - hasPermission()メソッドは正しい
   - データがあれば動作する

2. **動作確認項目**
   - ログインAPI経由での権限取得
   - requirePermissionミドルウェアの動作
   - APIエンドポイントの権限制御

### フェーズ3: フロントエンドのハードコーディング除去
1. **権限取得APIの活用**
2. **定数ファイルの動的化**
3. **コンポーネントの修正**

## 結論

### 現状評価
- **データベース構造**: ✅ 完璧に設計されている
- **権限データ**: ✅ 適切に定義されている
- **バックエンド実装**: ✅ 正しく実装されている
- **ユーザーロール割り当て**: ❌ **完全に欠落している**
- **フロントエンド**: ⚠️ ハードコーディングあり

### 最優先事項
**user_rolesテーブルへのデータ投入が最優先**
- 30分で解決可能
- データ投入すれば既存実装が動作する
- ハードコーディング問題は別途対応

### 推奨アクション
1. 今すぐuser_rolesテーブルにデータ投入
2. 動作確認
3. 本番環境用の初期データ投入スクリプト準備
4. フロントエンドのハードコーディング除去（次フェーズ）