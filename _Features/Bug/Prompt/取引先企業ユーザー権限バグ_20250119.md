# AIが誤解しない粒度で回答してください

## 問題の概要
React + TypeScript + Zustand で構築された SES スキル管理システムにおいて、取引先企業ユーザーが権限不足で `/unauthorized` ページに遷移した際、「ホームに戻る」ボタンを押すと、本来アクセスできないはずの SES 企業の管理画面（`/dashboard`）に遷移してしまう重大なセキュリティバグが発生しています。

## 現在のシステム構成

### 1. ユーザータイプ
- **SES企業ユーザー** (`userType: undefined` または `userType: 'ses'`)
  - 管理者（admin）
  - 営業（sales）
  - エンジニア（engineer）
- **取引先企業ユーザー** (`userType: 'client'`)
  - 取引先管理者（client_admin）
  - 取引先ユーザー（client_user）

### 2. 認証フロー
```typescript
// 取引先企業ユーザーのログイン
POST /api/client/auth/login → JWTトークン（userType: 'client'を含む）

// SES企業ユーザーのログイン
POST /api/auth/login → JWTトークン（userTypeなし または 'ses'）
```

### 3. 現在の問題のあるコード

#### /frontend/src/pages/Unauthorized.tsx
```typescript
const handleGoHome = () => {
  if (isClientUser()) {
    navigate('/client/offer-board');
  } else {
    navigate('/dashboard'); // ← ここで取引先企業ユーザーもSES管理画面に遷移してしまう
  }
};
```

#### /frontend/src/stores/authStore.ts
```typescript
isClientUser: () => {
  const { user } = get();
  if (!user) return false;
  return user.userType === 'client' || 
         (Array.isArray(user.roles) && (user.roles.includes('client_admin') || user.roles.includes('client_user')));
}
```

## 発生している問題の詳細

1. **現象**
   - 取引先企業ユーザー（admin@client-a.co.jp）でログイン
   - 権限のないページにアクセスして `/unauthorized` に遷移
   - 「ホームに戻る」ボタンを押すと `/dashboard`（SES企業管理画面）に遷移
   - 本来は `/client/offer-board`（取引先企業ダッシュボード）に遷移すべき

2. **原因の可能性**
   - `isClientUser()` が false を返している
   - `user.userType` が正しく設定されていない
   - Zustand の persist から復元した際に userType が失われている
   - JWTトークンから復元した user オブジェクトの構造が不正

## ゴール（達成すべき要件）

### 必須要件
1. **取引先企業ユーザーが `/unauthorized` ページで「ホームに戻る」を押した場合**
   - 必ず `/client/offer-board` に遷移する
   - 絶対に `/dashboard` に遷移しない

2. **SES企業ユーザーが `/unauthorized` ページで「ホームに戻る」を押した場合**
   - `/dashboard` に遷移する

3. **未認証ユーザーが `/unauthorized` ページで「ホームに戻る」を押した場合**
   - `/login` に遷移する

### セキュリティ要件
- 取引先企業ユーザーは絶対に SES 企業の管理画面（`/dashboard` 以下）にアクセスできない
- ユーザータイプの判定は確実に行われる必要がある
- フロントエンドだけでなくバックエンドでも適切なアクセス制御が必要

## 質問

1. **Zustand の persist でユーザー情報を保存する際、userType フィールドが正しく保存・復元されることを保証する方法は？**

2. **以下の判定ロジックをより堅牢にする方法は？**
```typescript
// 現在の実装
if (user?.userType === 'client') {
  // 取引先企業ユーザー
}

// より安全な実装方法は？
```

3. **JWTトークンのペイロードから確実に userType を取得し、それをベースに判定する実装方法は？**

4. **フェイルセーフとして、アクセス権限がない場合のデフォルト遷移先を設定する方法は？**
   - 取引先企業ユーザーの場合: `/client/login`
   - SES企業ユーザーの場合: `/login`
   - 不明な場合: `/` （ルートで適切にリダイレクト）

## 期待する回答

1. **根本原因の特定方法**
   - デバッグのためのログ出力箇所
   - 確認すべきデータの流れ

2. **具体的な修正コード**
   - Unauthorized.tsx の修正
   - authStore.ts の修正
   - 必要に応じて他のファイルの修正

3. **テスト方法**
   - このバグが修正されたことを確認する手順
   - 再発防止のためのテストケース

4. **追加のセキュリティ対策**
   - フロントエンドでの対策
   - バックエンドでの対策