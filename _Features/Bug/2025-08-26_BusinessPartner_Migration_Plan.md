# 取引先管理機能 段階的移行計画
**作成日**: 2025-08-26  
**優先度**: 🔴 緊急  
**状況**: 正式実装への即時切り替えが困難なため段階的移行が必要

## 現状と問題

### 発見された問題
1. **二重実装の存在**
   - 暫定実装: `/api/v1/partner-list` (ハードコーディング多数、現在稼働中)
   - 正式実装: `/api/business-partners` (設計準拠、未稼働)

2. **正式実装の問題点**
   - Prismaスキーマとの不整合
   - 認証ミドルウェアとの互換性問題
   - データ構造の違い

3. **データソースの不一致**
   - 暫定: `company`テーブル (CLIENT タイプ)
   - 正式: `business_partners`テーブル

## 段階的移行計画

### Phase 1: 緊急対応（今日中）✅ 完了
- [x] 問題の調査と文書化
- [x] 暫定実装の継続使用を決定
- [x] エンドポイントを暫定実装に戻す

### Phase 2: 正式実装の修正（1週間以内）
- [ ] Prismaスキーマの確認と更新
- [ ] businessPartnerServiceのデバッグと修正
- [ ] 認証ミドルウェアとの整合性確保
- [ ] データマイグレーションスクリプトの作成

### Phase 3: データ移行準備（2週間以内）
- [ ] `company`テーブルから`business_partners`への移行ロジック実装
- [ ] ハードコーディングデータの実データ化
- [ ] テストデータの準備
- [ ] ロールバック手順の準備

### Phase 4: 段階的切り替え（3週間以内）
- [ ] 開発環境での動作確認
- [ ] ステージング環境での検証
- [ ] 一部機能の切り替え（読み取り専用）
- [ ] 完全切り替え

### Phase 5: 暫定実装の削除（1ヶ月以内）
- [ ] 暫定実装コードの削除
- [ ] 不要ファイルのクリーンアップ
- [ ] ドキュメントの最終更新

## 技術的課題と対策

### 1. Prismaスキーマの不整合
**問題**: businessPartnerServiceが期待するフィールドが存在しない
```typescript
// Serviceが期待
contractType, monthlyFee, contactPerson

// Prismaスキーマに存在しない
```
**対策**: スキーマ拡張またはServiceの修正

### 2. データ構造の違い
**暫定実装のレスポンス**:
```json
{
  "companyName": "...",
  "contacts": [],
  "approaches": [],
  "currentEngineers": 5
}
```

**正式実装のレスポンス**:
```json
{
  "clientCompany": { "name": "..." },
  "clientUsers": [],
  "sesCompany": { "id": 1, "name": "..." }
}
```
**対策**: データ変換レイヤーの実装

### 3. ハードコーディングの除去
```typescript
// 現在
const industryMap = {
  '株式会社ABC商事': 'IT・通信',
  // ...
}

// 目標
const industry = await getIndustryFromDatabase(companyId);
```

## リスク管理

| リスク | 影響 | 対策 |
|--------|------|------|
| データ損失 | 高 | バックアップとトランザクション管理 |
| ダウンタイム | 中 | Blue-Green デプロイメント |
| パフォーマンス劣化 | 低 | 事前負荷テスト |

## 当面の対応

### 開発者への注意事項
1. **新機能追加は暫定実装に対して行わない**
2. **バグ修正は最小限に留める**
3. **ハードコーディングを増やさない**

### 利用者への影響
- 当面は現状のまま動作継続
- データの信頼性問題は継続（要周知）
- 段階的に改善予定

## 次のアクション

1. **即時対応** ✅
   - 暫定実装への切り戻し（完了）

2. **今週中**
   - Prismaスキーマの詳細調査
   - businessPartnerServiceのデバッグ

3. **来週**
   - データマイグレーション計画の詳細化
   - テスト環境の構築

## 関連ドキュメント
- [実装調査レポート](./2025-08-26_BusinessPartner_Implementation_Issue_Report.md)
- [API仕様書](/backend/docs/api/business-partners.md)
- [Prismaスキーマ](/backend/prisma/schema.prisma)

---
**最終更新**: 2025-08-26  
**担当**: ClaudeCode  
**レビュー**: 未実施