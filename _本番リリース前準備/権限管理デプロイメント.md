# 権限管理システム - 本番環境デプロイメント手順書

## 1. 事前準備チェックリスト

### 1.1 バックアップ
- [ ] データベース完全バックアップ取得
- [ ] 現在の環境変数バックアップ
- [ ] アプリケーションコードのバックアップ
- [ ] ロールバック手順の確認

### 1.2 環境確認
- [ ] 本番データベース接続確認
- [ ] Redis接続確認
- [ ] JWT_SECRET設定確認
- [ ] CORS_ORIGIN設定確認

### 1.3 テスト完了確認
- [ ] 単体テスト: PASS
- [ ] 統合テスト: PASS
- [ ] E2Eテスト: PASS
- [ ] パフォーマンステスト: PASS

## 2. デプロイメント手順

### Step 1: データベースバックアップ
```bash
# 本番環境にSSH接続
ssh production-server

# データベースバックアップ
pg_dump -U postgres -h localhost -d skillsheet_prod > backup_$(date +%Y%m%d_%H%M%S).sql

# バックアップ確認
ls -la backup_*.sql
```

### Step 2: 権限データ準備
```sql
-- 本番環境用権限データチェック
SELECT COUNT(*) as role_count FROM roles;
SELECT COUNT(*) as permission_count FROM permissions;
SELECT COUNT(*) as role_permission_count FROM role_permissions;
SELECT COUNT(*) as user_role_count FROM user_roles;

-- user_rolesが空の場合は投入スクリプト実行
-- /Users/takumi/workspace/Project/CompactSkillSheetsApp/_Features/Bug/権限管理/本番環境_user_roles投入スクリプト.sql
```

### Step 3: アプリケーションデプロイ

#### 3.1 バックエンド
```bash
# 最新コードを取得
git pull origin main

# 依存関係インストール
cd backend
npm ci

# Prismaマイグレーション実行
npx prisma migrate deploy

# ビルド
npm run build

# 環境変数確認
cat .env.production

# PM2でアプリケーション再起動
pm2 reload backend --update-env
```

#### 3.2 フロントエンド
```bash
# フロントエンドビルド
cd frontend
npm ci
npm run build

# 静的ファイルデプロイ
rsync -avz dist/ /var/www/html/

# Nginxリロード
nginx -t && nginx -s reload
```

### Step 4: ヘルスチェック
```bash
# APIヘルスチェック
curl https://api.production.com/health

# 権限APIチェック
curl -X POST https://api.production.com/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@production.com", "password": "***"}'

# 権限取得テスト
TOKEN="<上記で取得したトークン>"
curl https://api.production.com/api/auth/permissions \
  -H "Authorization: Bearer $TOKEN"
```

### Step 5: モニタリング設定
```bash
# ログ監視開始
tail -f /var/log/backend/app.log

# エラー率監視
grep ERROR /var/log/backend/app.log | wc -l

# レスポンスタイム監視
# Datadogまたは類似のモニタリングツールで確認
```

## 3. 段階的ロールアウト

### Phase 1: カナリアデプロイ（10%）
```yaml
# kubernetes/deployment.yaml
spec:
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
```

```bash
# 10%のトラフィックを新バージョンへ
kubectl set image deployment/backend backend=backend:v2.0.0-permissions
kubectl rollout status deployment/backend
```

### Phase 2: 50%展開
```bash
# 問題がなければ50%へ拡大
kubectl scale deployment/backend-v2 --replicas=5
kubectl scale deployment/backend-v1 --replicas=5
```

### Phase 3: 完全展開
```bash
# 全トラフィックを新バージョンへ
kubectl scale deployment/backend-v2 --replicas=10
kubectl scale deployment/backend-v1 --replicas=0
```

## 4. ロールバック手順

### 即座のロールバック
```bash
# Kubernetesの場合
kubectl rollout undo deployment/backend

# PM2の場合
pm2 reload backend --rollback

# データベースロールバック（必要な場合）
psql -U postgres -d skillsheet_prod < backup_20250824_120000.sql
```

### 部分的ロールバック
```sql
-- user_rolesデータのみロールバック
DELETE FROM user_roles WHERE "createdAt" > '2025-08-24 00:00:00';
```

## 5. 検証項目

### 5.1 機能検証
- [ ] 管理者ログイン: OK
- [ ] 営業ユーザーログイン: OK
- [ ] クライアントログイン: OK
- [ ] 権限取得API: OK
- [ ] 権限チェックAPI: OK
- [ ] エンジニア作成（営業）: OK
- [ ] エンジニア削除（管理者のみ）: OK

### 5.2 パフォーマンス検証
- [ ] APIレスポンス < 100ms
- [ ] Redisキャッシュヒット率 > 90%
- [ ] エラー率 < 0.1%
- [ ] 同時接続数: 問題なし

### 5.3 セキュリティ検証
- [ ] 不正なトークンでのアクセス: 拒否
- [ ] 権限外のリソースアクセス: 拒否
- [ ] SQLインジェクション対策: OK
- [ ] XSS対策: OK

## 6. トラブルシューティング

### 問題: 権限取得APIが500エラー
```bash
# ログ確認
docker logs backend --tail 100

# Prismaクライアント再生成
npx prisma generate
pm2 restart backend
```

### 問題: Redisキャッシュが効かない
```bash
# Redis接続確認
redis-cli ping

# Redis再起動
systemctl restart redis
```

### 問題: user_rolesデータ不整合
```sql
-- 不整合データ確認
SELECT u.email, r.name 
FROM user_roles ur
JOIN users u ON ur."userId" = u.id
JOIN roles r ON ur."roleId" = r.id
WHERE ur."createdAt" > '2025-08-24';

-- 必要に応じて修正
UPDATE user_roles SET "roleId" = (SELECT id FROM roles WHERE name = 'sales')
WHERE "userId" IN (SELECT id FROM users WHERE email LIKE '%@sales%');
```

## 7. 連絡体制

### エスカレーション
1. **Level 1**: 開発チーム（Slack: #dev-team）
2. **Level 2**: テックリード（緊急電話: xxx-xxxx-xxxx）
3. **Level 3**: CTO（緊急電話: xxx-xxxx-xxxx）

### 監視アラート
- Datadog: [https://app.datadoghq.com/dashboard/permissions](https://app.datadoghq.com/dashboard/permissions)
- PagerDuty: permissions-alert@company.com

## 8. デプロイ後の作業

### 8.1 ドキュメント更新
- [ ] APIドキュメント更新
- [ ] 運用手順書更新
- [ ] 権限一覧表更新

### 8.2 ユーザー通知
- [ ] 管理者向けアナウンス
- [ ] 営業チーム向け説明
- [ ] クライアント向け通知（必要な場合）

### 8.3 フォローアップ
- [ ] 1日後: パフォーマンスレビュー
- [ ] 3日後: エラー率分析
- [ ] 1週間後: 総合評価レポート

## 9. 承認

- [ ] 開発チームリード承認
- [ ] QAチーム承認
- [ ] セキュリティチーム承認
- [ ] 運用チーム承認
- [ ] 最終承認（CTO）

## 10. デプロイ実施記録

| 項目 | 内容 |
|-----|------|
| 実施日時 | 2025-08-__ __:__ |
| 実施者 | |
| バージョン | v2.0.0-permissions |
| 結果 | □成功 □失敗 □ロールバック |
| 備考 | |

---

このドキュメントは権限管理システムの本番環境デプロイメント時に使用する公式手順書です。
全てのチェック項目を確認し、承認を得てから実施してください。