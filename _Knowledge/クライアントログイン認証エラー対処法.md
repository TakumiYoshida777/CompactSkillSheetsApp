# クライアント（取引先）ログイン認証エラー対処法

## 問題の概要
- **症状**: クライアント用ログイン画面（http://localhost:3000/client/login）でログイン時に401エラーが発生
- **エラーメッセージ**: 
  - `POST http://localhost:8000/api/client/auth/login 401 (Unauthorized)`
  - クライアントユーザーが存在しないため認証に失敗

## 原因
1. **ユーザーが存在しない**: データベースの`client_users`テーブルにログイン用のクライアントユーザーが登録されていない
2. **パスワードハッシュの不一致**: 保存されているパスワードハッシュが正しくない
3. **ビジネスパートナー情報の不足**: 関連するビジネスパートナーのレコードが存在しない

## 解決手順

### 1. データベースのクライアントユーザー確認
```bash
# client_usersテーブルでユーザーの存在を確認
docker exec skillsheet-postgres psql -U skillsheet -d skillsheet_dev -c "SELECT id, email, name FROM client_users WHERE email = 'admin@example-client.local';"
```

### 2. ビジネスパートナーの確認
```bash
# business_partnersテーブルのIDを確認（クライアントユーザー作成時に必要）
docker exec skillsheet-postgres psql -U skillsheet -d skillsheet_dev -c "SELECT id FROM business_partners LIMIT 1;"
```

### 3. パスワードハッシュの生成
```bash
# Admin123!のパスワードハッシュを生成
node -e "const bcrypt = require('bcrypt'); bcrypt.hash('Admin123!', 10).then(h => console.log(h));"
```

### 4. クライアントユーザーの作成
```bash
# client_usersテーブルにユーザーを挿入
docker exec skillsheet-postgres psql -U skillsheet -d skillsheet_dev -c "INSERT INTO client_users (\"businessPartnerId\", email, \"passwordHash\", name, \"isActive\", \"createdAt\", \"updatedAt\") VALUES (2, 'admin@example-client.local', '\$2b\$10\$i6tPIXLg.8VqT7GonbODju5hufDg6fPUmtvf.dYaRzNO4zKJN.3VK', 'クライアント管理者', true, NOW(), NOW()) ON CONFLICT DO NOTHING RETURNING id, email;"
```

注意: businessPartnerIdの値（上記では2）は、実際のbusiness_partnersテーブルの有効なIDに置き換える必要があります。

### 5. ログイン動作確認
```bash
# JSONファイル経由でテスト（特殊文字を含むパスワードのエスケープ問題を回避）
cat > /tmp/client_login.json << 'EOF'
{
  "email": "admin@example-client.local",
  "password": "Admin123!",
  "rememberMe": false
}
EOF
curl -X POST http://localhost:8000/api/client/auth/login \
  -H "Content-Type: application/json" \
  -d @/tmp/client_login.json
```

## テスト用アカウント情報
- **メールアドレス**: admin@example-client.local
- **パスワード**: Admin123!

## データベース構造の詳細

### client_usersテーブルの主要カラム
- `id`: プライマリキー
- `businessPartnerId`: 関連するビジネスパートナーのID（外部キー）
- `email`: ログイン用メールアドレス
- `passwordHash`: bcryptでハッシュ化されたパスワード
- `name`: ユーザー名
- `isActive`: アクティブ状態（boolean）
- `department`: 部署（オプション）
- `position`: 役職（オプション）

### 関連テーブル
- `business_partners`: 取引先企業情報
- `client_user_roles`: クライアントユーザーのロール
- `client_access_permissions`: アクセス権限

## 注意事項
1. **パスワードの特殊文字**
   - curlでJSONを直接送信する際、特殊文字（!など）のエスケープに注意
   - ファイル経由でJSONを送信する方法が確実

2. **bcryptのsaltラウンド**
   - パスワードハッシュ生成時は10ラウンドを使用
   - SQLに挿入する際は`$`を`\$`でエスケープする

3. **businessPartnerIdの確認**
   - クライアントユーザー作成前に有効なbusinessPartnerIdの確認が必要
   - 存在しないIDを使用すると外部キー制約エラーになる

## エラーログの確認方法
```bash
# バックエンドログの確認
docker logs compactskillsheetsapp-backend-1 --tail 50

# PostgreSQLログの確認（必要に応じて）
docker logs skillsheet-postgres --tail 50
```

## 関連ファイル
- クライアント認証サービス: `/backend/src/services/clientAuthService.ts`
- クライアント認証コントローラー: `/backend/src/controllers/clientAuthController.ts`
- クライアントルーター: `/backend/src/routes/clientAuthRoutes.ts`

## 最終更新日
2025年8月26日