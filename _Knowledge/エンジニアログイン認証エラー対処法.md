# エンジニアログイン認証エラー対処法

## 問題の概要
- **症状**: エンジニア用ログイン画面（http://localhost:3000/engineer/login）でログイン時に500エラーまたはNetwork Errorが発生
- **エラーメッセージ**: 
  - `POST http://localhost:8000/api/auth/login 500 (Internal Server Error)`
  - `POST http://localhost:8000/api/auth/login net::ERR_EMPTY_RESPONSE`
  - `UnauthorizedError: メールアドレスまたはパスワードが正しくありません`

## 原因
1. **ユーザーが存在しない**: データベースにログイン用のエンジニアユーザーが登録されていない
2. **パスワードハッシュの不一致**: 保存されているパスワードハッシュが正しくない
3. **サーバーの停止/再起動**: バックエンドサーバーがクラッシュまたは再起動中

## 解決手順

### 1. バックエンドサーバーの状態確認
```bash
# Dockerコンテナの稼働状況を確認
docker ps | grep backend

# バックエンドログを確認
docker logs compactskillsheetsapp-backend-1 --tail 50
```

### 2. データベースのユーザー確認
```bash
# ユーザーの存在を確認
docker exec skillsheet-postgres psql -U skillsheet -d skillsheet_dev -c "SELECT id, email FROM users WHERE email = 'engineer@demo.example.com';"
```

### 3. ユーザーが存在しない場合の作成
```bash
# パスワードハッシュを生成（password123の例）
cd /Users/takumi/workspace/Project/CompactSkillSheetsApp/backend
node -e "const bcrypt = require('bcrypt'); bcrypt.hash('password123', 10).then(h => console.log(h));"

# ユーザーをデータベースに挿入
docker exec skillsheet-postgres psql -U skillsheet -d skillsheet_dev -c "INSERT INTO users (email, \"passwordHash\", name, \"companyId\", \"isActive\", \"createdAt\", \"updatedAt\", \"passwordChangedAt\") VALUES ('engineer@demo.example.com', '\$2b\$10\$Yj2JLwh2q4ex9DEbAbMkeOTOFdUOuNifkT/BSnfvMpAwRtxdCK4.K', 'デモエンジニア', (SELECT id FROM companies WHERE \"emailDomain\" = 'example-ses.local' LIMIT 1), true, NOW(), NOW(), NOW()) ON CONFLICT (email) DO NOTHING;"
```

### 4. パスワードハッシュの更新（既存ユーザーの場合）
```bash
# 新しいパスワードハッシュで更新
docker exec skillsheet-postgres psql -U skillsheet -d skillsheet_dev -c "UPDATE users SET \"passwordHash\" = '\$2b\$10\$Yj2JLwh2q4ex9DEbAbMkeOTOFdUOuNifkT/BSnfvMpAwRtxdCK4.K' WHERE email = 'engineer@demo.example.com';"
```

### 5. バックエンドサーバーの再起動
```bash
# コンテナを再起動
docker restart compactskillsheetsapp-backend-1

# 起動確認（5秒待機後）
sleep 5 && docker logs compactskillsheetsapp-backend-1 --tail 20
```

### 6. ログイン動作確認
```bash
# curlでテスト
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"engineer@demo.example.com","password":"password123","rememberMe":true}'
```

## テスト用アカウント情報
- **メールアドレス**: engineer@demo.example.com
- **パスワード**: password123

## 注意事項
1. **データベース接続情報**
   - データベース名: skillsheet_dev
   - ユーザー名: skillsheet
   - テーブル: users（カラム名は大文字小文字が混在しているため注意）

2. **パスワードハッシュ**
   - bcryptを使用（saltラウンド: 10）
   - SQLに挿入する際は`$`をエスケープする必要がある（`\$`）

3. **関連ファイル**
   - 認証サービス: `/backend/src/services/authService.ts`
   - 認証コントローラー: `/backend/src/controllers/authController.ts`
   - シードデータ: `/backend/prisma/seed.ts`

## 関連エラー
- JWT_SECRET/JWT_REFRESH_SECRETのセキュリティ警告は開発環境では無視可能
- CORS設定は`docker-compose.yml`の`CORS_ORIGIN`環境変数で管理

## 最終更新日
2025年8月26日