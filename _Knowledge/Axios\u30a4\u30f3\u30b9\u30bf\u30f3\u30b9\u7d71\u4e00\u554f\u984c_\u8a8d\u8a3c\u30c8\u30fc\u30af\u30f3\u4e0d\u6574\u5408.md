# Axiosインスタンス統一問題 - 認証トークン不整合

## 問題の概要
複数のAPIファイルで独自のAxiosインスタンスを作成していたため、認証トークンの管理が不統一となり、API呼び出し時に401エラーが発生する問題。

### 症状
- ログイン成功後、ダッシュボードに遷移するが、APIエンドポイントで401エラーが発生
- `/api/auth/me`は成功するが、`/api/v1/analytics/*`系のエンドポイントが失敗
- コンソールログ：
```
[WARN]: HTTPリクエスト処理警告 | Method: GET | URL: /api/v1/analytics/approaches/statistics | Status: 401
[WARN]: HTTPリクエスト処理警告 | Method: GET | URL: /api/v1/analytics/engineers/statistics | Status: 401
[WARN]: HTTPリクエスト処理警告 | Method: GET | URL: /api/v1/notifications/unread-count | Status: 401
```

## 根本原因
**Axiosインスタンスの不統一によるトークン管理の不整合**

### 問題のあったファイル
1. `frontend/src/api/ses/dashboardApi.ts`
   - 独自のAxiosインスタンスを作成
   - `localStorage.getItem('accessToken')`でトークンを取得
   
2. `frontend/src/api/common/notificationApi.ts`
   - 独自のAxiosインスタンスを作成
   - `localStorage.getItem('accessToken')`でトークンを取得

3. `frontend/src/lib/axios.ts`（正しい実装）
   - Zustandストアからトークンを取得
   - `useAuthStore.getState().token`を使用

### なぜ問題が発生したか
- アプリケーションはZustandストア（`auth-storage`キー）でトークンを管理
- 一部のAPIファイルは`localStorage`の`accessToken`キーを参照
- 結果：実際にはトークンが`localStorage`の`accessToken`には保存されていないため、認証ヘッダーが付与されない

## 解決方法

### 1. Axiosインスタンスの統一
すべてのAPIファイルで共通の`lib/axios.ts`インスタンスを使用するように修正。

**修正前（dashboardApi.ts）:**
```typescript
import axios from 'axios';

const apiClient = axios.create({
  baseURL: API_BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
  withCredentials: true,
});

apiClient.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('accessToken'); // 問題箇所
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  }
);
```

**修正後（dashboardApi.ts）:**
```typescript
import axiosInstance from '../../lib/axios';

const API_V1_PATH = '/v1';

// 共通のAxiosインスタンスを使用
const apiClient = {
  get: (path: string) => axiosInstance.get(`${API_V1_PATH}${path}`),
  post: (path: string, data?: any) => axiosInstance.post(`${API_V1_PATH}${path}`, data),
  put: (path: string, data?: any) => axiosInstance.put(`${API_V1_PATH}${path}`, data),
  delete: (path: string) => axiosInstance.delete(`${API_V1_PATH}${path}`),
};
```

### 2. AuthGuardの改善
トークン存在時の認証状態確認フローを修正。

**修正内容:**
```typescript
const [isChecking, setIsChecking] = React.useState(false);
const [hasChecked, setHasChecked] = React.useState(false);

useEffect(() => {
  if (!hasChecked && !isChecking && requireAuth && token) {
    console.log('[AuthGuard] Token exists, checking authentication...');
    setIsChecking(true);
    checkAuth().finally(() => {
      setIsChecking(false);
      setHasChecked(true);
    });
  } else if (!token) {
    setHasChecked(true);
  }
}, [requireAuth, token, checkAuth, hasChecked, isChecking]);
```

### 3. authStore.tsの状態管理
`isAuthenticated`フィールドが正しく永続化されるように修正。

## ベストプラクティス

### 1. Axiosインスタンスの一元管理
- **必須**: プロジェクト全体で単一のAxiosインスタンスを使用
- `lib/axios.ts`からのみインポート
- 独自のAxiosインスタンスを作成しない

### 2. トークン管理の統一
- Zustandストアで一元管理（`useAuthStore`）
- `localStorage`の直接操作を避ける
- インターセプターで自動的にトークンを付与

### 3. APIファイルの作成ルール
```typescript
// 正しい実装例
import axiosInstance from '../../lib/axios';

const API_V1_PATH = '/v1'; // 必要に応じてバージョンパスを定義

const apiClient = {
  get: (path: string) => axiosInstance.get(`${API_V1_PATH}${path}`),
  post: (path: string, data?: any) => axiosInstance.post(`${API_V1_PATH}${path}`, data),
  // ... 他のメソッド
};

export const someAPI = {
  getSomething: async () => {
    const response = await apiClient.get('/something');
    return response.data;
  }
};
```

## チェックリスト（新規APIファイル作成時）

- [ ] `lib/axios.ts`から共通インスタンスをインポートしているか
- [ ] 独自のAxiosインスタンスを作成していないか
- [ ] `localStorage`を直接操作していないか
- [ ] トークン管理をインターセプターに任せているか
- [ ] APIパスの先頭にスラッシュ（`/`）を付けているか

## トラブルシューティング

### 401エラーが発生した場合の確認手順
1. **ブラウザのNetworkタブで確認**
   - Authorizationヘッダーが付いているか確認
   - Bearer tokenが正しく設定されているか

2. **コンソールログで確認**
   ```
   [Axios Interceptor] Adding token to request: Token exists
   [Axios Interceptor] Authorization header set: Bearer eyJ...
   ```

3. **LocalStorageの確認**
   - `auth-storage`キーにトークンが保存されているか
   - `accessToken`キーは使用されていない（空であるべき）

4. **APIファイルの確認**
   - 共通のAxiosインスタンスを使用しているか
   - 独自のインターセプターを定義していないか

## 関連ファイル
- `/frontend/src/lib/axios.ts` - 共通Axiosインスタンス
- `/frontend/src/stores/authStore.ts` - 認証状態管理
- `/frontend/src/api/ses/dashboardApi.ts` - ダッシュボードAPI
- `/frontend/src/api/common/notificationApi.ts` - 通知API
- `/frontend/src/components/guards/AuthGuard.tsx` - 認証ガード

## 関連ナレッジ
- `JWT認証401エラー_Axiosインスタンス不一致問題.md`
- `2025-08-20_ログイン後即リダイレクト問題.md`

## 参考
- 発生日: 2025-08-20
- 解決方法: Axiosインスタンスの統一とトークン管理の一元化
- 影響範囲: すべてのv1系APIエンドポイント

---

**重要**: 新規にAPIファイルを作成する際は、必ずこのナレッジを参照し、共通のAxiosインスタンスを使用すること。独自のAxiosインスタンスを作成すると、同様の認証問題が発生する。